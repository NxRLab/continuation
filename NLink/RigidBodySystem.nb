(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 9.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       157,          7]
NotebookDataLength[    240146,       4709]
NotebookOptionsPosition[    237862,       4628]
NotebookOutlinePosition[    238238,       4644]
CellTagsIndexPosition[    238195,       4641]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[
 RowBox[{"(*", "\n", 
  RowBox[{
   RowBox[{"RigidBodySystem", ".", 
    RowBox[{"nb", ":", " ", 
     RowBox[{"High", "-", 
      RowBox[{
      "level", " ", "functions", " ", "used", " ", "to", " ", "define", " ", 
       "a", " ", "rigid", " ", 
       RowBox[{"body", ".", "\n", "Copyright"}], " ", 
       RowBox[{"(", "C", ")"}], " ", "2014", " ", "Nelson", " ", "Rosa", " ", 
       RowBox[{"Jr", ".", "\n", "\n", "This"}], " ", "program", " ", "is", 
       " ", "free", " ", "software"}]}], ":", " ", 
     RowBox[{"you", " ", "can", " ", "redistribute", " ", "it", " ", 
      RowBox[{"and", "/", "or"}], " ", "modify", "\n", "it", " ", "under", 
      " ", "the", " ", "terms", " ", "of", " ", "the", " ", "GNU", " ", 
      "General", " ", "Public", " ", "License", " ", "as", " ", "published", 
      " ", "by", "\n", 
      RowBox[{"the", " ", "Free", " ", "Software", " ", "Foundation"}]}]}]}], 
   ",", " ", 
   RowBox[{
   "either", " ", "version", " ", "3", " ", "of", " ", "the", " ", 
    "License"}], ",", " ", 
   RowBox[{"or", "\n", 
    RowBox[{"(", 
     RowBox[{"at", " ", "your", " ", "option"}], ")"}], " ", "any", " ", 
    "later", " ", 
    RowBox[{"version", ".", " ", "This"}], " ", "program", " ", "is", " ", 
    "distributed", " ", "in", " ", "the", " ", "\n", "hope", " ", "that", " ",
     "it", " ", "will", " ", "be", " ", "useful"}], ",", " ", 
   RowBox[{
    RowBox[{"but", " ", "WITHOUT", " ", "ANY", " ", "WARRANTY"}], ";", " ", 
    RowBox[{
    "without", " ", "even", " ", "the", " ", "\n", "implied", " ", "warranty",
      " ", "of", " ", "MERCHANTABILITY", " ", "or", " ", "FITNESS", " ", 
     "FOR", " ", "A", " ", "PARTICULAR", " ", 
     RowBox[{"PURPOSE", ".", "\n", "See"}], " ", "the", " ", "GNU", " ", 
     "General", " ", "Public", " ", "License", " ", "for", " ", "more", " ", 
     RowBox[{"details", ".", " ", "You"}], " ", "should", " ", "have", " ", 
     "\n", "received", " ", "a", " ", "copy", " ", "of", " ", "the", " ", 
     "GNU", " ", "General", " ", "Public", " ", "License", " ", "along", " ", 
     "with", " ", "this", " ", 
     RowBox[{"program", ".", "\n", "If"}], " ", "not"}]}], ",", " ", 
   RowBox[{
    RowBox[{"see", " ", "<", 
     RowBox[{"http", ":"}]}], "//", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"www", ".", "gnu", ".", "org"}], "/", "licenses"}], "/"}], ">",
      "."}]}]}], "\n", "*)"}]], "Code",
 InitializationCell->True,
 CellChangeTimes->{{3.6103707836964283`*^9, 3.610370783709448*^9}, {
  3.610370828952024*^9, 3.610370962648698*^9}, {3.6103710877518406`*^9, 
  3.610371111376195*^9}, {3.6103711469392376`*^9, 3.6103712325731497`*^9}, {
  3.610371305900334*^9, 3.610371331708816*^9}, {3.610371368620943*^9, 
  3.61037139802861*^9}, {3.6103714917959795`*^9, 3.6103715279410496`*^9}}],

Cell[CellGroupData[{

Cell["TODO", "Section",
 CellChangeTimes->{{3.5914870039053636`*^9, 3.591487004222381*^9}, {
  3.6033805874918413`*^9, 3.6033805878768606`*^9}}],

Cell["\<\
* fix-up dABA code
* implement dP (e.g., impacts), dPcrb, dPaba, Pcrb, Paba\
\>", "Text",
 CellChangeTimes->{{3.6034338472389097`*^9, 3.6034338506607833`*^9}, {
  3.603434252130316*^9, 3.6034343155991917`*^9}, {3.6034343724118037`*^9, 
  3.6034343854118395`*^9}, {3.603634400289468*^9, 3.6036344006488304`*^9}, {
  3.603673513885831*^9, 3.603673569969036*^9}, {3.603674789962903*^9, 
  3.6036748060248237`*^9}, {3.6108838641585984`*^9, 3.6108838645016356`*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Begin Package", "Section",
 CellChangeTimes->{{3.5914870039053636`*^9, 3.591487004222381*^9}}],

Cell[BoxData[{
 RowBox[{"BeginPackage", "[", "\"\<NLink`\>\"", "]"}], "\n", 
 RowBox[{"Begin", "[", "\"\<`Private`\>\"", "]"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{
  3.5844197483839703`*^9, {3.5844250604318256`*^9, 3.5844250721475377`*^9}, {
   3.5844251233785*^9, 3.5844251234877005`*^9}, {3.5844253988774505`*^9, 
   3.5844254390946617`*^9}, {3.5844254919948354`*^9, 3.5844254990149255`*^9}, 
   3.584425543397398*^9, {3.584425574800518*^9, 3.584425581945394*^9}, {
   3.5844256737523947`*^9, 3.5844257230957055`*^9}, {3.5844279668250203`*^9, 
   3.5844279860756264`*^9}, {3.584428374816189*^9, 3.584428378919037*^9}, {
   3.5914865865694637`*^9, 3.591486626255737*^9}, {3.5914867823906765`*^9, 
   3.5914867827646985`*^9}, {3.591486817520689*^9, 3.5914868205858636`*^9}, {
   3.591486965884186*^9, 3.5914869664642324`*^9}, {3.5915022447717495`*^9, 
   3.5915022459698176`*^9}, {3.591542902441803*^9, 3.591542929051241*^9}, {
   3.59154329988008*^9, 3.591543327692632*^9}, 3.5915439898189273`*^9, {
   3.5915443331789765`*^9, 3.5915443348977413`*^9}, {3.591544409656703*^9, 
   3.591544412687962*^9}, {3.591721260928192*^9, 3.591721326772053*^9}, {
   3.592241768075292*^9, 3.5922417692471714`*^9}, {3.592242084931059*^9, 
   3.5922420876966925`*^9}, 3.5922421309311514`*^9, {3.592255703284815*^9, 
   3.592255706497998*^9}, {3.59225574155902*^9, 3.592255745349224*^9}, {
   3.5922557821253295`*^9, 3.592255815751254*^9}, {3.5922559034172745`*^9, 
   3.5922559113667307`*^9}, {3.5922800860555387`*^9, 3.592280103747531*^9}, {
   3.59275716675933*^9, 3.5927571696474915`*^9}, 3.5927838101231008`*^9, {
   3.5933676479376955`*^9, 3.5933676483126965`*^9}, 3.602872256432743*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Joint Library", "Section",
 CellChangeTimes->{{3.5914870039053636`*^9, 3.591487004222381*^9}, {
  3.5916678891560974`*^9, 3.5916678898031635`*^9}, {3.5922559886651573`*^9, 
  3.5922560027239647`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"joint", "[", "\"\<rx\>\"", "]"}], " ", "=", " ", 
   RowBox[{
    RowBox[{"I6", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
    "&"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"joint", "[", "\"\<ry\>\"", "]"}], " ", "=", " ", 
   RowBox[{
    RowBox[{"I6", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], 
    "&"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"joint", "[", "\"\<rz\>\"", "]"}], " ", "=", " ", 
   RowBox[{
    RowBox[{"I6", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}], 
    "&"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"joint", "[", "\"\<px\>\"", "]"}], " ", "=", " ", 
   RowBox[{
    RowBox[{"I6", "\[LeftDoubleBracket]", "4", "\[RightDoubleBracket]"}], 
    "&"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"joint", "[", "\"\<py\>\"", "]"}], " ", "=", " ", 
   RowBox[{
    RowBox[{"I6", "\[LeftDoubleBracket]", "5", "\[RightDoubleBracket]"}], 
    "&"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"joint", "[", "\"\<pz\>\"", "]"}], " ", "=", " ", 
   RowBox[{
    RowBox[{"I6", "\[LeftDoubleBracket]", "6", "\[RightDoubleBracket]"}], 
    "&"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"joint", "[", "\"\<sph\>\"", "]"}], " ", "=", " ", 
   RowBox[{"{", 
    RowBox[{"\"\<rx\>\"", ",", " ", "\"\<ry\>\"", ",", " ", "\"\<rz\>\""}], 
    "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"joint", "[", "\"\<fb\>\"", "]"}], " ", "=", " ", 
   RowBox[{"{", 
    RowBox[{
    "\"\<px\>\"", ",", " ", "\"\<py\>\"", ",", " ", "\"\<pz\>\"", ",", " ", 
     "\"\<rx\>\"", ",", " ", "\"\<ry\>\"", ",", " ", "\"\<rz\>\""}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"joint", "[", "\"\<pln\>\"", "]"}], " ", "=", " ", 
    RowBox[{"{", 
     RowBox[{"\"\<px\>\"", ",", " ", "\"\<py\>\"", ",", " ", "\"\<rz\>\""}], 
     "}"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"XJ", "[", "\"\<rx\>\"", "]"}], " ", "=", "  ", 
   RowBox[{
    RowBox[{"rotX", "[", "#", "]"}], "&"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"XJ", "[", "\"\<ry\>\"", "]"}], " ", "=", "  ", 
   RowBox[{
    RowBox[{"rotY", "[", "#", "]"}], "&"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"XJ", "[", "\"\<rz\>\"", "]"}], " ", "=", "  ", 
   RowBox[{
    RowBox[{"rotZ", "[", "#", "]"}], "&"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"XJ", "[", "\"\<px\>\"", "]"}], " ", "=", "  ", 
   RowBox[{
    RowBox[{"transX", "[", "#", "]"}], "&"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"XJ", "[", "\"\<py\>\"", "]"}], " ", "=", "  ", 
   RowBox[{
    RowBox[{"transY", "[", "#", "]"}], "&"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"XJ", "[", "\"\<pz\>\"", "]"}], " ", "=", "  ", 
   RowBox[{
    RowBox[{"transZ", "[", "#", "]"}], "&"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{
  3.591667817527995*^9, 3.591668923825349*^9, {3.5916697599352307`*^9, 
   3.591669819815657*^9}, {3.5916698753458366`*^9, 3.5916698888766146`*^9}, {
   3.5916699961457586`*^9, 3.591669997476833*^9}, {3.59167068192603*^9, 
   3.59167070374928*^9}, {3.5917208858180676`*^9, 3.591720889380574*^9}, {
   3.5917221970292563`*^9, 3.591722203732394*^9}, {3.591722238732463*^9, 
   3.591722239091839*^9}, {3.591930526907305*^9, 3.5919305664205675`*^9}, {
   3.5919306118141713`*^9, 3.591930612108184*^9}, 3.591930660729968*^9, {
   3.591930696356006*^9, 3.5919307386704297`*^9}, {3.5919308258974266`*^9, 
   3.5919308840727587`*^9}, {3.591931024599806*^9, 3.591931025034828*^9}, {
   3.591931958433284*^9, 3.5919319593043294`*^9}, {3.5919331117973347`*^9, 
   3.5919331580109777`*^9}, {3.591933250024245*^9, 3.591933252427383*^9}, {
   3.591985667141246*^9, 3.5919857313879256`*^9}, {3.591987361798293*^9, 
   3.591987364276435*^9}, {3.5919978599754896`*^9, 3.59199787152915*^9}, 
   3.5919979113604307`*^9, {3.5919979589681625`*^9, 3.5919979727709627`*^9}, 
   3.5919982080554256`*^9, {3.5920191973504057`*^9, 3.592019234797552*^9}, {
   3.5921518015301204`*^9, 3.592151821661277*^9}, {3.5921518519500084`*^9, 
   3.5921518784545245`*^9}, {3.5921519174737606`*^9, 3.592151918642827*^9}, {
   3.5921519914750166`*^9, 3.5921519924810553`*^9}, 3.5921521161271386`*^9, {
   3.5921521472189164`*^9, 3.592152245920565*^9}, {3.5921524640720634`*^9, 
   3.5921524695633802`*^9}, {3.5921527028097334`*^9, 
   3.5921527107801905`*^9}, {3.59215278839163*^9, 3.592152817779317*^9}, 
   3.5921530282183657`*^9, {3.59215320443246*^9, 3.5921532065185785`*^9}, {
   3.5922519586863747`*^9, 3.592251999186454*^9}, {3.592254165862566*^9, 
   3.5922542064876456`*^9}, {3.5922558428788123`*^9, 
   3.5922558607708282`*^9}, {3.5922558957868533`*^9, 3.592255901201167*^9}, {
   3.592255970324107*^9, 3.592255983444855*^9}, {3.5922563270036964`*^9, 
   3.592256338941219*^9}, {3.592257092435753*^9, 3.592257120589362*^9}, {
   3.5922572679818015`*^9, 3.592257307993095*^9}, {3.5922573544977603`*^9, 
   3.5922573588390207`*^9}, {3.5922584862415714`*^9, 
   3.5922584970631905`*^9}, {3.592272339145876*^9, 3.5922723397079115`*^9}, {
   3.5922724406026893`*^9, 3.5922724506392612`*^9}, {3.5923285065322204`*^9, 
   3.5923285261783457`*^9}, {3.592328588945943*^9, 3.5923285926511564`*^9}, {
   3.592378451717498*^9, 3.592378472565692*^9}, {3.592378552618276*^9, 
   3.5923786444545345`*^9}, {3.5927901083724346`*^9, 
   3.5927901285295887`*^9}, {3.592790375934758*^9, 3.5927903911896305`*^9}, {
   3.6029050158908043`*^9, 3.602905051265873*^9}, {3.6029050867971945`*^9, 
   3.602905088515959*^9}, {3.6029052736712055`*^9, 3.6029053061870675`*^9}, {
   3.6029053433141937`*^9, 3.602905467264292*^9}, {3.602905539448423*^9, 
   3.602905567544038*^9}, {3.602905659932325*^9, 3.6029058527183633`*^9}, {
   3.60290612241781*^9, 3.602906123112848*^9}, {3.602906183483305*^9, 
   3.6029062365393453`*^9}, {3.602906850200717*^9, 3.602906870982005*^9}, {
   3.6029076894679813`*^9, 3.6029076959054956`*^9}, {3.602907726530554*^9, 
   3.6029077404993687`*^9}, {3.6029088725828953`*^9, 3.602908874848522*^9}, {
   3.602908929489254*^9, 3.6029089300673695`*^9}, {3.602942582228842*^9, 
   3.6029425829788327`*^9}, {3.6029443143572187`*^9, 3.602944332263501*^9}, {
   3.602947366050737*^9, 3.6029474042070613`*^9}, {3.6029474515040317`*^9, 
   3.6029474823009605`*^9}, {3.6029475137697754`*^9, 
   3.6029475769574127`*^9}, {3.6029551986974106`*^9, 3.60295520163858*^9}, {
   3.602960739910323*^9, 3.6029608166317167`*^9}, {3.602961202992405*^9, 
   3.602961206928632*^9}, 3.6029614427351346`*^9, {3.6029647395409317`*^9, 
   3.602964756047877*^9}, {3.602966411644685*^9, 3.602966426543538*^9}, {
   3.602973043181452*^9, 3.602973148781497*^9}, {3.6029732736306486`*^9, 
   3.6029732903396063`*^9}, {3.6029734096774397`*^9, 3.602973480168474*^9}, {
   3.6029735749329033`*^9, 3.6029736151752214`*^9}, {3.6029736468760233`*^9, 
   3.602973661417856*^9}, {3.602980199173251*^9, 3.6029802551884584`*^9}, {
   3.6029803097355824`*^9, 3.602980319935164*^9}, {3.602980695640682*^9, 
   3.602980782329646*^9}, {3.6029808292983365`*^9, 3.602980898043277*^9}, {
   3.602980951548337*^9, 3.60298099245968*^9}, {3.602981065342868*^9, 
   3.6029810678259916`*^9}, {3.603299027859565*^9, 3.6032990311067505`*^9}, {
   3.603299072887146*^9, 3.6032990781684465`*^9}, {3.603299150755603*^9, 
   3.603299188582769*^9}, {3.603309528748914*^9, 3.6033095689362125`*^9}, {
   3.6033136064714317`*^9, 3.6033136388592863`*^9}, {3.6033781849172535`*^9, 
   3.60337818553929*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
   "Jacobian", " ", "mapping", " ", "from", " ", "joint", " ", "velocity", 
    " ", "to", " ", "spatial", " ", "velocity"}], " ", "*)"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"s", "[", "x_", "]"}], " ", ":=", " ", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"s", "[", "i", "]"}], "[", "x", "]"}], ",", " ", 
       RowBox[{"{", 
        RowBox[{"i", ",", " ", "nq"}], "}"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"ds", "[", 
      RowBox[{"x_", ",", " ", "dx_"}], "]"}], " ", ":=", " ", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"ds", "[", "i", "]"}], "[", 
        RowBox[{"x", ",", " ", "dx"}], "]"}], ",", " ", 
       RowBox[{"{", 
        RowBox[{"i", ",", " ", "nq"}], "}"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"sdot", "[", "x_", "]"}], " ", ":=", " ", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"sdot", "[", "i", "]"}], "[", "x", "]"}], ",", " ", 
       RowBox[{"{", 
        RowBox[{"i", ",", " ", "nq"}], "}"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"dsdot", "[", 
      RowBox[{"x_", ",", " ", "dx_"}], "]"}], " ", ":=", " ", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"dsdot", "[", "i", "]"}], "[", 
        RowBox[{"x", ",", " ", "dx"}], "]"}], ",", " ", 
       RowBox[{"{", 
        RowBox[{"i", ",", " ", "nq"}], "}"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"s", "[", "i", "]"}], ",", " ", 
     RowBox[{
      RowBox[{
      "where", " ", "i", " ", "is", " ", "an", " ", "integer", " ", "is", " ",
        "defined", " ", "in", " ", 
       RowBox[{"ExpandParameters", "[", "]"}]}], ";", " ", 
      RowBox[{"same", " ", "with", " ", 
       RowBox[{"ds", "[", "i", "]"}]}]}], ",", " ", 
     RowBox[{"etc", "."}]}], " ", "*)"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{
  3.591667817527995*^9, 3.591668923825349*^9, {3.5916697599352307`*^9, 
   3.591669819815657*^9}, {3.5916698753458366`*^9, 3.5916698888766146`*^9}, {
   3.5916699961457586`*^9, 3.591669997476833*^9}, {3.59167068192603*^9, 
   3.59167070374928*^9}, {3.5917208858180676`*^9, 3.591720889380574*^9}, {
   3.5917221970292563`*^9, 3.591722203732394*^9}, {3.591722238732463*^9, 
   3.591722239091839*^9}, {3.591930526907305*^9, 3.5919305664205675`*^9}, {
   3.5919306118141713`*^9, 3.591930612108184*^9}, 3.591930660729968*^9, {
   3.591930696356006*^9, 3.5919307386704297`*^9}, {3.5919308258974266`*^9, 
   3.5919308840727587`*^9}, {3.591931024599806*^9, 3.591931025034828*^9}, {
   3.591931958433284*^9, 3.5919319593043294`*^9}, {3.5919331117973347`*^9, 
   3.5919331580109777`*^9}, {3.591933250024245*^9, 3.591933252427383*^9}, {
   3.591985667141246*^9, 3.5919857313879256`*^9}, {3.591987361798293*^9, 
   3.591987364276435*^9}, {3.5919978599754896`*^9, 3.59199787152915*^9}, 
   3.5919979113604307`*^9, {3.5919979589681625`*^9, 3.5919979727709627`*^9}, 
   3.5919982080554256`*^9, {3.5920191973504057`*^9, 3.592019234797552*^9}, {
   3.5921518015301204`*^9, 3.592151821661277*^9}, {3.5921518519500084`*^9, 
   3.5921518784545245`*^9}, {3.5921519174737606`*^9, 3.592151918642827*^9}, {
   3.5921519914750166`*^9, 3.5921519924810553`*^9}, 3.5921521161271386`*^9, {
   3.5921521472189164`*^9, 3.592152245920565*^9}, {3.5921524640720634`*^9, 
   3.5921524695633802`*^9}, {3.5921527028097334`*^9, 
   3.5921527107801905`*^9}, {3.59215278839163*^9, 3.592152817779317*^9}, 
   3.5921530282183657`*^9, {3.59215320443246*^9, 3.5921532065185785`*^9}, {
   3.5922519586863747`*^9, 3.592251999186454*^9}, {3.592254165862566*^9, 
   3.5922542064876456`*^9}, {3.5922558428788123`*^9, 
   3.5922558607708282`*^9}, {3.5922558957868533`*^9, 3.592255901201167*^9}, {
   3.592255970324107*^9, 3.592255983444855*^9}, {3.5922563270036964`*^9, 
   3.592256338941219*^9}, {3.592257092435753*^9, 3.592257120589362*^9}, {
   3.5922572679818015`*^9, 3.592257307993095*^9}, {3.5922573544977603`*^9, 
   3.5922573588390207`*^9}, {3.5922584862415714`*^9, 
   3.5922584970631905`*^9}, {3.592272339145876*^9, 3.5922723397079115`*^9}, {
   3.5922724406026893`*^9, 3.5922724506392612`*^9}, {3.5923285065322204`*^9, 
   3.5923285261783457`*^9}, {3.592328588945943*^9, 3.5923285926511564`*^9}, {
   3.592378451717498*^9, 3.592378472565692*^9}, {3.592378552618276*^9, 
   3.5923786444545345`*^9}, {3.5927901083724346`*^9, 
   3.5927901285295887`*^9}, {3.592790375934758*^9, 3.5927903911896305`*^9}, {
   3.6029050158908043`*^9, 3.602905051265873*^9}, {3.6029050867971945`*^9, 
   3.602905088515959*^9}, {3.6029052736712055`*^9, 3.6029053061870675`*^9}, {
   3.6029053433141937`*^9, 3.602905467264292*^9}, {3.602905539448423*^9, 
   3.602905567544038*^9}, {3.602905659932325*^9, 3.6029058527183633`*^9}, {
   3.60290612241781*^9, 3.602906123112848*^9}, {3.602906183483305*^9, 
   3.6029062365393453`*^9}, {3.602906850200717*^9, 3.602906870982005*^9}, {
   3.6029076894679813`*^9, 3.6029076959054956`*^9}, {3.602907726530554*^9, 
   3.6029077404993687`*^9}, {3.6029088725828953`*^9, 3.602908874848522*^9}, {
   3.602908929489254*^9, 3.6029089300673695`*^9}, {3.602942582228842*^9, 
   3.6029425829788327`*^9}, {3.6029443143572187`*^9, 3.602944332263501*^9}, {
   3.602947366050737*^9, 3.6029474042070613`*^9}, {3.6029474515040317`*^9, 
   3.6029474823009605`*^9}, {3.6029475137697754`*^9, 
   3.6029475769574127`*^9}, {3.6029551986974106`*^9, 3.60295520163858*^9}, {
   3.602960739910323*^9, 3.6029608166317167`*^9}, {3.602961202992405*^9, 
   3.602961206928632*^9}, 3.6029614427351346`*^9, {3.6029647395409317`*^9, 
   3.602964756047877*^9}, {3.602966411644685*^9, 3.602966426543538*^9}, {
   3.602973043181452*^9, 3.602973148781497*^9}, {3.6029732736306486`*^9, 
   3.6029732903396063`*^9}, {3.6029734096774397`*^9, 3.602973480168474*^9}, {
   3.6029735749329033`*^9, 3.6029736151752214`*^9}, {3.6029736468760233`*^9, 
   3.6029736730335226`*^9}, 3.602973762328635*^9, {3.6029743025445714`*^9, 
   3.602974303181615*^9}, {3.602974365516178*^9, 3.602974428553787*^9}, {
   3.603245546541565*^9, 3.6032455730540733`*^9}, {3.6032456334665327`*^9, 
   3.6032456647493243`*^9}, 3.603321440057479*^9, {3.603321492715494*^9, 
   3.603321515888823*^9}, {3.603321689830779*^9, 3.6033217036715746`*^9}, {
   3.603321754141461*^9, 3.603321768341279*^9}, {3.603321804912373*^9, 
   3.6033218198972282`*^9}, {3.603321982577547*^9, 3.603322012111238*^9}, {
   3.603420992568698*^9, 3.6034210004671364`*^9}, {3.603421045755731*^9, 
   3.603421049844962*^9}, {3.603425158614411*^9, 3.6034251855309515`*^9}, {
   3.62074956752324*^9, 3.6207496280389805`*^9}, {3.621956412430313*^9, 
   3.6219564544772353`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"AddJoint", "[", 
    RowBox[{"type_", ",", " ", "s_", ",", " ", 
     RowBox[{"xj_:", "None"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{
      RowBox[{"joint", "[", "type", "]"}], " ", "=", " ", "s"}], ";", " ", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"xj", " ", "=!=", " ", "None"}], ",", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"XJ", "[", "type", "]"}], " ", "=", " ", "xj"}], ";"}]}], 
      "]"}]}], ")"}]}], ";"}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.60337819653992*^9, 3.603378204749403*^9}, {
   3.6034937290383005`*^9, 3.603493733710182*^9}, {3.6034945191850634`*^9, 
   3.603494528594597*^9}, {3.6034946223609705`*^9, 3.6034946574169927`*^9}, {
   3.603500390379819*^9, 3.603500988130991*^9}, {3.603501107053095*^9, 
   3.603501107506222*^9}, {3.6035011403656607`*^9, 3.603501597554055*^9}, {
   3.6035017377730794`*^9, 3.603501751085621*^9}, {3.6035019541485023`*^9, 
   3.603501956789135*^9}, {3.6035038075896397`*^9, 3.603503840870942*^9}, {
   3.6035039096523266`*^9, 3.6035039385742598`*^9}, 3.6035041762622223`*^9, {
   3.603504315528119*^9, 3.603504316981247*^9}, {3.603504750075845*^9, 
   3.6035047548414783`*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Constraints", "Section",
 CellChangeTimes->{{3.5914870039053636`*^9, 3.591487004222381*^9}, {
  3.5916678891560974`*^9, 3.5916678898031635`*^9}, {3.5922559886651573`*^9, 
  3.5922560027239647`*^9}, {3.603378158142721*^9, 3.6033781613209057`*^9}, {
  3.603504757810238*^9, 3.603504759200862*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"constraint", "[", "\"\<none\>\"", "]"}], " ", "=", " ", 
    RowBox[{"{", 
     RowBox[{"0", " ", 
      RowBox[{"(*", " ", "b", " ", "*)"}], ",", 
      RowBox[{"z6", " ", 
       RowBox[{"(*", " ", "r", " ", "*)"}], "&"}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"AddConstraint", "::", "args"}], " ", "=", " ", 
    "\"\<There are an odd number of constraints for `1`.  Constraints must \
come in pairs: b1, r1,...,bi, ri.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"AddConstraint", "::", "r"}], " ", "=", " ", 
    "\"\<For `1`, the r in argument `2` must return a `3`-D vector that maps \
a `3`-D spatial vector to a scalar in operational space.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"AddConstraint", "::", "bod"}], " ", "=", " ", 
    "\"\<For `1`, argument `2` must be a valid body number.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"AddConstraint", "[", 
    RowBox[{"type_", ",", " ", "x__"}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "args", ",", " ", "bcons", ",", " ", "rcons", ",", " ", "b", ",", " ", 
       "r"}], "}"}], ",", " ", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"args", " ", "=", " ", 
       RowBox[{"{", "x", "}"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"is", " ", "type", " ", "a", " ", "set", " ", "of", " ", 
        RowBox[{"constraints", "?"}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"VectorQ", "[", 
         RowBox[{
          RowBox[{
          "args", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], ",",
           " ", "StringQ"}], "]"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"constraint", "[", "type", "]"}], " ", "=", " ", 
          RowBox[{
          "args", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}], 
         ";", "\[IndentingNewLine]", 
         RowBox[{"Return", "[", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}], 
      ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"does", " ", "x", " ", "come", " ", "in", " ", 
        RowBox[{"(", 
         RowBox[{"b", ",", " ", "r"}], ")"}], " ", 
        RowBox[{"pairs", "?"}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"OddQ", "[", 
         RowBox[{"Length", "[", "args", "]"}], "]"}], ",", " ", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{
           RowBox[{"AddConstraint", "::", "args"}], ",", " ", "type"}], "]"}],
          ";", "\[IndentingNewLine]", 
         RowBox[{"Return", "[", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}], 
      ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"extract", " ", "all", " ", "arguments"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"bcons", " ", "=", " ", 
       RowBox[{"args", "\[LeftDoubleBracket]", 
        RowBox[{"1", ";;", ";;", "2"}], "\[RightDoubleBracket]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"rcons", " ", "=", " ", 
       RowBox[{"args", "\[LeftDoubleBracket]", 
        RowBox[{"2", ";;", ";;", "2"}], "\[RightDoubleBracket]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"check", " ", "for", " ", "bad", " ", "inputs"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"args", " ", "=", " ", "True"}], ";", "\[IndentingNewLine]", 
      RowBox[{"Do", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"b", " ", "=", " ", 
          RowBox[{
          "bcons", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}], 
         ";", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{"are", " ", "the", " ", "body", " ", "#", "s", " ", 
           RowBox[{"valid", "?"}]}], " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"!", 
             RowBox[{"IntegerQ", "[", "b", "]"}]}], " ", "||", " ", 
            RowBox[{"b", " ", "\[LessEqual]", " ", "0"}]}], ",", " ", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Message", "[", 
             RowBox[{
              RowBox[{"AddConstraint", "::", "bod"}], ",", " ", "type", ",", 
              " ", 
              RowBox[{"2", "i"}]}], "]"}], ";", "\[IndentingNewLine]", 
            RowBox[{"args", " ", "=", " ", "False"}], ";"}]}], 
          "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"r", " ", "=", " ", 
          RowBox[{
           RowBox[{
           "rcons", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
           "[", 
           RowBox[{"0", ",", " ", "0"}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
          "did", " ", "r", " ", "evaluate", " ", "to", " ", "a", " ", 
           "spatial", " ", 
           RowBox[{"vector", "?"}]}], " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"!", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"VectorQ", "[", "r", "]"}], " ", "&&", " ", 
              RowBox[{
               RowBox[{"Length", "[", "r", "]"}], " ", "\[Equal]", " ", 
               "nm"}]}], ")"}]}], ",", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Message", "[", 
             RowBox[{
              RowBox[{"AddConstraint", "::", "r"}], ",", " ", "type", ",", 
              " ", 
              RowBox[{
               RowBox[{"2", "i"}], "+", "1"}], ",", " ", "nm"}], "]"}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"args", " ", "=", " ", "False"}], ";"}]}], 
          "\[IndentingNewLine]", "]"}], ";"}], ",", " ", 
        "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{"i", ",", " ", 
          RowBox[{"Length", "[", "bcons", "]"}]}], "}"}]}], 
       "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "if", " ", "no", " ", "errors", " ", "add", " ", "constraint", " ", 
        "type"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{"args", ",", " ", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"constraint", "[", "type", "]"}], " ", "=", " ", 
         RowBox[{"{", 
          RowBox[{"bcons", ",", " ", "rcons"}], "}"}]}]}], 
       "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.60337819653992*^9, 3.603378204749403*^9}, {
   3.6034937290383005`*^9, 3.603493733710182*^9}, {3.6034945191850634`*^9, 
   3.603494528594597*^9}, {3.6034946223609705`*^9, 3.6034946574169927`*^9}, {
   3.603500390379819*^9, 3.603500988130991*^9}, {3.603501107053095*^9, 
   3.603501107506222*^9}, {3.6035011403656607`*^9, 3.603501597554055*^9}, {
   3.6035017377730794`*^9, 3.603501751085621*^9}, {3.6035019541485023`*^9, 
   3.603501956789135*^9}, {3.6035038075896397`*^9, 3.603503840870942*^9}, {
   3.6035039096523266`*^9, 3.6035039385742598`*^9}, 3.6035041762622223`*^9, {
   3.603504315528119*^9, 3.603504316981247*^9}, {3.6035047632477484`*^9, 
   3.603504773247768*^9}, {3.6035048391853943`*^9, 3.6035048555604277`*^9}, {
   3.603504925779313*^9, 3.6035050144357367`*^9}, 3.6035051105765653`*^9, 
   3.6035051409359846`*^9, {3.603505247951818*^9, 3.603505267592482*^9}, {
   3.6035053671239257`*^9, 3.603505367452052*^9}, {3.60350542003028*^9, 
   3.6035054527490935`*^9}, {3.603505495249176*^9, 3.6035055318586226`*^9}, {
   3.6035055708899517`*^9, 3.603505571452464*^9}, {3.6035056280619392`*^9, 
   3.6035056604369993`*^9}, {3.603505696874571*^9, 3.6035056974839478`*^9}, {
   3.6035059461250596`*^9, 3.6035059659844713`*^9}, {3.603507877503838*^9, 
   3.6035079249570537`*^9}, {3.6035147247696905`*^9, 
   3.6035147621447625`*^9}, {3.6035148021604867`*^9, 
   3.6035148804106216`*^9}, {3.603514970770173*^9, 3.6035150173327637`*^9}, {
   3.6035151353486347`*^9, 3.6035151770987015`*^9}, {3.603515366145949*^9, 
   3.6035153715053444`*^9}, {3.603515434067973*^9, 3.603515455192997*^9}, {
   3.6035155427869167`*^9, 3.6035155554744544`*^9}, {3.603515613974569*^9, 
   3.603515689537216*^9}, {3.603515769193609*^9, 3.6035157903030214`*^9}, {
   3.603515856209405*^9, 3.603515931147053*^9}, {3.6035159859127827`*^9, 
   3.6035159870534105`*^9}, {3.603516023772232*^9, 3.6035160644129353`*^9}, {
   3.6035520177391887`*^9, 3.6035520390517273`*^9}, 3.6035520877549477`*^9, {
   3.603552122020639*^9, 3.603552161645717*^9}, {3.6035599130919476`*^9, 
   3.6035599761076946`*^9}, {3.6035600313890495`*^9, 3.603560065310989*^9}, {
   3.603560140904888*^9, 3.6035602170769153`*^9}, {3.603560259905125*^9, 
   3.603560361467822*^9}, {3.60356039226476*^9, 3.603560417499177*^9}, {
   3.60356051334312*^9, 3.603560521671259*^9}, {3.6035606086558065`*^9, 
   3.603560612499583*^9}, {3.603560670999693*^9, 3.6035606868747067`*^9}, {
   3.6035607263122897`*^9, 3.60356081298433*^9}, {3.60356085935942*^9, 
   3.603560971906517*^9}, {3.603561017031601*^9, 3.6035610187816067`*^9}, {
   3.6035610505629187`*^9, 3.6035610754223433`*^9}, {3.6035611453443565`*^9, 
   3.603561168281898*^9}, {3.6035612544851933`*^9, 3.603561330313466*^9}, {
   3.603561470235615*^9, 3.6035616046890035`*^9}, {3.603561676079769*^9, 
   3.6035617754549627`*^9}, {3.6035618835332975`*^9, 3.603561933080271*^9}, {
   3.6035619698615923`*^9, 3.603562057611765*^9}, {3.6035620927055826`*^9, 
   3.6035621858307652`*^9}, {3.6035622165183306`*^9, 3.603562310018509*^9}, {
   3.6035623949561744`*^9, 3.603562404784318*^9}, {3.603562506206391*^9, 
   3.603562594269063*^9}, {3.603562780941304*^9, 3.6035628441758018`*^9}, {
   3.6035629201603403`*^9, 3.60356294247287*^9}, {3.6035630148480115`*^9, 
   3.6035630168167653`*^9}, {3.6035630770043826`*^9, 3.603563078598136*^9}, {
   3.603563148645152*^9, 3.603563171426442*^9}, {3.6035634218019323`*^9, 
   3.603563423676936*^9}, {3.6035634852239313`*^9, 3.60356348714581*^9}, {
   3.6035635253333845`*^9, 3.6035635257865057`*^9}, {3.6035637808182597`*^9, 
   3.6035638196777105`*^9}, {3.603564001631216*^9, 3.6035640215843544`*^9}, {
   3.60356418842844*^9, 3.603564202584708*^9}, {3.6035643401474776`*^9, 
   3.6035643646631513`*^9}, {3.6035658433691683`*^9, 
   3.6035658956661634`*^9}, {3.6035659334943438`*^9, 
   3.6035659403693576`*^9}, {3.603567732919738*^9, 3.6035678021386228`*^9}, 
   3.6035782735154257`*^9, 3.603578356406213*^9, {3.6035784008125467`*^9, 
   3.60357844614076*^9}, {3.6035784866408377`*^9, 3.6035785706410055`*^9}, {
   3.6035786074692*^9, 3.603578610969205*^9}, 3.603578686281855*^9, {
   3.603578764672632*^9, 3.603578802032081*^9}, 3.603578885141619*^9, {
   3.603578957594884*^9, 3.6035789632042713`*^9}, {3.6035790112043657`*^9, 
   3.6035790344856653`*^9}, {3.603579070985732*^9, 3.6035791946890993`*^9}, {
   3.603579237892309*^9, 3.603579239736062*^9}, {3.6035793819863396`*^9, 
   3.6035795949086313`*^9}, {3.603579859331024*^9, 3.6035798693466687`*^9}, {
   3.6036503833004136`*^9, 3.603650411819047*^9}, {3.6048634661846304`*^9, 
   3.60486346659088*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
   "Jacobian", " ", "mapping", " ", "from", " ", "spatial", " ", "velocity", 
    " ", "to", " ", "os", " ", "velocity"}], " ", "*)"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"r", "[", "x_", "]"}], " ", ":=", " ", 
     RowBox[{"PadRight", "[", 
      RowBox[{
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"Through", "[", 
          RowBox[{
           RowBox[{"r", "[", "i", "]"}], "[", "x", "]"}], "]"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", "mb"}], "}"}]}], "]"}], ",", " ", 
       RowBox[{"{", 
        RowBox[{"mb", ",", " ", 
         RowBox[{"Max", "[", "bl", "]"}], ",", " ", "nm"}], "}"}]}], "]"}]}], 
    ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"dr", "[", 
      RowBox[{"x_", ",", " ", "dx_"}], "]"}], " ", ":=", " ", 
     RowBox[{"PadRight", "[", 
      RowBox[{
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"Through", "[", 
          RowBox[{
           RowBox[{"dr", "[", "i", "]"}], "[", 
           RowBox[{"x", ",", " ", "dx"}], "]"}], "]"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", "mb"}], "}"}]}], "]"}], ",", " ", 
       RowBox[{"{", 
        RowBox[{"mb", ",", " ", 
         RowBox[{"Max", "[", "bl", "]"}], ",", " ", "nm", ",", " ", "nd"}], 
        "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"rdot", "[", "x_", "]"}], " ", ":=", " ", 
     RowBox[{"PadRight", "[", 
      RowBox[{
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"Through", "[", 
          RowBox[{
           RowBox[{"rdot", "[", "i", "]"}], "[", "x", "]"}], "]"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", "mb"}], "}"}]}], "]"}], ",", " ", 
       RowBox[{"{", 
        RowBox[{"mb", ",", " ", 
         RowBox[{"Max", "[", "bl", "]"}], ",", " ", "nm"}], "}"}]}], "]"}]}], 
    ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"drdot", "[", 
      RowBox[{"x_", ",", " ", "dx_"}], "]"}], " ", ":=", " ", 
     RowBox[{"PadRight", "[", 
      RowBox[{
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"Through", "[", 
          RowBox[{
           RowBox[{"drdot", "[", "i", "]"}], "[", 
           RowBox[{"x", ",", " ", "dx"}], "]"}], "]"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", "mb"}], "}"}]}], "]"}], ",", " ", 
       RowBox[{"{", 
        RowBox[{"mb", ",", " ", 
         RowBox[{"Max", "[", "bl", "]"}], ",", " ", "nm", ",", " ", "nd"}], 
        "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"r", "[", "i", "]"}], ",", " ", 
     RowBox[{
      RowBox[{
      "where", " ", "i", " ", "is", " ", "an", " ", "integer", " ", "is", " ",
        "defined", " ", "in", " ", 
       RowBox[{"ExpandConstraints", "[", "]"}]}], ";", " ", 
      RowBox[{"same", " ", "with", " ", 
       RowBox[{
        RowBox[{"dr", "[", "i", "]"}], "."}]}]}]}], " ", "*)"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.6035175653221345`*^9, 3.603517604681589*^9}, {
  3.603517656087937*^9, 3.6035176747910852`*^9}, {3.60357434760832*^9, 
  3.60357438221776*^9}, {3.603577675599963*^9, 3.603577679068721*^9}, {
  3.60357885653222*^9, 3.6035788655165834`*^9}, {3.603582733274146*^9, 
  3.603582735571023*^9}, {3.6035966706824703`*^9, 3.6035966803030186`*^9}, {
  3.6047654938386717`*^9, 3.6047655385152273`*^9}, {3.6051489233562346`*^9, 
  3.605148948918784*^9}, {3.605149013981412*^9, 3.605149024762698*^9}, {
  3.60514906149713*^9, 3.605149095559701*^9}, {3.6051491420754137`*^9, 
  3.605149150247303*^9}, {3.6152091582911005`*^9, 3.6152091583067255`*^9}, {
  3.620749676679737*^9, 3.6207497406485786`*^9}, {3.621956547961828*^9, 
  3.6219565954306707`*^9}, {3.621956666852685*^9, 3.6219566675401516`*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Spatial Vector Transformations", "Section",
 CellChangeTimes->{{3.5914870039053636`*^9, 3.591487004222381*^9}, {
  3.5916678891560974`*^9, 3.5916678898031635`*^9}, {3.5922559886651573`*^9, 
  3.5922560027239647`*^9}, {3.5927607764450436`*^9, 3.5927607827644053`*^9}, {
  3.5933114168848066`*^9, 3.593311420744175*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{"parent", " ", "to", " ", "child", " ", "transform"}], " ", "*)"}],
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"Xip", "[", "x_", "]"}], " ", ":=", " ", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Xip", "[", "i", "]"}], "[", "x", "]"}], ",", " ", 
       RowBox[{"{", 
        RowBox[{"i", ",", " ", "nq"}], "}"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"dXip", "[", 
      RowBox[{"x_", ",", " ", "dx_"}], "]"}], " ", ":=", " ", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"dXip", "[", "i", "]"}], "[", 
        RowBox[{"x", ",", " ", "dx"}], "]"}], ",", " ", 
       RowBox[{"{", 
        RowBox[{"i", ",", " ", "nq"}], "}"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Xdotip", "[", "x_", "]"}], " ", ":=", " ", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Xdotip", "[", "i", "]"}], "[", "x", "]"}], ",", " ", 
       RowBox[{"{", 
        RowBox[{"i", ",", " ", "nq"}], "}"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"dXdotip", "[", 
      RowBox[{"x_", ",", " ", "dx_"}], "]"}], " ", ":=", " ", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"dXdotip", "[", "i", "]"}], "[", 
        RowBox[{"x", ",", " ", "dx"}], "]"}], ",", " ", 
       RowBox[{"{", 
        RowBox[{"i", ",", " ", "nq"}], "}"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"Xip", "[", "i", "]"}], ",", " ", 
     RowBox[{
      RowBox[{
      "where", " ", "i", " ", "is", " ", "an", " ", "integer", " ", "is", " ",
        "defined", " ", "in", " ", 
       RowBox[{"ExpandParameters", "[", "]"}]}], ";", " ", 
      RowBox[{"same", " ", "with", " ", 
       RowBox[{
        RowBox[{"dXip", "[", "i", "]"}], "."}]}]}]}], " ", 
    "*)"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.603322093480898*^9, 3.6033221566545153`*^9}, {
  3.6047657510784025`*^9, 3.604765761395013*^9}, {3.6207497620392785`*^9, 
  3.620749800023731*^9}, {3.621956714555869*^9, 3.6219567669935055`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
    "puts", " ", "all", " ", "body", " ", "spatial", " ", "vectors", " ", 
     "in", " ", "a", " ", "common", " ", "frame"}], ",", " ", 
    RowBox[{
    "where", " ", "fr", " ", "is", " ", "the", " ", "frame", " ", 
     "associated", " ", "with", " ", "body", " ", 
     RowBox[{"i", ".", "  ", "Optionally"}]}], ",", " ", 
    RowBox[{
    "a", " ", "transformation", " ", "X", " ", "can", " ", "be", " ", 
     "applied", " ", 
     RowBox[{"afterwards", "."}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"Jcoord", "[", 
     RowBox[{"q_", ",", " ", "fr_", ",", " ", 
      RowBox[{"X_:", "I6"}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "p", ",", " ", "sJ", ",", " ", "J", ",", " ", "XL", ",", " ", "X0", 
        ",", " ", "Xfr"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"J", " ", "=", " ", "Zspat"}], ";", "\[IndentingNewLine]", 
       RowBox[{"EvaluateFunctions", "[", "q", "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"X0", " ", "=", " ", "XL"}], ";", "\[IndentingNewLine]", 
       RowBox[{"Do", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"p", " ", "=", " ", 
           RowBox[{
           "parent", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}],
           ";", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"p", " ", "\[NotEqual]", " ", "0"}], ",", " ", 
            RowBox[{
             RowBox[{
             "X0", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
             " ", "=", " ", 
             RowBox[{
              RowBox[{
              "XL", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
              ".", 
              RowBox[{
              "X0", "\[LeftDoubleBracket]", "p", 
               "\[RightDoubleBracket]"}]}]}]}], "]"}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
           "J", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], " ", 
           "=", " ", 
           RowBox[{
            RowBox[{"InvXba", "[", 
             RowBox[{
             "X0", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
             "]"}], ".", 
            RowBox[{
            "sJ", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}]}], 
          ";"}], "\[IndentingNewLine]", ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", "nq"}], "}"}]}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"Xfr", " ", "=", " ", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"fr", " ", "\[NotEqual]", " ", "0"}], ",", " ", 
          RowBox[{
          "X0", "\[LeftDoubleBracket]", "fr", "\[RightDoubleBracket]"}], ",", 
          "I6"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Xfr", " ", "=", " ", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"VectorQ", "[", "X", "]"}], ",", " ", 
           RowBox[{"Xba", "[", "X", "]"}], ",", " ", "X"}], "]"}], ".", 
         "Xfr"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Xfr", ".", 
        RowBox[{"J", "\[Transpose]"}]}]}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.592760784808523*^9, 3.5927608324382477`*^9}, {
   3.592760878606894*^9, 3.592760898519035*^9}, {3.5927609330070095`*^9, 
   3.5927609406134453`*^9}, {3.592766529164482*^9, 3.5927665579241295`*^9}, {
   3.5927682348361607`*^9, 3.5927682531012063`*^9}, {3.5927686522540607`*^9, 
   3.592768659061454*^9}, {3.592768729429488*^9, 3.5927687465334625`*^9}, {
   3.59276979423946*^9, 3.592769839110031*^9}, {3.5927698693577633`*^9, 
   3.592769938348716*^9}, {3.5927701076534095`*^9, 3.5927701098455353`*^9}, {
   3.592770260293149*^9, 3.592770268268612*^9}, {3.5927703142292395`*^9, 
   3.5927703156843233`*^9}, {3.592770382294149*^9, 3.5927704932134895`*^9}, {
   3.59277057667127*^9, 3.592770624463006*^9}, {3.592770725399786*^9, 
   3.5927707436078253`*^9}, {3.5927708834468355`*^9, 
   3.5927710671673574`*^9}, {3.592771115960148*^9, 3.5927711428946953`*^9}, {
   3.59277121546385*^9, 3.5927712317987895`*^9}, {3.5927712903521366`*^9, 
   3.5927714878474483`*^9}, {3.5927715218253946`*^9, 
   3.5927716903440633`*^9}, {3.592771744638154*^9, 3.592771808928832*^9}, {
   3.5927718583536663`*^9, 3.5927718926686325`*^9}, {3.592771953905138*^9, 
   3.592771969039005*^9}, {3.5927725839822206`*^9, 3.5927725929257307`*^9}, {
   3.5927730784815392`*^9, 3.592773078878561*^9}, {3.5927732726666584`*^9, 
   3.5927733236765795`*^9}, {3.5927734103485394`*^9, 3.592773412926691*^9}, {
   3.5927736412547674`*^9, 3.592773643358886*^9}, {3.592773801937967*^9, 
   3.5927738025860057`*^9}, {3.5927740306490664`*^9, 3.592774079640867*^9}, {
   3.5927750254350348`*^9, 3.5927750281381893`*^9}, {3.592777833891865*^9, 
   3.59277783901816*^9}, {3.592783957812561*^9, 3.5927839578995657`*^9}, {
   3.5927870246928425`*^9, 3.5927870250518675`*^9}, {3.592787292671186*^9, 
   3.5927873057159476`*^9}, {3.592790214908536*^9, 3.592790217002653*^9}, {
   3.5927903999641466`*^9, 3.5927904012272067`*^9}, {3.592995460850711*^9, 
   3.592995495397651*^9}, {3.5929960346174555`*^9, 3.592996038476839*^9}, {
   3.5929961196332474`*^9, 3.5929961478989267`*^9}, {3.5929961936802654`*^9, 
   3.5929962434147387`*^9}, {3.5931325883082275`*^9, 
   3.5931326315270615`*^9}, {3.5931326715427656`*^9, 3.593132710511591*^9}, {
   3.593132749871039*^9, 3.5931327614960656`*^9}, {3.593132826074318*^9, 
   3.5931328523087435`*^9}, {3.593133979896178*^9, 3.593134048286936*^9}, 
   3.593134833725971*^9, {3.5931349307261624`*^9, 3.5931349651637278`*^9}, {
   3.5931350390857477`*^9, 3.593135047851391*^9}, {3.593135773587183*^9, 
   3.5931358311497974`*^9}, {3.5931358627592344`*^9, 
   3.5931358800248938`*^9}, {3.5931360458533382`*^9, 
   3.5931360997284484`*^9}, {3.593136139291025*^9, 3.5931361586973133`*^9}, {
   3.5931362017911477`*^9, 3.5931362034630256`*^9}, {3.593136250244363*^9, 
   3.593136259900636*^9}, {3.59313635097894*^9, 3.593136364666479*^9}, {
   3.5931365562762156`*^9, 3.5931365564637165`*^9}, 3.593136602635681*^9, {
   3.5931366493701477`*^9, 3.5931366540420322`*^9}, {3.593136984855179*^9, 
   3.5931369977770777`*^9}, {3.5931370621990795`*^9, 3.593137087183503*^9}, {
   3.593137151714882*^9, 3.5931371665117836`*^9}, {3.593137279527629*^9, 
   3.593137328996477*^9}, {3.5931373949966063`*^9, 3.593137395277856*^9}, {
   3.593137802872402*^9, 3.5931378732162905`*^9}, {3.593137950466442*^9, 
   3.5931379552789493`*^9}, 3.593137988122766*^9, 3.593138103263616*^9, {
   3.5931381489512053`*^9, 3.5931381559199677`*^9}, {3.593138197201305*^9, 
   3.59313821360758*^9}, {3.5931384066079597`*^9, 3.5931384404205256`*^9}, {
   3.59313847838935*^9, 3.5931384787956004`*^9}, {3.5931392106564074`*^9, 
   3.593139210718907*^9}, {3.593141882053808*^9, 3.5931418852569375`*^9}, {
   3.593142085413581*^9, 3.5931420890385876`*^9}, {3.593194639815832*^9, 
   3.5931946400814686`*^9}, {3.593194692597185*^9, 3.593194695534686*^9}, 
   3.59319504037912*^9, {3.5931951305980396`*^9, 3.593195145269945*^9}, {
   3.593195180676261*^9, 3.5931952042075586`*^9}, {3.5931955700207744`*^9, 
   3.5931955711614013`*^9}, {3.593195949271521*^9, 3.593196057740488*^9}, {
   3.5931962478658695`*^9, 3.5931962622877517`*^9}, {3.5931964707881603`*^9, 
   3.593196540178919*^9}, {3.593196578413391*^9, 3.5931966391791296`*^9}, {
   3.593196719085543*^9, 3.5931967236167793`*^9}, {3.593196907476515*^9, 
   3.5931969106171417`*^9}, {3.593196978976653*^9, 3.59319700141422*^9}, {
   3.593197086164364*^9, 3.593197088695617*^9}, 3.593197444368188*^9, {
   3.593297477246256*^9, 3.593297502636914*^9}, 3.5932976188402677`*^9, {
   3.5932976652153597`*^9, 3.5932976903560343`*^9}, {3.59329813829441*^9, 
   3.593298233763345*^9}, {3.593298263763405*^9, 3.5932982760915556`*^9}, {
   3.5932984218105903`*^9, 3.5932984384824934`*^9}, {3.5932985106857634`*^9, 
   3.593298531967055*^9}, {3.593299352828043*^9, 3.593299387703105*^9}, {
   3.593300968471818*^9, 3.593300979049966*^9}, {3.5933112546344757`*^9, 
   3.5933113058689504`*^9}, {3.5933113612128115`*^9, 3.5933114017128906`*^9}, 
   3.593316537444393*^9, {3.6027030542765026`*^9, 3.6027031907393165`*^9}, {
   3.602703404912594*^9, 3.602703476944707*^9}, 3.6027035272805915`*^9, {
   3.602961077828238*^9, 3.6029611012405787`*^9}, 3.6029737150269265`*^9, 
   3.603199119215062*^9, {3.620750731634892*^9, 3.620750741478696*^9}, {
   3.6209940015644608`*^9, 3.6209940087519503`*^9}, {3.6219568898687115`*^9, 
   3.6219568941655965`*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Spatial Inertia", "Section",
 CellChangeTimes->{{3.5914870039053636`*^9, 3.591487004222381*^9}, {
  3.5916678891560974`*^9, 3.5916678898031635`*^9}, {3.5922559886651573`*^9, 
  3.5922560027239647`*^9}, {3.5927607764450436`*^9, 3.5927607827644053`*^9}, {
  3.5933114168848066`*^9, 3.593311420744175*^9}, {3.615320113664044*^9, 
  3.6153201146171727`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"AddInertia", "[", "\[DoubleStruckCapitalI]c_", "]"}], " ", ":=", 
   " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"m", ",", " ", "Icom", ",", " ", "pos", ",", " ", "SpatIns"}], 
      "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "is", " ", "\[DoubleStruckCapitalI]c", " ", "a", " ", "list", " ", "of",
        " ", "parameters", " ", "or", " ", "a", " ", "list", " ", "of", " ", 
       RowBox[{"lists", "?"}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"SpatIns", " ", "=", " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"VectorQ", "[", "\[DoubleStruckCapitalI]c", "]"}], ",", " ", 
         RowBox[{"{", "\[DoubleStruckCapitalI]c", "}"}], ",", " ", 
         "\[DoubleStruckCapitalI]c"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "add", " ", "the", " ", "spatial", " ", "inertias", " ", "of", " ", 
        "current", " ", "link"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"Plus", "@@", 
       RowBox[{"Table", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"m", " ", "=", " ", 
           RowBox[{
           "si", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{"pos", " ", "=", " ", 
           RowBox[{"si", "\[LeftDoubleBracket]", 
            RowBox[{"2", ";;", "7"}], "\[RightDoubleBracket]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Length", "[", "si", "]"}], " ", "\[Equal]", " ", "10"}],
             ",", " ", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"Icom", " ", "=", " ", 
              RowBox[{"DiagonalMatrix", "[", 
               RowBox[{"si", "\[LeftDoubleBracket]", 
                RowBox[{"8", ";;", "10"}], "\[RightDoubleBracket]"}], "]"}]}],
              ";"}], ",", " ", "\[IndentingNewLine]", 
            RowBox[{"(*", " ", "else", " ", "*)"}], "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"Icom", " ", "=", " ", 
              RowBox[{"Partition", "[", 
               RowBox[{
                RowBox[{"si", "\[LeftDoubleBracket]", 
                 RowBox[{"8", ";;", "16"}], "\[RightDoubleBracket]"}], ",", 
                " ", "3"}], "]"}]}], ";"}]}], "\[IndentingNewLine]", "]"}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{"Io", "[", 
           RowBox[{"m", ",", " ", "pos", ",", " ", "Icom"}], "]"}]}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"si", ",", " ", "SpatIns"}], "}"}]}], "\[IndentingNewLine]",
         "]"}]}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.615319907890235*^9, 3.615320003562295*^9}, {
  3.6153201335390835`*^9, 3.6153201342890816`*^9}, {3.615321234525612*^9, 
  3.615321256806917*^9}, {3.6159903572402115`*^9, 3.615990381376594*^9}, {
  3.6159904368567715`*^9, 3.6159904690506124`*^9}, {3.6159905399586735`*^9, 
  3.6159907552950087`*^9}, {3.6159908277761583`*^9, 3.6159910914622774`*^9}, {
  3.615991157932065*^9, 3.6159911861316805`*^9}, {3.615991239460734*^9, 
  3.615991311609866*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"\[DoubleStruckCapitalI]", "[", "x_", "]"}], " ", ":=", " ", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"\[DoubleStruckCapitalI]", "[", "i", "]"}], "[", "x", "]"}], 
     ",", " ", 
     RowBox[{"{", 
      RowBox[{"i", ",", " ", "nq"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"d\[DoubleStruckCapitalI]", "[", 
     RowBox[{"x_", ",", " ", "dx_"}], "]"}], " ", ":=", " ", 
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"d\[DoubleStruckCapitalI]", "[", "i", "]"}], "[", 
       RowBox[{"x", ",", " ", "dx"}], "]"}], ",", " ", 
      RowBox[{"{", 
       RowBox[{"i", ",", " ", "nq"}], "}"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"\[DoubleStruckCapitalI]", "[", "i", "]"}], ",", " ", 
    RowBox[{
     RowBox[{
     "where", " ", "i", " ", "is", " ", "an", " ", "integer", " ", "is", " ", 
      "defined", " ", "in", " ", 
      RowBox[{"ExpandParameters", "[", "]"}]}], ";", " ", 
     RowBox[{"same", " ", "with", " ", 
      RowBox[{
       RowBox[{"d\[DoubleStruckCapitalI]", "[", "i", "]"}], "."}]}]}]}], " ", 
   "*)"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.615319907890235*^9, 3.615320003562295*^9}, {
  3.6153201335390835`*^9, 3.6153201342890816`*^9}, {3.615321234525612*^9, 
  3.615321256806917*^9}, {3.6159903572402115`*^9, 3.615990381376594*^9}, {
  3.6159904368567715`*^9, 3.615990439883944*^9}, {3.620994035736378*^9, 
  3.6209940579085445`*^9}, {3.62195693504071*^9, 3.621956951431367*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Model", "Section",
 CellChangeTimes->{{3.5914870039053636`*^9, 3.591487004222381*^9}, {
  3.5916678891560974`*^9, 3.5916678898031635`*^9}, {3.5922559886651573`*^9, 
  3.592256014246619*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"SetModel", "[", 
     RowBox[{
     "j_", ",", " ", "p_", ",", " ", "c_", ",", " ", "g_", ",", " ", 
      "\[DoubleStruckCapitalI]c_", ",", " ", "fr_", ",", " ", 
      RowBox[{"nder_:", "0"}], ",", " ", 
      RowBox[{"npar_:", "0"}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"ClearFunctions", "[", "]"}], ";", " ", 
       RowBox[{"(*", " ", 
        RowBox[{
         RowBox[{"do", " ", "some", " ", "internal", " ", "clean"}], "-", 
         "up"}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"ExpandTree", "[", 
        RowBox[{"j", ",", " ", "p", ",", " ", "c"}], "]"}], ";", " ", 
       RowBox[{"(*", " ", 
        RowBox[{
         RowBox[{
         "also", " ", "sets", " ", "number", " ", "of", " ", "links"}], ",", 
         " ", "dofs", ",", " ", 
         RowBox[{"etc", "."}]}], " ", "*)"}], "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"np", " ", "=", " ", 
        RowBox[{"Abs", "[", "npar", "]"}]}], ";", " ", 
       RowBox[{"(*", " ", 
        RowBox[{"set", " ", "#", " ", "of", " ", "parameters"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"nc", " ", "=", " ", 
        RowBox[{"np", " ", "+", " ", "nx"}]}], ";", " ", 
       RowBox[{"(*", " ", 
        RowBox[{"set", " ", "total", " ", "#", " ", "of", " ", "inputs"}], 
        " ", "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"SetDerivatives", "[", 
        RowBox[{"Which", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"nder", " ", "===", " ", "All"}], ",", " ", 
          RowBox[{"nx", "+", "nq"}], ",", " ", "\[IndentingNewLine]", 
          RowBox[{"nder", " ", "<", "0"}], ",", " ", 
          RowBox[{"nx", " ", "-", " ", "nder"}], ",", " ", 
          "\[IndentingNewLine]", "True", ",", " ", "nder"}], 
         "\[IndentingNewLine]", "]"}], "\[IndentingNewLine]", "]"}], ";", " ", 
       RowBox[{"(*", " ", 
        RowBox[{"initialize", " ", "derivative", " ", "data"}], " ", "*)"}], 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"ag", " ", "=", " ", 
        RowBox[{"Join", "[", 
         RowBox[{"z3", ",", " ", "g"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Zspat", " ", "=", " ", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"0", ",", " ", 
          RowBox[{"{", 
           RowBox[{"nq", ",", " ", "nm"}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"ZX", " ", "=", " ", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"0", ",", " ", 
          RowBox[{"{", 
           RowBox[{"nq", ",", " ", "nq", ",", " ", "nm", ",", " ", "nm"}], 
           "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"ZM", " ", "=", " ", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"0", ",", " ", 
          RowBox[{"{", 
           RowBox[{"nq", ",", " ", "nq"}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"znq", " ", "=", " ", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"0", ",", " ", "nq"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"ZJ", " ", "=", " ", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"0", ",", " ", 
          RowBox[{"{", 
           RowBox[{"mb", ",", " ", "nq"}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Zosim", " ", "=", " ", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"0", ",", " ", 
          RowBox[{"{", 
           RowBox[{"mb", ",", " ", "mb"}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"zmb", " ", "=", " ", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"0", ",", " ", "mb"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Imb", " ", "=", " ", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"mb", " ", ">", " ", "0"}], ",", " ", 
          RowBox[{"IdentityMatrix", "[", "mb", "]"}], ",", " ", 
          RowBox[{"{", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"ExpandConstraints", "[", "c", "]"}], ";", 
       RowBox[{"(*", " ", 
        RowBox[{"sets", " ", "r", " ", "and", " ", "bodies"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"ExpandParameters", "[", 
        RowBox[{"j", ",", " ", "\[DoubleStruckCapitalI]c", ",", " ", "fr"}], 
        "]"}]}]}], " ", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"sets", " ", "s"}], ",", " ", "fext", ",", " ", 
       "\[DoubleStruckCapitalI]", ",", " ", 
       RowBox[{"and", " ", "Xip"}]}], "  ", "*)"}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"SetDerivatives", "[", "n_", "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"nd", " ", "=", " ", "n"}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"n", " ", ">", " ", "0"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Znm", " ", "=", " ", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"0", ",", " ", 
             RowBox[{"{", 
              RowBox[{"nm", ",", " ", "nd"}], "}"}]}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"Zdspat", " ", "=", " ", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"0", ",", " ", 
             RowBox[{"{", 
              RowBox[{"nq", ",", " ", "nm", ",", " ", "nd"}], "}"}]}], 
            "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"ZdX", " ", "=", " ", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"0", ",", " ", 
             RowBox[{"{", 
              RowBox[{
              "nq", ",", " ", "nq", ",", " ", "nm", ",", " ", "nm", ",", " ", 
               "nd"}], "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"ZdM", " ", "=", " ", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"0", ",", " ", 
             RowBox[{"{", 
              RowBox[{"nq", ",", " ", "nq", ",", " ", "nd"}], "}"}]}], 
            "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"Znq", " ", "=", " ", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"0", ",", " ", 
             RowBox[{"{", 
              RowBox[{"nq", ",", " ", "nd"}], "}"}]}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"ZdJ", " ", "=", " ", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"0", ",", " ", 
             RowBox[{"{", 
              RowBox[{"mb", ",", " ", "nq", ",", " ", "nd"}], "}"}]}], 
            "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"Zdosim", " ", "=", " ", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"0", ",", " ", 
             RowBox[{"{", 
              RowBox[{"mb", ",", " ", "mb", ",", " ", "nd"}], "}"}]}], 
            "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"Zmb", " ", "=", " ", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"0", ",", " ", 
             RowBox[{"{", 
              RowBox[{"mb", ",", " ", "nd"}], "}"}]}], "]"}]}], ";"}]}], 
        "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}],
    ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ExpandConstraints", "[", "c_", "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"a", ",", " ", "f", ",", " ", "rfun"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"mb", " ", "\[LessEqual]", " ", "0"}], ",", " ", 
        RowBox[{"Return", "[", "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"expand", " ", "constraints"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"a", " ", "=", " ", 
       RowBox[{"constraint", " ", "/@", " ", "c"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "splice", " ", "in", " ", "list", " ", "of", " ", "constraints"}], " ",
        "*)"}], "\[IndentingNewLine]", 
      RowBox[{"a", " ", "=", " ", 
       RowBox[{"a", " ", "/.", " ", 
        RowBox[{
         RowBox[{"x_", "/;", 
          RowBox[{
           RowBox[{"VectorQ", "[", "x", "]"}], "&&", 
           RowBox[{
            RowBox[{"Length", "[", "x", "]"}], ">", " ", "0"}], "&&", 
           RowBox[{"StringQ", "[", 
            RowBox[{
            "x", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
            "]"}]}]}], "\[RuleDelayed]", " ", 
         RowBox[{"Sequence", "@@", 
          RowBox[{"(", 
           RowBox[{"constraint", " ", "/@", " ", "x"}], ")"}]}]}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "map", " ", "body0", " ", "joints", " ", "to", " ", "body", " ", 
        "joints"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"Function", "[", 
        RowBox[{
         RowBox[{"{", "b", "}"}], ",", " ", 
         RowBox[{
         "map", "\[LeftDoubleBracket]", "b", "\[RightDoubleBracket]"}], ",", 
         " ", "Listable"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"bodies", " ", "=", " ", 
       RowBox[{"f", "[", 
        RowBox[{"a", "\[LeftDoubleBracket]", 
         RowBox[{"All", ",", " ", "1"}], "\[RightDoubleBracket]"}], "]"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"bx", " ", "=", " ", 
       RowBox[{"DeleteDuplicates", "[", 
        RowBox[{"Flatten", "[", "bodies", "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"bl", " ", "=", " ", 
       RowBox[{"Map", "[", 
        RowBox[{"Length", ",", " ", "bodies"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"bodies", " ", "=", " ", 
       RowBox[{"PadRight", "[", 
        RowBox[{"bodies", ",", " ", 
         RowBox[{"{", 
          RowBox[{"mb", ",", " ", 
           RowBox[{"Max", "[", "bl", "]"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"create", " ", "r", " ", "and", " ", "dr"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{
        RowBox[{"MakeFunction", "[", 
         RowBox[{"#2", "[", 
          RowBox[{
           RowBox[{"\[DoubleStruckQ]", "[", 
            RowBox[{"#1", ",", " ", 
             RowBox[{"-", "1"}]}], "]"}], ",", " ", "#1"}], "]"}], "]"}], 
        "&"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Do", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"rfun", " ", "=", " ", 
          RowBox[{"MapThread", "[", 
           RowBox[{"f", ",", " ", 
            RowBox[{
            "a", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}], 
           "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"r", "[", "i", "]"}], " ", "=", " ", 
          RowBox[{"rfun", "\[LeftDoubleBracket]", 
           RowBox[{"All", ",", "1"}], "\[RightDoubleBracket]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"rdot", "[", "i", "]"}], " ", "=", " ", 
          RowBox[{"rfun", "\[LeftDoubleBracket]", 
           RowBox[{"All", ",", "2"}], "\[RightDoubleBracket]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"nd", " ", ">", " ", "0"}], ",", "  ", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"dr", "[", "i", "]"}], " ", "=", " ", 
             RowBox[{"rfun", "\[LeftDoubleBracket]", 
              RowBox[{"All", ",", "3"}], "\[RightDoubleBracket]"}]}], ";", 
            " ", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"drdot", "[", "i", "]"}], " ", "=", " ", 
             RowBox[{"rfun", "\[LeftDoubleBracket]", 
              RowBox[{"All", ",", "4"}], "\[RightDoubleBracket]"}]}], ";"}]}],
           "\[IndentingNewLine]", "]"}], ";"}], "\[IndentingNewLine]", ",", 
        " ", 
        RowBox[{"{", 
         RowBox[{"i", ",", " ", "mb"}], "}"}]}], "\[IndentingNewLine]", "]"}],
       ";"}]}], "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{
  3.591667817527995*^9, 3.591668923825349*^9, {3.5916697599352307`*^9, 
   3.591669819815657*^9}, {3.5916698753458366`*^9, 3.5916698888766146`*^9}, {
   3.5916699961457586`*^9, 3.591669997476833*^9}, {3.59167068192603*^9, 
   3.59167070374928*^9}, {3.5917208858180676`*^9, 3.591720889380574*^9}, {
   3.5917221970292563`*^9, 3.591722203732394*^9}, {3.591722238732463*^9, 
   3.591722239091839*^9}, {3.591930526907305*^9, 3.5919305664205675`*^9}, {
   3.5919306118141713`*^9, 3.591930612108184*^9}, 3.591930660729968*^9, {
   3.591930696356006*^9, 3.5919307386704297`*^9}, {3.5919308258974266`*^9, 
   3.5919308840727587`*^9}, {3.591931024599806*^9, 3.591931025034828*^9}, {
   3.591931958433284*^9, 3.5919319593043294`*^9}, {3.5919331117973347`*^9, 
   3.5919331580109777`*^9}, {3.591933250024245*^9, 3.591933252427383*^9}, {
   3.591985667141246*^9, 3.5919857313879256`*^9}, {3.591987361798293*^9, 
   3.591987364276435*^9}, {3.5919978599754896`*^9, 3.59199787152915*^9}, 
   3.5919979113604307`*^9, {3.5919979589681625`*^9, 3.5919979727709627`*^9}, 
   3.5919982080554256`*^9, {3.5920191973504057`*^9, 3.592019234797552*^9}, {
   3.5921518015301204`*^9, 3.592151821661277*^9}, {3.5921518519500084`*^9, 
   3.5921518784545245`*^9}, {3.5921519174737606`*^9, 3.592151918642827*^9}, {
   3.5921519914750166`*^9, 3.5921519924810553`*^9}, 3.5921521161271386`*^9, {
   3.5921521472189164`*^9, 3.592152245920565*^9}, {3.5921524640720634`*^9, 
   3.5921524695633802`*^9}, {3.5921527028097334`*^9, 
   3.5921527107801905`*^9}, {3.59215278839163*^9, 3.592152817779317*^9}, 
   3.5921530282183657`*^9, {3.59215320443246*^9, 3.5921532065185785`*^9}, {
   3.5922519586863747`*^9, 3.592251999186454*^9}, {3.592254165862566*^9, 
   3.5922542064876456`*^9}, {3.5922558428788123`*^9, 
   3.5922558607708282`*^9}, {3.5922558957868533`*^9, 3.592255901201167*^9}, 
   3.592255970324107*^9, {3.5922580456873465`*^9, 3.592258045853349*^9}, {
   3.5922581158633614`*^9, 3.592258139375705*^9}, {3.592258226580702*^9, 
   3.592258231348975*^9}, {3.592258396619439*^9, 3.5922584020647693`*^9}, {
   3.592258438962861*^9, 3.592258459774053*^9}, {3.5922591760830736`*^9, 
   3.5922591855486183`*^9}, {3.592259257920762*^9, 3.5922592787549534`*^9}, {
   3.5922594413162627`*^9, 3.592259469596903*^9}, {3.592259570929685*^9, 
   3.5922595851425023`*^9}, {3.592259622531643*^9, 3.5922596920396233`*^9}, {
   3.5922597847129307`*^9, 3.59225978836014*^9}, {3.592265284603904*^9, 
   3.592265302772931*^9}, {3.5922660757641973`*^9, 3.592266168732519*^9}, {
   3.592266745226554*^9, 3.5922667453035393`*^9}, 3.5922667840087557`*^9, {
   3.592266872124799*^9, 3.592266894180065*^9}, {3.5922669756537285`*^9, 
   3.5922669960148973`*^9}, {3.5922671554480267`*^9, 
   3.5922672007746234`*^9}, {3.592267352764331*^9, 3.592267352851329*^9}, {
   3.5922673878293343`*^9, 3.5922674271685877`*^9}, {3.5922677518271804`*^9, 
   3.592267753864293*^9}, {3.592269365102566*^9, 3.5922693810894814`*^9}, {
   3.5922694704245977`*^9, 3.59226951552118*^9}, 3.592269559872718*^9, {
   3.592269596464834*^9, 3.592269605997359*^9}, {3.592269651011939*^9, 
   3.5922696511789675`*^9}, {3.592269686507972*^9, 3.59226972943143*^9}, {
   3.5922698283110924`*^9, 3.5922699566064405`*^9}, {3.5922700800495105`*^9, 
   3.592270104246894*^9}, {3.5922701343156166`*^9, 3.5922701411890078`*^9}, {
   3.5922701729868326`*^9, 3.592270182028349*^9}, {3.59227026813428*^9, 
   3.592270307654543*^9}, {3.592270789010106*^9, 3.592270804936021*^9}, {
   3.592271003227376*^9, 3.5922710164511337`*^9}, {3.5922710767405863`*^9, 
   3.592271096212701*^9}, {3.5922712492224765`*^9, 3.59227124969849*^9}, 
   3.5922713284640007`*^9, {3.592271377491807*^9, 3.5922713780178576`*^9}, {
   3.5922714086255894`*^9, 3.592271408733595*^9}, {3.5922714892252083`*^9, 
   3.592271557448115*^9}, {3.5922717878813114`*^9, 3.592271820858195*^9}, 
   3.5922718793635445`*^9, {3.592271916862694*^9, 3.592271917492734*^9}, {
   3.592271975838073*^9, 3.5922719809793663`*^9}, {3.5922721103467903`*^9, 
   3.592272167605055*^9}, {3.592272355126795*^9, 3.5922723559508424`*^9}, {
   3.592272387750682*^9, 3.592272430457106*^9}, {3.5922724624049335`*^9, 
   3.592272486586323*^9}, {3.592272554254202*^9, 3.5922725606365767`*^9}, {
   3.5922726000188184`*^9, 3.5922726042520723`*^9}, {3.592272771832677*^9, 
   3.5922727837953434`*^9}, {3.5922728195993934`*^9, 
   3.5922728631518846`*^9}, {3.5922729410483484`*^9, 
   3.5922729655267687`*^9}, {3.5922731177624674`*^9, 
   3.5922731543115797`*^9}, {3.592273310760521*^9, 3.5922734737338514`*^9}, {
   3.5922735108949947`*^9, 3.592273518410412*^9}, {3.5922735543504705`*^9, 
   3.59227358123601*^9}, {3.592273646181729*^9, 3.592273726257312*^9}, {
   3.5922737869537907`*^9, 3.5922738520135164`*^9}, {3.5922740041642246`*^9, 
   3.592274023666346*^9}, {3.592274258321784*^9, 3.5922742741106863`*^9}, {
   3.592274419230996*^9, 3.5922744193890047`*^9}, {3.59227448977404*^9, 
   3.5922745196417465`*^9}, {3.5922745553427935`*^9, 3.592274595237076*^9}, {
   3.592274638285543*^9, 3.5922746696913414`*^9}, {3.5922747972366467`*^9, 
   3.5922748309945784`*^9}, {3.592274966500351*^9, 3.592274991427766*^9}, {
   3.592275022895569*^9, 3.592275031693086*^9}, {3.5922750665360675`*^9, 
   3.5922752337196403`*^9}, {3.5922753371725636`*^9, 
   3.5922753612429485`*^9}, {3.592275404604432*^9, 3.592275406126515*^9}, {
   3.5922755649776125`*^9, 3.5922756207168036`*^9}, {3.5922758717241945`*^9, 
   3.5922758743503284`*^9}, {3.5922805198023577`*^9, 3.592280560296678*^9}, {
   3.592280648507742*^9, 3.592280653503023*^9}, {3.59228859193862*^9, 
   3.592288631802901*^9}, {3.5922886637607336`*^9, 3.592288669778076*^9}, {
   3.5922887474895287`*^9, 3.5922887482945967`*^9}, {3.592288778321295*^9, 
   3.5922887893069234`*^9}, {3.5922930252875032`*^9, 
   3.5922930261875534`*^9}, {3.59232216412803*^9, 3.5923221645760417`*^9}, {
   3.5923222141038747`*^9, 3.5923222146439095`*^9}, {3.592322303587002*^9, 
   3.5923223085062847`*^9}, {3.592322455802719*^9, 3.592322482674258*^9}, 
   3.592322568846193*^9, {3.592323716015887*^9, 3.5923238349947195`*^9}, {
   3.5923238811463437`*^9, 3.592323903579629*^9}, {3.592323947101121*^9, 
   3.592323958546775*^9}, 3.592325020905615*^9, 3.5923250924057074`*^9, {
   3.592325178768654*^9, 3.5923251847249947`*^9}, {3.592325509846614*^9, 
   3.592325579905626*^9}, {3.592325610773393*^9, 3.592325610986409*^9}, {
   3.5923256480075245`*^9, 3.592325653257824*^9}, {3.592326357953201*^9, 
   3.5923263611073627`*^9}, {3.5923264423020124`*^9, 
   3.5923264641812835`*^9}, {3.592326512038006*^9, 3.5923266042622867`*^9}, {
   3.5923266497838936`*^9, 3.59232674643143*^9}, {3.592326830500261*^9, 
   3.5923268797860622`*^9}, {3.5923269342291837`*^9, 
   3.5923269986578894`*^9}, {3.5923270362190285`*^9, 3.592327117486677*^9}, {
   3.5923272314232144`*^9, 3.5923272715754995`*^9}, {3.5923273065705056`*^9, 
   3.592327350989049*^9}, {3.5923274125735755`*^9, 3.592327418064891*^9}, {
   3.5923275140303864`*^9, 3.5923276062176657`*^9}, {3.5923276532933617`*^9, 
   3.592327654185412*^9}, {3.5923276926456146`*^9, 3.592327692772622*^9}, {
   3.5923277288566885`*^9, 3.592327904489751*^9}, {3.592327939983777*^9, 
   3.5923279946489096`*^9}, {3.5923280273017793`*^9, 
   3.5923280708432727`*^9}, {3.592328256381916*^9, 3.592328311494054*^9}, {
   3.592328377548837*^9, 3.5923283784428883`*^9}, {3.5923290216127205`*^9, 
   3.592329030903251*^9}, 3.5923293277412486`*^9, {3.5923294589187665`*^9, 
   3.5923294903285656`*^9}, {3.592329543190589*^9, 3.59232954460567*^9}, {
   3.5923295995248127`*^9, 3.5923297137353554`*^9}, {3.5923297507114735`*^9, 
   3.5923297799551473`*^9}, {3.5923298456749153`*^9, 
   3.5923298638739705`*^9}, {3.592329916913991*^9, 3.5923299180660534`*^9}, {
   3.5923300051120396`*^9, 3.592330006966149*^9}, {3.592330040054043*^9, 
   3.5923300669505844`*^9}, {3.592330118277522*^9, 3.592330208584695*^9}, {
   3.5923302807648277`*^9, 3.5923303462545786`*^9}, {3.5923307023329697`*^9, 
   3.59233075823417*^9}, 3.59233085839291*^9, {3.5923309133830557`*^9, 
   3.592330926128785*^9}, {3.5923309567205377`*^9, 3.59233098767231*^9}, {
   3.5923310282886353`*^9, 3.592331084900878*^9}, {3.5923312539095697`*^9, 
   3.5923312777179203`*^9}, {3.5923313996679215`*^9, 3.592331563625311*^9}, {
   3.5923316207045584`*^9, 3.5923316484191484`*^9}, {3.592331710373694*^9, 
   3.59233173455208*^9}, {3.592331766743924*^9, 3.592331818322875*^9}, {
   3.592331902011675*^9, 3.5923319996242604`*^9}, {3.5923320770106974`*^9, 
   3.5923321816526823`*^9}, {3.592332323052782*^9, 3.5923323245848713`*^9}, {
   3.5923323692014256`*^9, 3.5923324045414486`*^9}, {3.592332447873933*^9, 
   3.592332509325468*^9}, {3.592332544584469*^9, 3.592332612939383*^9}, {
   3.5923327382425585`*^9, 3.592332893818468*^9}, {3.592332937962996*^9, 
   3.5923329423152466`*^9}, {3.5923330114832063`*^9, 
   3.5923330471242476`*^9}, {3.592333090562735*^9, 3.5923331256457443`*^9}, {
   3.592333182797021*^9, 3.5923332001360097`*^9}, {3.5923333254841843`*^9, 
   3.5923333524377313`*^9}, {3.5923334143242755`*^9, 3.59233362061009*^9}, {
   3.592333653265959*^9, 3.592333655125065*^9}, {3.592333718847728*^9, 
   3.5923337979862437`*^9}, {3.592333836173434*^9, 3.5923338582126956`*^9}, {
   3.592334017578822*^9, 3.592334021541049*^9}, {3.5923340968783627`*^9, 
   3.592334161335054*^9}, {3.592334191952804*^9, 3.592334217431267*^9}, {
   3.5923345274470387`*^9, 3.592334642373602*^9}, {3.5923347077953486`*^9, 
   3.59233471623883*^9}, {3.592334765200636*^9, 3.592334767330758*^9}, {
   3.592335071649193*^9, 3.5923350768634834`*^9}, {3.5923356715045385`*^9, 
   3.592335680606055*^9}, {3.5923538222759776`*^9, 3.592353831584521*^9}, {
   3.592370916535984*^9, 3.5923709463356905`*^9}, {3.5923711734726973`*^9, 
   3.5923711932798505`*^9}, {3.5923716758344617`*^9, 3.592371686130056*^9}, {
   3.592371744953433*^9, 3.59237175434396*^9}, {3.592371797994459*^9, 
   3.5923718202977347`*^9}, {3.5923747656754103`*^9, 
   3.5923747663284464`*^9}, {3.592383856791027*^9, 3.5923838888468666`*^9}, {
   3.5925242672389746`*^9, 3.592524267779004*^9}, {3.5926274023654532`*^9, 
   3.592627408631096*^9}, {3.5926275824752035`*^9, 3.592627592350204*^9}, {
   3.592629248489919*^9, 3.592629249235964*^9}, {3.592666598963564*^9, 
   3.5926666238073626`*^9}, {3.5927480544837275`*^9, 3.592748086640041*^9}, {
   3.592748144796405*^9, 3.5927481617651877`*^9}, {3.5927573412623234`*^9, 
   3.5927574347756777`*^9}, {3.59275746746855*^9, 3.5927575284640436`*^9}, {
   3.592757602718296*^9, 3.592757738909095*^9}, {3.5927578052508936`*^9, 
   3.592757817615602*^9}, {3.5927579162412496`*^9, 3.5927579330742135`*^9}, {
   3.5927579847871747`*^9, 3.5927581240521483`*^9}, {3.5927583344062004`*^9, 
   3.5927583505581193`*^9}, 3.5927585361497507`*^9, 3.5927587936214943`*^9, {
   3.5927722205204062`*^9, 3.5927722225355215`*^9}, 3.592772282776972*^9, {
   3.592772503867646*^9, 3.592772533815345*^9}, {3.5927729193364277`*^9, 
   3.5927729319051447`*^9}, 3.5927730226563387`*^9, {3.59277308372884*^9, 
   3.5927730939204226`*^9}, {3.5927736067457905`*^9, 
   3.5927736229767203`*^9}, {3.592774750369296*^9, 3.592774751706359*^9}, {
   3.592774918688921*^9, 3.5927749209450636`*^9}, {3.5927750138903694`*^9, 
   3.5927750150804386`*^9}, {3.5927758075778255`*^9, 3.5927758297290907`*^9}, 
   3.5927758991700706`*^9, 3.592776634043154*^9, {3.5927838843703566`*^9, 
   3.592783909985819*^9}, 3.5927840139887733`*^9, {3.592784078955496*^9, 
   3.592784082913722*^9}, 3.592784163587345*^9, 3.5927844291405516`*^9, {
   3.592787029139098*^9, 3.5927870296661277`*^9}, {3.592795076924966*^9, 
   3.5927950799641404`*^9}, {3.5927966990768614`*^9, 3.5927967261314106`*^9}, 
   3.5927974903971777`*^9, {3.5928532026848984`*^9, 3.5928532129349174`*^9}, {
   3.592853268575651*^9, 3.5928532751225386`*^9}, {3.5928646899159594`*^9, 
   3.5928647156035233`*^9}, {3.5928649608227425`*^9, 
   3.5928649642446213`*^9}, {3.5928650351197734`*^9, 3.592865035526013*^9}, {
   3.592997964386854*^9, 3.592997965339981*^9}, {3.5929982374186516`*^9, 
   3.5929982698562026`*^9}, {3.5929990054201403`*^9, 
   3.5929990359670744`*^9}, {3.5929990747796507`*^9, 3.592999077435906*^9}, {
   3.5929996605932937`*^9, 3.592999811718605*^9}, {3.592999847078039*^9, 
   3.5929998475780396`*^9}, {3.592999884296874*^9, 3.592999903375021*^9}, {
   3.5929999497188616`*^9, 3.592999951828241*^9}, {3.593000133500471*^9, 
   3.5930001517661314`*^9}, {3.5930001841255703`*^9, 3.593000241344432*^9}, {
   3.593000320422727*^9, 3.593000325625847*^9}, {3.5930047794626813`*^9, 
   3.5930048130252466`*^9}, {3.5930076839214864`*^9, 
   3.5930077052965283`*^9}, {3.593007753812248*^9, 3.5930077743279257`*^9}, {
   3.593007819765502*^9, 3.593007828906145*^9}, {3.593008132578616*^9, 
   3.5930082017662487`*^9}, {3.5931384523424244`*^9, 3.593138458623686*^9}, {
   3.593139223218931*^9, 3.593139237203333*^9}, {3.59330403638407*^9, 
   3.5933040374465714`*^9}, {3.5933146987974606`*^9, 
   3.5933147181099977`*^9}, {3.5933148354852285`*^9, 
   3.5933148372977314`*^9}, {3.5933149153447595`*^9, 3.593314915735385*^9}, {
   3.5933284495330343`*^9, 3.5933284498060474`*^9}, {3.5933702211108885`*^9, 
   3.5933702214858894`*^9}, {3.602616632375787*^9, 3.602616639250167*^9}, {
   3.6026166804415255`*^9, 3.602616701736745*^9}, {3.6026169797616663`*^9, 
   3.6026169994388037`*^9}, {3.602617436014795*^9, 3.6026174451513176`*^9}, {
   3.6026174944601603`*^9, 3.6026174948251715`*^9}, {3.6026175687084036`*^9, 
   3.6026175882275114`*^9}, {3.6026176389854183`*^9, 
   3.6026176392874355`*^9}, {3.6027069028889008`*^9, 
   3.6027069529367657`*^9}, {3.602707103595394*^9, 3.6027071080636597`*^9}, {
   3.6029456555473385`*^9, 3.6029456665473604`*^9}, {3.603244773462284*^9, 
   3.6032447926203785`*^9}, {3.603245694097005*^9, 3.603245699375308*^9}, {
   3.6032459477105293`*^9, 3.6032459579891357`*^9}, {3.603258402707737*^9, 
   3.603258403861804*^9}, {3.6032587856866693`*^9, 3.6032588137552757`*^9}, {
   3.603301298523596*^9, 3.603301332131522*^9}, {3.6033061597339826`*^9, 
   3.603306160227024*^9}, {3.6033239506362476`*^9, 3.6033239758126926`*^9}, {
   3.6033777077559423`*^9, 3.603377732153326*^9}, {3.6033780135774417`*^9, 
   3.603378058688035*^9}, {3.6033782862120547`*^9, 3.6033782958116083`*^9}, 
   3.6035063793602805`*^9, {3.6035064915636253`*^9, 3.6035065401262197`*^9}, {
   3.6035065753450394`*^9, 3.6035066150326185`*^9}, {3.603506695673399*^9, 
   3.6035067110328045`*^9}, {3.603506810454874*^9, 3.6035070392990685`*^9}, {
   3.6035071088304577`*^9, 3.603507125455489*^9}, {3.603507190549367*^9, 
   3.6035072680182686`*^9}, {3.6035073038933396`*^9, 3.603507372877848*^9}, {
   3.6035081103167915`*^9, 3.603508116676179*^9}, {3.6035145818475375`*^9, 
   3.6035146071757097`*^9}, 3.6035147056602793`*^9, {3.603516204116331*^9, 
   3.603516228382007*^9}, {3.603516666976615*^9, 3.6035167675393314`*^9}, {
   3.6035167990706244`*^9, 3.603516891320803*^9}, {3.603516965352198*^9, 
   3.6035169716959605`*^9}, {3.6035171645713615`*^9, 3.603517356321713*^9}, {
   3.603517386931161*^9, 3.603517475915696*^9}, {3.6035176212441077`*^9, 
   3.60351762572849*^9}, {3.603564510241558*^9, 3.6035645258665915`*^9}, {
   3.6035650201175575`*^9, 3.6035651483365583`*^9}, {3.603565179195989*^9, 
   3.60356521605544*^9}, {3.603565261758656*^9, 3.6035652903368397`*^9}, {
   3.6035653753838944`*^9, 3.6035654308371115`*^9}, 3.6035654846184654`*^9, {
   3.603565619353104*^9, 3.603565654696924*^9}, {3.6035656921345153`*^9, 
   3.6035656927751236`*^9}, {3.6035657915565667`*^9, 3.603565831275394*^9}, {
   3.603566015432004*^9, 3.603566047432067*^9}, {3.6035660842602634`*^9, 
   3.6035661158071985`*^9}, {3.603566151541645*^9, 3.60356616186979*^9}, {
   3.603566858027401*^9, 3.6035668617930536`*^9}, {3.603567104199758*^9, 
   3.603567111621648*^9}, {3.603567178934281*^9, 3.6035672512469196`*^9}, {
   3.603567284684486*^9, 3.6035672855594883`*^9}, {3.603567436200407*^9, 
   3.603567439841039*^9}, {3.603567530981843*^9, 3.603567594544467*^9}, {
   3.603567691122796*^9, 3.6035677069509363`*^9}, {3.6035768979265656`*^9, 
   3.603576920160983*^9}, {3.603577655771797*^9, 3.6035776640530615`*^9}, {
   3.6035798994092274`*^9, 3.6035799107842493`*^9}, {3.6035800361594944`*^9, 
   3.6035800368469963`*^9}, {3.6035800968471146`*^9, 
   3.6035800971752386`*^9}, {3.6035802736130853`*^9, 
   3.6035803925820675`*^9}, {3.6035804922072616`*^9, 
   3.6035804924572625`*^9}, {3.6035805408479843`*^9, 
   3.6035805717386665`*^9}, {3.603580796332856*^9, 3.6035809117862062`*^9}, {
   3.603581022005173*^9, 3.6035812062711573`*^9}, {3.603581260646263*^9, 
   3.6035812689275303`*^9}, {3.603581304474475*^9, 3.6035813949590273`*^9}, 
   3.603581439959115*^9, {3.603581499943607*^9, 3.603581519803021*^9}, {
   3.6035830136712027`*^9, 3.6035830684838057`*^9}, {3.6035831018588743`*^9, 
   3.603583120671412*^9}, {3.603583176984022*^9, 3.6035832173434753`*^9}, {
   3.603583352890616*^9, 3.603583376828163*^9}, {3.603586798829563*^9, 
   3.6035868186806993`*^9}, {3.6035869453259563`*^9, 3.6035870496559286`*^9}, 
   3.6035873574335527`*^9, {3.603587599238414*^9, 3.6035876049107246`*^9}, {
   3.603587725399625*^9, 3.603587740096466*^9}, {3.603587778570669*^9, 
   3.603587780818816*^9}, {3.6035879199487658`*^9, 3.603587995252078*^9}, 
   3.6035881928503933`*^9, 3.60358872626394*^9, {3.6035888008222103`*^9, 
   3.6035888094567003`*^9}, {3.603593738919999*^9, 3.603593741428141*^9}, {
   3.6035937803023677`*^9, 3.603593781762451*^9}, {3.6035938506363955`*^9, 
   3.6035938620920706`*^9}, {3.6035939877982516`*^9, 
   3.6035940271755238`*^9}, {3.603594402709011*^9, 3.603594403603062*^9}, {
   3.6035949150043483`*^9, 3.6035949354035163`*^9}, {3.6035968305906286`*^9, 
   3.603596830683652*^9}, {3.6035969046348696`*^9, 3.603596936212674*^9}, {
   3.6036494464427624`*^9, 3.6036494496959453`*^9}, {3.6036511949248924`*^9, 
   3.603651204074416*^9}, {3.6037627647379913`*^9, 3.603762833425623*^9}, {
   3.603762864691308*^9, 3.6037628782694597`*^9}, {3.603764552338456*^9, 
   3.603764554447835*^9}, {3.6041963631204324`*^9, 3.6041963652675533`*^9}, {
   3.604500943679971*^9, 3.604500944042988*^9}, {3.6045093959439993`*^9, 
   3.604509411100871*^9}, {3.604518683412189*^9, 3.6045186837712097`*^9}, {
   3.60452762844744*^9, 3.6045276350058155`*^9}, {3.604527796294049*^9, 
   3.604527890492447*^9}, {3.6045280743769774`*^9, 3.604528078176194*^9}, {
   3.6045283072683153`*^9, 3.604528313946697*^9}, {3.604754908022459*^9, 
   3.6047549176420236`*^9}, {3.604763767341802*^9, 3.6047637679688373`*^9}, {
   3.604765613798541*^9, 3.6047656511196785`*^9}, {3.604853132845527*^9, 
   3.604853171954979*^9}, {3.604853233783225*^9, 3.6048532607832775`*^9}, {
   3.6051463068772154`*^9, 3.605146350799159*^9}, {3.6051463901586103`*^9, 
   3.6051464222524223`*^9}, {3.605147008729554*^9, 3.605147009542055*^9}, {
   3.6053917921154375`*^9, 3.605391825568629*^9}, {3.614432180557161*^9, 
   3.61443220447653*^9}, 3.614432257848587*^9, {3.6152091583067255`*^9, 
   3.615209158384848*^9}, {3.615320687493293*^9, 3.6153206975714283`*^9}, {
   3.6153211668067274`*^9, 3.615321167275477*^9}, {3.615321266369424*^9, 
   3.615321266931923*^9}, {3.6159364390422916`*^9, 3.6159364581413813`*^9}, 
   3.615936490949264*^9, {3.6209941329709435`*^9, 3.620994138970955*^9}, {
   3.6223301545877466`*^9, 3.6223301593240027`*^9}, {3.6223302166662846`*^9, 
   3.6223302625319257`*^9}, {3.6223323857377076`*^9, 3.6223323898783407`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ExpandParameters", "[", 
     RowBox[{"j_", ",", " ", "\[DoubleStruckCapitalI]c_", ",", " ", "fr_"}], 
     "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "kb", ",", " ", "kf", ",", " ", "jc", ",", " ", "S", ",", " ", "XT", 
        ",", " ", "sfun", ",", " ", "Xfun", ",", " ", "Ifun"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"f0ext", " ", "=", " ", "Zspat"}], ";", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"\[DoubleStruckCapitalI]", " ", "=", " ", 
          RowBox[{"ConstantArray", "[", 
           RowBox[{"0", ",", " ", 
            RowBox[{"{", 
             RowBox[{"nq", ",", " ", "nm", ",", " ", "nm"}], "}"}]}], "]"}]}],
          ";"}], "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"Do", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"kb", " ", "=", " ", 
           RowBox[{
           "map", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}], 
          ";", " ", 
          RowBox[{"(*", " ", 
           RowBox[{
           "last", " ", "link", " ", "of", " ", "expanded", " ", "link", " ", 
            "i"}], " ", "*)"}], "\[IndentingNewLine]", 
          RowBox[{"kf", " ", "=", " ", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"i", " ", "\[Equal]", " ", "1"}], ",", " ", "1", ",", 
             " ", 
             RowBox[{
              RowBox[{"map", "\[LeftDoubleBracket]", 
               RowBox[{"i", " ", "-", " ", "1"}], "\[RightDoubleBracket]"}], 
              " ", "+", " ", "1"}]}], "]"}]}], ";", 
          RowBox[{"(*", " ", 
           RowBox[{
           "1", "st", " ", "link", " ", "of", " ", "expanded", " ", "link", 
            " ", "i"}], " ", "*)"}], "\[IndentingNewLine]", 
          "\[IndentingNewLine]", 
          RowBox[{"jc", " ", "=", " ", 
           RowBox[{
           "j", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}], ";",
           "\[IndentingNewLine]", 
          RowBox[{"S", " ", "=", " ", 
           RowBox[{"joint", "[", "jc", "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"VectorQ", "[", 
             RowBox[{"S", ",", " ", "StringQ"}], "]"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"jc", " ", "=", " ", "S"}], ";", "\[IndentingNewLine]", 
             RowBox[{"Do", "[", "\[IndentingNewLine]", 
              RowBox[{"(*", " ", 
               RowBox[{
               "set", " ", "motion", " ", "freedoms", " ", "for", " ", 
                "expanded", " ", "links"}], " ", "*)"}], 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{
                RowBox[{"sfun", " ", "=", " ", 
                 RowBox[{"MakeFunction", "[", 
                  RowBox[{
                   RowBox[{"joint", "[", 
                    RowBox[{"jc", "\[LeftDoubleBracket]", 
                    RowBox[{"k", "+", "1"}], "\[RightDoubleBracket]"}], "]"}],
                    "[", 
                   RowBox[{
                    RowBox[{"\[DoubleStruckQ]", "[", 
                    RowBox[{"i", ",", 
                    RowBox[{"k", "+", "1"}]}], "]"}], ",", " ", "i"}], "]"}], 
                  "]"}]}], ";", "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"s", "[", 
                    RowBox[{"kf", " ", "+", " ", "k"}], "]"}], ",", " ", 
                   RowBox[{"sdot", "[", 
                    RowBox[{"kf", " ", "+", " ", "k"}], "]"}]}], "}"}], " ", 
                 "=", " ", 
                 RowBox[{"sfun", "\[LeftDoubleBracket]", 
                  RowBox[{"1", ";;", "2"}], "\[RightDoubleBracket]"}]}], ";", 
                "\[IndentingNewLine]", "\[IndentingNewLine]", 
                RowBox[{"(*", " ", 
                 RowBox[{
                  RowBox[{"links", " ", "kf"}], "+", 
                  RowBox[{"1", " ", "to", " ", 
                   RowBox[{
                   "map", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}], " ", "are", " ", "coincident", 
                   " ", "with", " ", "kf"}]}], " ", "*)"}], 
                "\[IndentingNewLine]", 
                RowBox[{"XT", " ", "=", " ", "I6"}], ";", 
                "\[IndentingNewLine]", 
                RowBox[{"Xfun", " ", "=", " ", 
                 RowBox[{"MakeFunction", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"XJ", "[", 
                    RowBox[{"jc", "\[LeftDoubleBracket]", 
                    RowBox[{"k", "+", "1"}], "\[RightDoubleBracket]"}], "]"}],
                     "[", 
                    RowBox[{
                    RowBox[{"\[DoubleStruckQ]", "[", 
                    RowBox[{"i", ",", 
                    RowBox[{"k", "+", "1"}]}], "]"}], ",", " ", "i"}], "]"}], 
                   ".", "XT"}], "]"}]}], ";", "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"Xip", "[", 
                    RowBox[{"kf", "+", "k"}], "]"}], ",", " ", 
                   RowBox[{"Xdotip", "[", 
                    RowBox[{"kf", "+", "k"}], "]"}]}], "}"}], " ", "=", " ", 
                 RowBox[{"Xfun", "\[LeftDoubleBracket]", 
                  RowBox[{"1", ";;", "2"}], "\[RightDoubleBracket]"}]}], ";", 
                "\[IndentingNewLine]", "\[IndentingNewLine]", 
                RowBox[{"(*", " ", 
                 RowBox[{
                  RowBox[{
                  "zero", " ", "inertia", " ", "for", " ", "extra", " ", 
                   "links", " ", "kf", " ", "to", " ", 
                   RowBox[{
                   "map", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}]}], " ", "-", " ", "1"}], " ", 
                 "*)"}], "\[IndentingNewLine]", 
                RowBox[{"Ifun", " ", "=", " ", 
                 RowBox[{"MakeFunction", "[", "Z6", "]"}]}], ";", 
                "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{"\[DoubleStruckCapitalI]", "[", 
                  RowBox[{"kb", " ", "-", " ", "k"}], "]"}], " ", "=", " ", 
                 RowBox[{
                 "Ifun", "\[LeftDoubleBracket]", "1", 
                  "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
                "\[IndentingNewLine]", 
                RowBox[{"(*", " ", 
                 RowBox[{"set", " ", "derivatives"}], " ", "*)"}], 
                "\[IndentingNewLine]", 
                RowBox[{"If", "[", 
                 RowBox[{
                  RowBox[{"nd", " ", ">", " ", "0"}], ",", " ", 
                  "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"ds", "[", 
                    RowBox[{"kf", " ", "+", " ", "k"}], "]"}], ",", " ", 
                    RowBox[{"dsdot", "[", 
                    RowBox[{"kf", " ", "+", " ", "k"}], "]"}]}], "}"}], " ", 
                    "=", " ", 
                    RowBox[{"sfun", "\[LeftDoubleBracket]", 
                    RowBox[{"3", ";;", "4"}], "\[RightDoubleBracket]"}]}], 
                   ";", 
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"dXip", "[", 
                    RowBox[{"kf", "+", "k"}], "]"}], ",", " ", 
                    RowBox[{"dXdotip", "[", 
                    RowBox[{"kf", "+", "k"}], "]"}]}], "}"}], " ", "=", " ", 
                    RowBox[{"Xfun", "\[LeftDoubleBracket]", 
                    RowBox[{"3", ";;", "4"}], "\[RightDoubleBracket]"}]}], 
                   ";", "\[IndentingNewLine]", 
                   RowBox[{
                    RowBox[{"d\[DoubleStruckCapitalI]", "[", 
                    RowBox[{"kb", " ", "-", " ", "k"}], "]"}], " ", "=", " ", 
                    RowBox[{
                    "Ifun", "\[LeftDoubleBracket]", "3", 
                    "\[RightDoubleBracket]"}]}], ";"}]}], 
                 "\[IndentingNewLine]", "]"}], ";"}], "\[IndentingNewLine]", 
               ",", " ", 
               RowBox[{"{", 
                RowBox[{"k", ",", " ", "1", ",", " ", 
                 RowBox[{
                  RowBox[{
                  "ni", "\[LeftDoubleBracket]", "i", 
                   "\[RightDoubleBracket]"}], " ", "-", " ", "1"}]}], "}"}]}],
               "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
             RowBox[{"(*", " ", 
              RowBox[{
               RowBox[{"now", " ", "get", " ", "1"}], "-", 
               RowBox[{
               "dof", " ", "code", " ", "of", " ", "first", " ", "expanded", 
                " ", "joint", " ", "of", " ", "i"}]}], " ", "*)"}], 
             "\[IndentingNewLine]", 
             RowBox[{"jc", " ", "=", " ", 
              RowBox[{
              "jc", " ", "\[LeftDoubleBracket]", "1", 
               "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"S", " ", "=", " ", 
              RowBox[{"joint", "[", "jc", "]"}]}], ";"}]}], 
           "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"set", " ", "up", " ", "links", " ", "kb"}], " ", "&"}],
              " ", "kf"}], ";", " ", 
            RowBox[{
             RowBox[{
             "these", " ", "are", " ", "equal", " ", "for", " ", "1"}], "-", 
             RowBox[{"dof", " ", "links"}]}]}], " ", "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{"sfun", " ", "=", " ", 
           RowBox[{"MakeFunction", "[", 
            RowBox[{"S", "[", 
             RowBox[{
              RowBox[{"\[DoubleStruckQ]", "[", 
               RowBox[{"i", ",", "1"}], "]"}], ",", " ", "i"}], "]"}], 
            "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"s", "[", "kf", "]"}], ",", " ", 
             RowBox[{"sdot", "[", "kf", "]"}]}], "}"}], " ", "=", " ", 
           RowBox[{"sfun", "\[LeftDoubleBracket]", 
            RowBox[{"1", ";;", "2"}], "\[RightDoubleBracket]"}]}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"XT", " ", "=", " ", 
           RowBox[{"Xba", "[", 
            RowBox[{
            "fr", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
            "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"Xfun", " ", "=", " ", 
           RowBox[{"MakeFunction", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"XJ", "[", "jc", "]"}], "[", 
              RowBox[{
               RowBox[{"\[DoubleStruckQ]", "[", 
                RowBox[{"i", ",", "1"}], "]"}], ",", " ", "i"}], "]"}], ".", 
             "XT"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"Xip", "[", "kf", "]"}], ",", " ", 
             RowBox[{"Xdotip", "[", "kf", "]"}]}], "}"}], " ", "=", " ", 
           RowBox[{"Xfun", "\[LeftDoubleBracket]", 
            RowBox[{"1", ";;", "2"}], "\[RightDoubleBracket]"}]}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"Ifun", " ", "=", " ", 
           RowBox[{"MakeFunction", "[", 
            RowBox[{"AddInertia", "[", 
             RowBox[{
             "\[DoubleStruckCapitalI]c", "\[LeftDoubleBracket]", "i", 
              "\[RightDoubleBracket]"}], "]"}], "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"Length", "[", 
                 RowBox[{
                 "\[DoubleStruckCapitalI]c", "\[LeftDoubleBracket]", "i", 
                  "\[RightDoubleBracket]"}], "]"}], " ", "\[Equal]", " ", 
                "10"}], ",", " ", "\[IndentingNewLine]", 
               RowBox[{"Io", "[", 
                RowBox[{
                 RowBox[{"\[DoubleStruckCapitalI]c", "\[LeftDoubleBracket]", 
                  RowBox[{"i", ",", " ", "1"}], "\[RightDoubleBracket]"}], 
                 ",", " ", 
                 RowBox[{"\[DoubleStruckCapitalI]c", "\[LeftDoubleBracket]", 
                  RowBox[{"i", ",", " ", 
                   RowBox[{"2", ";;", "7"}]}], "\[RightDoubleBracket]"}], ",",
                  " ", 
                 RowBox[{"DiagonalMatrix", "[", 
                  RowBox[{"\[DoubleStruckCapitalI]c", "\[LeftDoubleBracket]", 
                   RowBox[{"i", ",", " ", 
                    RowBox[{"8", ";;", "10"}]}], "\[RightDoubleBracket]"}], 
                  "]"}]}], "]"}], ",", " ", 
               RowBox[{"(*", " ", "else", " ", "*)"}], "\[IndentingNewLine]", 
               RowBox[{"Io", "[", 
                RowBox[{
                 RowBox[{"\[DoubleStruckCapitalI]c", "\[LeftDoubleBracket]", 
                  RowBox[{"i", ",", " ", "1"}], "\[RightDoubleBracket]"}], 
                 ",", " ", 
                 RowBox[{"\[DoubleStruckCapitalI]c", "\[LeftDoubleBracket]", 
                  RowBox[{"i", ",", " ", 
                   RowBox[{"2", ";;", "7"}]}], "\[RightDoubleBracket]"}], ",",
                  " ", 
                 RowBox[{"Partition", "[", 
                  RowBox[{
                   RowBox[{"\[DoubleStruckCapitalI]c", "\[LeftDoubleBracket]", 
                    RowBox[{"i", ",", " ", 
                    RowBox[{"8", ";;", "16"}]}], "\[RightDoubleBracket]"}], 
                   ",", " ", "3"}], "]"}]}], "]"}]}], "\[IndentingNewLine]", 
              "]"}], "*)"}], "\[IndentingNewLine]", "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"\[DoubleStruckCapitalI]", "[", "kb", "]"}], " ", "=", " ", 
           RowBox[{
           "Ifun", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}], 
          ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"nd", " ", ">", " ", "0"}], ",", " ", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{"ds", "[", "kf", "]"}], ",", " ", 
                RowBox[{"dsdot", "[", "kf", "]"}]}], "}"}], " ", "=", " ", 
              RowBox[{"sfun", "\[LeftDoubleBracket]", 
               RowBox[{"3", ";;", "4"}], "\[RightDoubleBracket]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{"dXip", "[", "kf", "]"}], ",", " ", 
                RowBox[{"dXdotip", "[", "kf", "]"}]}], "}"}], " ", "=", " ", 
              RowBox[{"Xfun", "\[LeftDoubleBracket]", 
               RowBox[{"3", ";;", "4"}], "\[RightDoubleBracket]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"d\[DoubleStruckCapitalI]", "[", "kb", "]"}], " ", "=", 
              " ", 
              RowBox[{
              "Ifun", "\[LeftDoubleBracket]", "3", 
               "\[RightDoubleBracket]"}]}], ";"}]}], "\[IndentingNewLine]", 
           "]"}], ";"}], "\[IndentingNewLine]", ",", " ", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", "nb"}], "}"}]}], "]"}], ";"}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ExpandTree", "[", 
     RowBox[{"j_", ",", " ", "\[Lambda]_", ",", " ", "c_"}], "]"}], " ", ":=",
     " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "f", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"f", " ", "=", " ", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"StringQ", "[", 
            RowBox[{
             RowBox[{"#1", "[", "#2", "]"}], "\[LeftDoubleBracket]", "1", 
             "\[RightDoubleBracket]"}], "]"}], ",", " ", 
           RowBox[{"Length", "[", 
            RowBox[{"#1", "[", "#2", "]"}], "]"}], ",", " ", "1"}], "]"}], 
         "&"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"nm", " ", "=", " ", "6"}], ";", "\[IndentingNewLine]", 
       RowBox[{"nb", " ", "=", " ", 
        RowBox[{"Length", "@", "j"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"ni", " ", "=", " ", 
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"f", "[", 
            RowBox[{"joint", ",", " ", "#"}], "]"}], "&"}], ",", " ", "j"}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"nq", " ", "=", " ", 
        RowBox[{"Total", "[", "ni", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"nx", " ", "=", " ", 
        RowBox[{"2", "nq"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"mb", " ", "=", " ", "0"}], ";", "\[IndentingNewLine]", 
       RowBox[{"Do", "[", 
        RowBox[{
         RowBox[{"mb", " ", "=", " ", 
          RowBox[{"mb", " ", "+", " ", 
           RowBox[{"f", "[", 
            RowBox[{"constraint", ",", " ", "i"}], "]"}]}]}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", "c"}], "}"}]}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"parent0", " ", "=", " ", "\[Lambda]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"allocate", " ", "mem"}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"parent", " ", "=", " ", 
        RowBox[{
         RowBox[{"Range", "[", "nq", "]"}], " ", "-", " ", "1"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"map", " ", "=", " ", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"0", ",", " ", "nb"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
        "create", " ", "mapping", " ", "from", " ", "original", " ", "to", 
         " ", "extended", " ", "tree"}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"map", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}],
         " ", "=", " ", 
        RowBox[{
        "ni", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Do", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
          "map", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], " ", 
          "=", " ", 
          RowBox[{
           RowBox[{"map", "\[LeftDoubleBracket]", 
            RowBox[{"i", "-", "1"}], "\[RightDoubleBracket]"}], "+", 
           RowBox[{
           "ni", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}]}], 
         ",", " ", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", "2", ",", " ", "nb"}], "}"}]}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
        "create", " ", "extended", " ", "tree", " ", "and", " ", "body", " ", 
         "arrays"}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
        "parent", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], " ",
         "=", " ", "0"}], ";", "\[IndentingNewLine]", 
       RowBox[{"Do", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"parent", "\[LeftDoubleBracket]", 
           RowBox[{
            RowBox[{"map", "\[LeftDoubleBracket]", 
             RowBox[{"i", "-", "1"}], "\[RightDoubleBracket]"}], "+", "1"}], 
           "\[RightDoubleBracket]"}], " ", "=", " ", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{
             "\[Lambda]", "\[LeftDoubleBracket]", "i", 
              "\[RightDoubleBracket]"}], " ", "\[NotEqual]", " ", "0"}], ",", 
            " ", 
            RowBox[{"map", "\[LeftDoubleBracket]", 
             RowBox[{
             "\[Lambda]", "\[LeftDoubleBracket]", "i", 
              "\[RightDoubleBracket]"}], "\[RightDoubleBracket]"}], ",", " ", 
            "0"}], "]"}]}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", "2", ",", " ", "nb"}], "}"}]}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"update", " ", "nca"}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"MakeNCA", "[", 
        RowBox[{"parent", ",", " ", "nq"}], "]"}], ";"}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MakeNCA", "[", 
     RowBox[{"parent_", ",", " ", "n_"}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "p", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"nearest", " ", "common", " ", "ancestor", " ", 
        RowBox[{"(", "nca", ")"}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"nca", " ", "=", " ", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"0", ",", " ", 
          RowBox[{"{", 
           RowBox[{"n", ",", " ", "n"}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Do", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"nca", "\[LeftDoubleBracket]", 
            RowBox[{"i", ",", " ", "i"}], "\[RightDoubleBracket]"}], " ", "=",
            " ", "i"}], ";", "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{"your", " ", 
            RowBox[{"parent", "'"}], "s", " ", "ncas", " ", "are", " ", 
            "your", " ", "ncas"}], " ", "*)"}], "\[IndentingNewLine]", 
          RowBox[{"p", " ", "=", " ", 
           RowBox[{
           "parent", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}],
           ";", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"p", " ", "\[NotEqual]", " ", "0"}], ",", " ", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
              RowBox[{
               RowBox[{"parent", "'"}], "s", " ", "ancestors"}], " ", "+", 
              " ", "siblings"}], " ", "*)"}], "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"nca", "\[LeftDoubleBracket]", 
               RowBox[{"i", ",", " ", 
                RowBox[{"1", ";;", "p"}]}], "\[RightDoubleBracket]"}], " ", 
              "=", " ", 
              RowBox[{"nca", "\[LeftDoubleBracket]", 
               RowBox[{"p", ",", " ", 
                RowBox[{"1", ";;", "p"}]}], "\[RightDoubleBracket]"}]}], ";", 
             "\[IndentingNewLine]", "\[IndentingNewLine]", 
             RowBox[{"(*", " ", 
              RowBox[{
               RowBox[{
                RowBox[{"parent", "'"}], "s", " ", "siblings"}], " ", "+", 
               " ", "kids"}], " ", "*)"}], "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"nca", "\[LeftDoubleBracket]", 
               RowBox[{"i", ",", " ", 
                RowBox[{
                 RowBox[{"p", "+", "1"}], ";;", 
                 RowBox[{"i", "-", "1"}]}]}], "\[RightDoubleBracket]"}], " ", 
              "=", " ", 
              RowBox[{"nca", "\[LeftDoubleBracket]", 
               RowBox[{
                RowBox[{
                 RowBox[{"p", "+", "1"}], ";;", 
                 RowBox[{"i", "-", "1"}]}], ",", " ", "p"}], 
               "\[RightDoubleBracket]"}]}], ";"}]}], "\[IndentingNewLine]", 
           "]"}], ";"}], "\[IndentingNewLine]", ",", " ", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", "n"}], "}"}]}], "\[IndentingNewLine]", "]"}],
        ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"nca", " ", "=", " ", 
        RowBox[{"nca", " ", "+", " ", 
         RowBox[{
          RowBox[{"LowerTriangularize", "[", 
           RowBox[{"nca", ",", " ", 
            RowBox[{"-", "1"}]}], "]"}], "\[Transpose]"}]}]}], ";"}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetPath", "[", 
    RowBox[{"i_", ",", " ", 
     RowBox[{"j_:", "0"}]}], "]"}], " ", ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"a", ",", " ", "i2a", ",", " ", "j2a"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "returns", " ", "the", " ", "path", " ", "from", " ", "i", " ", "to", 
       " ", "j"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
       "this", " ", "can", " ", "also", " ", "be", " ", "used", " ", "to", 
        " ", "return", " ", "the", " ", "children", " ", "on", " ", "a", " ", 
        "path", " ", "if", " ", "a"}], " ", "\[Element]", " ", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"i", ",", " ", "j"}], "}"}], "."}]}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"a", " ", "=", " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"i", " ", "\[Equal]", " ", "0"}], " ", "||", " ", 
          RowBox[{"j", " ", "\[Equal]", " ", "0"}]}], ",", " ", "0", ",", " ", 
         RowBox[{"nca", "\[LeftDoubleBracket]", 
          RowBox[{"i", ",", " ", "j"}], "\[RightDoubleBracket]"}]}], "]"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"i2a", " ", "=", " ", 
       RowBox[{"NestWhileList", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
          "parent", "\[LeftDoubleBracket]", "#", "\[RightDoubleBracket]"}], 
          "&"}], ",", " ", "i", ",", " ", 
         RowBox[{
          RowBox[{"#", "\[NotEqual]", " ", "a"}], "&"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"j2a", " ", "=", " ", 
       RowBox[{"NestWhileList", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
          "parent", "\[LeftDoubleBracket]", "#", "\[RightDoubleBracket]"}], 
          "&"}], ",", " ", "j", ",", " ", 
         RowBox[{
          RowBox[{"#", "\[NotEqual]", " ", "a"}], "&"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"Join", "[", 
       RowBox[{"i2a", ",", " ", 
        RowBox[{"Rest", "@", 
         RowBox[{"Reverse", "@", "j2a"}]}]}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{
  3.591667817527995*^9, 3.591668923825349*^9, {3.5916697599352307`*^9, 
   3.591669819815657*^9}, {3.5916698753458366`*^9, 3.5916698888766146`*^9}, {
   3.5916699961457586`*^9, 3.591669997476833*^9}, {3.59167068192603*^9, 
   3.59167070374928*^9}, {3.5917208858180676`*^9, 3.591720889380574*^9}, {
   3.5917221970292563`*^9, 3.591722203732394*^9}, {3.591722238732463*^9, 
   3.591722239091839*^9}, {3.591930526907305*^9, 3.5919305664205675`*^9}, {
   3.5919306118141713`*^9, 3.591930612108184*^9}, 3.591930660729968*^9, {
   3.591930696356006*^9, 3.5919307386704297`*^9}, {3.5919308258974266`*^9, 
   3.5919308840727587`*^9}, {3.591931024599806*^9, 3.591931025034828*^9}, {
   3.591931958433284*^9, 3.5919319593043294`*^9}, {3.5919331117973347`*^9, 
   3.5919331580109777`*^9}, {3.591933250024245*^9, 3.591933252427383*^9}, {
   3.591985667141246*^9, 3.5919857313879256`*^9}, {3.591987361798293*^9, 
   3.591987364276435*^9}, {3.5919978599754896`*^9, 3.59199787152915*^9}, 
   3.5919979113604307`*^9, {3.5919979589681625`*^9, 3.5919979727709627`*^9}, 
   3.5919982080554256`*^9, {3.5920191973504057`*^9, 3.592019234797552*^9}, {
   3.5921518015301204`*^9, 3.592151821661277*^9}, {3.5921518519500084`*^9, 
   3.5921518784545245`*^9}, {3.5921519174737606`*^9, 3.592151918642827*^9}, {
   3.5921519914750166`*^9, 3.5921519924810553`*^9}, 3.5921521161271386`*^9, {
   3.5921521472189164`*^9, 3.592152245920565*^9}, {3.5921524640720634`*^9, 
   3.5921524695633802`*^9}, {3.5921527028097334`*^9, 
   3.5921527107801905`*^9}, {3.59215278839163*^9, 3.592152817779317*^9}, 
   3.5921530282183657`*^9, {3.59215320443246*^9, 3.5921532065185785`*^9}, {
   3.5922519586863747`*^9, 3.592251999186454*^9}, {3.592254165862566*^9, 
   3.5922542064876456`*^9}, {3.5922558428788123`*^9, 
   3.5922558607708282`*^9}, {3.5922558957868533`*^9, 3.592255901201167*^9}, 
   3.592255970324107*^9, {3.5922580456873465`*^9, 3.592258045853349*^9}, {
   3.5922581158633614`*^9, 3.592258139375705*^9}, {3.592258226580702*^9, 
   3.592258231348975*^9}, {3.592258396619439*^9, 3.5922584020647693`*^9}, {
   3.592258438962861*^9, 3.592258459774053*^9}, {3.5922591760830736`*^9, 
   3.5922591855486183`*^9}, {3.592259257920762*^9, 3.5922592787549534`*^9}, {
   3.5922594413162627`*^9, 3.592259469596903*^9}, {3.592259570929685*^9, 
   3.5922595851425023`*^9}, {3.592259622531643*^9, 3.5922596920396233`*^9}, {
   3.5922597847129307`*^9, 3.59225978836014*^9}, {3.592265284603904*^9, 
   3.592265302772931*^9}, {3.5922660757641973`*^9, 3.592266168732519*^9}, {
   3.592266745226554*^9, 3.5922667453035393`*^9}, 3.5922667840087557`*^9, {
   3.592266872124799*^9, 3.592266894180065*^9}, {3.5922669756537285`*^9, 
   3.5922669960148973`*^9}, {3.5922671554480267`*^9, 
   3.5922672007746234`*^9}, {3.592267352764331*^9, 3.592267352851329*^9}, {
   3.5922673878293343`*^9, 3.5922674271685877`*^9}, {3.5922677518271804`*^9, 
   3.592267753864293*^9}, {3.592269365102566*^9, 3.5922693810894814`*^9}, {
   3.5922694704245977`*^9, 3.59226951552118*^9}, 3.592269559872718*^9, {
   3.592269596464834*^9, 3.592269605997359*^9}, {3.592269651011939*^9, 
   3.5922696511789675`*^9}, {3.592269686507972*^9, 3.59226972943143*^9}, {
   3.5922698283110924`*^9, 3.5922699566064405`*^9}, {3.5922700800495105`*^9, 
   3.592270104246894*^9}, {3.5922701343156166`*^9, 3.5922701411890078`*^9}, {
   3.5922701729868326`*^9, 3.592270182028349*^9}, {3.59227026813428*^9, 
   3.592270307654543*^9}, {3.592270789010106*^9, 3.592270804936021*^9}, {
   3.592271003227376*^9, 3.5922710164511337`*^9}, {3.5922710767405863`*^9, 
   3.592271096212701*^9}, {3.5922712492224765`*^9, 3.59227124969849*^9}, 
   3.5922713284640007`*^9, {3.592271377491807*^9, 3.5922713780178576`*^9}, {
   3.5922714086255894`*^9, 3.592271408733595*^9}, {3.5922714892252083`*^9, 
   3.592271557448115*^9}, {3.5922717878813114`*^9, 3.592271820858195*^9}, 
   3.5922718793635445`*^9, {3.592271916862694*^9, 3.592271917492734*^9}, {
   3.592271975838073*^9, 3.5922719809793663`*^9}, {3.5922721103467903`*^9, 
   3.592272167605055*^9}, {3.592272355126795*^9, 3.5922723559508424`*^9}, {
   3.592272387750682*^9, 3.592272430457106*^9}, {3.5922724624049335`*^9, 
   3.592272486586323*^9}, {3.592272554254202*^9, 3.5922725606365767`*^9}, {
   3.5922726000188184`*^9, 3.5922726042520723`*^9}, {3.592272771832677*^9, 
   3.5922727837953434`*^9}, {3.5922728195993934`*^9, 
   3.5922728631518846`*^9}, {3.5922729410483484`*^9, 
   3.5922729655267687`*^9}, {3.5922731177624674`*^9, 
   3.5922731543115797`*^9}, {3.592273310760521*^9, 3.5922734737338514`*^9}, {
   3.5922735108949947`*^9, 3.592273518410412*^9}, {3.5922735543504705`*^9, 
   3.59227358123601*^9}, {3.592273646181729*^9, 3.592273726257312*^9}, {
   3.5922737869537907`*^9, 3.5922738520135164`*^9}, {3.5922740041642246`*^9, 
   3.592274023666346*^9}, {3.592274258321784*^9, 3.5922742741106863`*^9}, {
   3.592274419230996*^9, 3.5922744193890047`*^9}, {3.59227448977404*^9, 
   3.5922745196417465`*^9}, {3.5922745553427935`*^9, 3.592274595237076*^9}, {
   3.592274638285543*^9, 3.5922746696913414`*^9}, {3.5922747972366467`*^9, 
   3.5922748309945784`*^9}, {3.592274966500351*^9, 3.592274991427766*^9}, {
   3.592275022895569*^9, 3.592275031693086*^9}, {3.5922750665360675`*^9, 
   3.5922752337196403`*^9}, {3.5922753371725636`*^9, 
   3.5922753612429485`*^9}, {3.592275404604432*^9, 3.592275406126515*^9}, {
   3.5922755649776125`*^9, 3.5922756207168036`*^9}, {3.5922758717241945`*^9, 
   3.5922758743503284`*^9}, {3.5922805198023577`*^9, 3.592280560296678*^9}, {
   3.592280648507742*^9, 3.592280653503023*^9}, {3.59228859193862*^9, 
   3.592288631802901*^9}, {3.5922886637607336`*^9, 3.592288669778076*^9}, {
   3.5922887474895287`*^9, 3.5922887482945967`*^9}, {3.592288778321295*^9, 
   3.5922887893069234`*^9}, {3.5922930252875032`*^9, 
   3.5922930261875534`*^9}, {3.59232216412803*^9, 3.5923221645760417`*^9}, {
   3.5923222141038747`*^9, 3.5923222146439095`*^9}, {3.592322303587002*^9, 
   3.5923223085062847`*^9}, {3.592322455802719*^9, 3.592322482674258*^9}, 
   3.592322568846193*^9, {3.592323716015887*^9, 3.5923238349947195`*^9}, {
   3.5923238811463437`*^9, 3.592323903579629*^9}, {3.592323947101121*^9, 
   3.592323958546775*^9}, 3.592325020905615*^9, 3.5923250924057074`*^9, {
   3.592325178768654*^9, 3.5923251847249947`*^9}, {3.592325509846614*^9, 
   3.592325579905626*^9}, {3.592325610773393*^9, 3.592325610986409*^9}, {
   3.5923256480075245`*^9, 3.592325653257824*^9}, {3.592326357953201*^9, 
   3.5923263611073627`*^9}, {3.5923264423020124`*^9, 
   3.5923264641812835`*^9}, {3.592326512038006*^9, 3.5923266042622867`*^9}, {
   3.5923266497838936`*^9, 3.59232674643143*^9}, {3.592326830500261*^9, 
   3.5923268797860622`*^9}, {3.5923269342291837`*^9, 
   3.5923269986578894`*^9}, {3.5923270362190285`*^9, 3.592327117486677*^9}, {
   3.5923272314232144`*^9, 3.5923272715754995`*^9}, {3.5923273065705056`*^9, 
   3.592327350989049*^9}, {3.5923274125735755`*^9, 3.592327418064891*^9}, {
   3.5923275140303864`*^9, 3.5923276062176657`*^9}, {3.5923276532933617`*^9, 
   3.592327654185412*^9}, {3.5923276926456146`*^9, 3.592327692772622*^9}, {
   3.5923277288566885`*^9, 3.592327904489751*^9}, {3.592327939983777*^9, 
   3.5923279946489096`*^9}, {3.5923280273017793`*^9, 
   3.5923280708432727`*^9}, {3.592328256381916*^9, 3.592328311494054*^9}, {
   3.592328377548837*^9, 3.5923283784428883`*^9}, {3.5923290216127205`*^9, 
   3.592329030903251*^9}, 3.5923293277412486`*^9, {3.5923294589187665`*^9, 
   3.5923294903285656`*^9}, {3.592329543190589*^9, 3.59232954460567*^9}, {
   3.5923295995248127`*^9, 3.5923297137353554`*^9}, {3.5923297507114735`*^9, 
   3.5923297799551473`*^9}, {3.5923298456749153`*^9, 
   3.5923298638739705`*^9}, {3.592329916913991*^9, 3.5923299180660534`*^9}, {
   3.5923300051120396`*^9, 3.592330006966149*^9}, {3.592330040054043*^9, 
   3.5923300669505844`*^9}, {3.592330118277522*^9, 3.592330208584695*^9}, {
   3.5923302807648277`*^9, 3.5923303462545786`*^9}, {3.5923307023329697`*^9, 
   3.59233075823417*^9}, 3.59233085839291*^9, {3.5923309133830557`*^9, 
   3.592330926128785*^9}, {3.5923309567205377`*^9, 3.59233098767231*^9}, {
   3.5923310282886353`*^9, 3.592331084900878*^9}, {3.5923312539095697`*^9, 
   3.5923312777179203`*^9}, {3.5923313996679215`*^9, 3.592331563625311*^9}, {
   3.5923316207045584`*^9, 3.5923316484191484`*^9}, {3.592331710373694*^9, 
   3.59233173455208*^9}, {3.592331766743924*^9, 3.592331818322875*^9}, {
   3.592331902011675*^9, 3.5923319996242604`*^9}, {3.5923320770106974`*^9, 
   3.5923321816526823`*^9}, {3.592332323052782*^9, 3.5923323245848713`*^9}, {
   3.5923323692014256`*^9, 3.5923324045414486`*^9}, {3.592332447873933*^9, 
   3.592332509325468*^9}, {3.592332544584469*^9, 3.592332612939383*^9}, {
   3.5923327382425585`*^9, 3.592332893818468*^9}, {3.592332937962996*^9, 
   3.5923329423152466`*^9}, {3.5923330114832063`*^9, 
   3.5923330471242476`*^9}, {3.592333090562735*^9, 3.5923331256457443`*^9}, {
   3.592333182797021*^9, 3.5923332001360097`*^9}, {3.5923333254841843`*^9, 
   3.5923333524377313`*^9}, {3.5923334143242755`*^9, 3.59233362061009*^9}, {
   3.592333653265959*^9, 3.592333655125065*^9}, {3.592333718847728*^9, 
   3.5923337979862437`*^9}, {3.592333836173434*^9, 3.5923338582126956`*^9}, {
   3.592334017578822*^9, 3.592334021541049*^9}, {3.5923340968783627`*^9, 
   3.592334161335054*^9}, {3.592334191952804*^9, 3.592334217431267*^9}, {
   3.5923345274470387`*^9, 3.592334642373602*^9}, {3.5923347077953486`*^9, 
   3.59233471623883*^9}, {3.592334765200636*^9, 3.592334767330758*^9}, {
   3.592335071649193*^9, 3.5923350768634834`*^9}, {3.5923356715045385`*^9, 
   3.592335680606055*^9}, {3.5923538222759776`*^9, 3.592353831584521*^9}, {
   3.592370916535984*^9, 3.5923709463356905`*^9}, {3.5923711734726973`*^9, 
   3.5923711932798505`*^9}, {3.5923716758344617`*^9, 3.592371686130056*^9}, {
   3.592371744953433*^9, 3.59237175434396*^9}, {3.592371797994459*^9, 
   3.5923718202977347`*^9}, {3.5923747656754103`*^9, 
   3.5923747663284464`*^9}, {3.592383856791027*^9, 3.5923838888468666`*^9}, {
   3.5925242672389746`*^9, 3.592524267779004*^9}, {3.5926274023654532`*^9, 
   3.592627408631096*^9}, {3.5926275824752035`*^9, 3.592627592350204*^9}, {
   3.592629248489919*^9, 3.592629249235964*^9}, {3.592666598963564*^9, 
   3.5926666238073626`*^9}, {3.5927480544837275`*^9, 3.592748086640041*^9}, {
   3.592748144796405*^9, 3.5927481617651877`*^9}, {3.5927573412623234`*^9, 
   3.5927574347756777`*^9}, {3.59275746746855*^9, 3.5927575284640436`*^9}, {
   3.592757602718296*^9, 3.592757738909095*^9}, {3.5927578052508936`*^9, 
   3.592757817615602*^9}, {3.5927579162412496`*^9, 3.5927579330742135`*^9}, {
   3.5927579847871747`*^9, 3.5927581240521483`*^9}, {3.5927583344062004`*^9, 
   3.5927583505581193`*^9}, 3.5927585361497507`*^9, {3.5927585961802025`*^9, 
   3.5927586271859827`*^9}, {3.592760178720814*^9, 3.5927601805439177`*^9}, {
   3.5927609618316603`*^9, 3.5927609624546967`*^9}, {3.592761705624259*^9, 
   3.5927617295366244`*^9}, {3.592761761840474*^9, 3.5927618444832067`*^9}, {
   3.5927618954711266`*^9, 3.5927618971682234`*^9}, 3.5927722880152674`*^9, 
   3.5927724400529785`*^9, 3.5927737486189156`*^9, {3.59278532976274*^9, 
   3.5927853310748105`*^9}, 3.592865011885339*^9, {3.592998251903042*^9, 
   3.5929982578093033`*^9}, {3.5930049819943275`*^9, 3.593005031978801*^9}, {
   3.593005091775792*^9, 3.593005112619583*^9}, {3.5933134779669466`*^9, 
   3.59331348117008*^9}, {3.5933135216232977`*^9, 3.5933135244045515`*^9}, {
   3.593973417214839*^9, 3.5939735067199636`*^9}, {3.593973769481007*^9, 
   3.5939737843378735`*^9}, {3.593973926281987*^9, 3.5939739276240625`*^9}, {
   3.593973963001085*^9, 3.593973963648127*^9}, {3.5962988837573338`*^9, 
   3.596298891054226*^9}, 3.602506267571031*^9, {3.6025063148457375`*^9, 
   3.602506402993786*^9}, {3.602506500207349*^9, 3.6025065026015034`*^9}, {
   3.602506611266713*^9, 3.602506621027272*^9}, {3.602509813708104*^9, 
   3.6025099441475735`*^9}, {3.6025099971836133`*^9, 
   3.6025101057698507`*^9}, {3.6025101538775997`*^9, 3.602510229888958*^9}, {
   3.602510285548126*^9, 3.6025103031511345`*^9}, 3.6025103712620354`*^9, {
   3.6025106022062607`*^9, 3.602510602658305*^9}, {3.602510656901393*^9, 
   3.60251070207498*^9}, {3.602510802510731*^9, 3.6025108054909024`*^9}, {
   3.6025121567533035`*^9, 3.602512157485327*^9}, {3.60251219992276*^9, 
   3.602512200076767*^9}, {3.602512281343419*^9, 3.6025123251379414`*^9}, 
   3.6025125282475586`*^9, {3.6025966892036605`*^9, 3.602596699266176*^9}, {
   3.6025967547975307`*^9, 3.6025968008601246`*^9}, {3.602596848282092*^9, 
   3.6025971048919706`*^9}, {3.6025971520639367`*^9, 3.602597153173314*^9}, {
   3.6025971908765125`*^9, 3.6025972346109724`*^9}, {3.6025972927985888`*^9, 
   3.602597342548684*^9}, {3.6025974649082985`*^9, 3.6025976055804496`*^9}, {
   3.6025976636274366`*^9, 3.602597667002463*^9}, 3.6025977256588087`*^9, {
   3.6025978610965734`*^9, 3.6025978702215953`*^9}, {3.6025979252217007`*^9, 
   3.602597925846697*^9}, {3.602617382638736*^9, 3.602617385560906*^9}, {
   3.602617653775265*^9, 3.6026176554283595`*^9}, {3.6029523465110755`*^9, 
   3.6029524321529803`*^9}, {3.602952477023546*^9, 3.6029525481266174`*^9}, {
   3.602952585175739*^9, 3.6029527691302776`*^9}, {3.6029529444623194`*^9, 
   3.6029529847096233`*^9}, {3.6029530168964667`*^9, 
   3.6029530434289865`*^9}, {3.6029531722483597`*^9, 
   3.6029532409792995`*^9}, {3.6029533074591055`*^9, 3.602953361388194*^9}, {
   3.6029534057507305`*^9, 3.602953429736112*^9}, {3.6029535698391314`*^9, 
   3.602953571048201*^9}, {3.602953642985321*^9, 3.6029537167455444`*^9}, {
   3.6029541173585005`*^9, 3.602954121300716*^9}, {3.602954377371375*^9, 
   3.602954378678451*^9}, 3.602954652728149*^9, {3.6029546972957115`*^9, 
   3.602954698771778*^9}, {3.6029547301385784`*^9, 3.602954744615408*^9}, {
   3.602954899802294*^9, 3.60295491549119*^9}, {3.602955301105277*^9, 
   3.602955319944354*^9}, {3.6029555879787035`*^9, 3.602955588589757*^9}, {
   3.602955897617435*^9, 3.602955907039975*^9}, {3.60295600858179*^9, 
   3.602956018622365*^9}, {3.6029561243724213`*^9, 3.6029561266775503`*^9}, 
   3.6029563218817315`*^9, {3.6029563673443346`*^9, 3.6029564084766865`*^9}, {
   3.6029564517091703`*^9, 3.6029564699192095`*^9}, {3.6029565033221188`*^9, 
   3.6029565072423477`*^9}, {3.6029567736456065`*^9, 
   3.6029567782808685`*^9}, {3.602956831387929*^9, 3.6029568782775946`*^9}, {
   3.602956916415781*^9, 3.6029569226721363`*^9}, {3.6029569843666706`*^9, 
   3.602957001643659*^9}, {3.6029573658195143`*^9, 3.6029573717038517`*^9}, {
   3.602957476031826*^9, 3.60295747646585*^9}, 3.6029575386804132`*^9, {
   3.6029587364290037`*^9, 3.602958742506352*^9}, {3.602958783710713*^9, 
   3.6029587991195946`*^9}, {3.6029588820713444`*^9, 
   3.6029589062437325`*^9}, {3.6029589412967367`*^9, 
   3.6029590180841336`*^9}, {3.6029590560793095`*^9, 3.602959106976224*^9}, {
   3.602959217108531*^9, 3.6029592766829467`*^9}, {3.6029595178287525`*^9, 
   3.6029595632373533`*^9}, {3.602959761513707*^9, 3.602959803309101*^9}, {
   3.6029598473936253`*^9, 3.6029598686178412`*^9}, {3.6029599010917015`*^9, 
   3.602959950482529*^9}, {3.6029600302720985`*^9, 3.6029600303581038`*^9}, {
   3.602960850203639*^9, 3.6029608518447523`*^9}, {3.602960903631263*^9, 
   3.6029609256385264`*^9}, {3.602960968222962*^9, 3.6029609699570785`*^9}, {
   3.6029612888623233`*^9, 3.60296131552185*^9}, {3.6029618183656454`*^9, 
   3.6029618947290196`*^9}, {3.6029619730715046`*^9, 3.602962028017649*^9}, {
   3.6029625562919044`*^9, 3.6029626014205017`*^9}, {3.602962631990238*^9, 
   3.602962639976696*^9}, {3.60296272822775*^9, 3.602962799688843*^9}, {
   3.6029628535869255`*^9, 3.6029628841596932`*^9}, {3.6029629919988556`*^9, 
   3.6029630347893057`*^9}, {3.602963137118165*^9, 3.6029631564672747`*^9}, {
   3.60296321960389*^9, 3.602963219675894*^9}, {3.60296328509064*^9, 
   3.6029633169344635`*^9}, {3.6029635775603895`*^9, 3.602963582387665*^9}, {
   3.6029636540077667`*^9, 3.6029637102060027`*^9}, {3.602963759040806*^9, 
   3.6029637656941624`*^9}, {3.602963901903962*^9, 3.602963903123048*^9}, 
   3.6029639535339193`*^9, {3.6029640178896046`*^9, 3.602964060555048*^9}, {
   3.602964153937393*^9, 3.602964177311735*^9}, {3.602964217314025*^9, 
   3.6029642449776134`*^9}, {3.602964332434617*^9, 3.6029644393267393`*^9}, {
   3.6029645381954*^9, 3.602964541063565*^9}, {3.6029648000013933`*^9, 
   3.602964980560733*^9}, {3.602972116556387*^9, 3.602972128788083*^9}, {
   3.602972967100095*^9, 3.602972968268162*^9}, {3.6029737834128428`*^9, 
   3.6029738663145905`*^9}, {3.6029739256689887`*^9, 
   3.6029739324243765`*^9}, {3.6029739672423697`*^9, 3.602974020391432*^9}, 
   3.6029741064033346`*^9, 3.602974606913001*^9, {3.603245692484913*^9, 
   3.6032458066264677`*^9}, {3.6032460361925964`*^9, 3.60324608747753*^9}, {
   3.60324628115562*^9, 3.603246284855855*^9}, {3.603246343610201*^9, 
   3.603246372112834*^9}, {3.6032464222237053`*^9, 3.603246505115445*^9}, {
   3.6032467420050154`*^9, 3.6032467446061645`*^9}, {3.603248047280764*^9, 
   3.603248081244709*^9}, {3.6032481541118817`*^9, 3.6032481563040066`*^9}, {
   3.6032483709412994`*^9, 3.6032484012280307`*^9}, {3.6032484745502367`*^9, 
   3.6032484773493896`*^9}, {3.6032485276062703`*^9, 
   3.6032485326845617`*^9}, {3.603248754459262*^9, 3.603248755188302*^9}, {
   3.6032488600583086`*^9, 3.603248864841584*^9}, {3.6032493268680415`*^9, 
   3.6032493271940794`*^9}, {3.603249396643039*^9, 3.6032494081336956`*^9}, {
   3.6032496022218285`*^9, 3.603249664997405*^9}, {3.6032497423078365`*^9, 
   3.6032498828528943`*^9}, {3.6032499363879466`*^9, 3.603249940222164*^9}, {
   3.603250015505478*^9, 3.6032500208347826`*^9}, {3.6032500543217*^9, 
   3.6032500591239753`*^9}, 3.603250134109269*^9, {3.6032505617237544`*^9, 
   3.6032505760435734`*^9}, 3.6032518442672043`*^9, {3.6032525682936673`*^9, 
   3.6032525690497117`*^9}, {3.6032526569597445`*^9, 3.603252670753533*^9}, {
   3.6032527661949997`*^9, 3.6032527856381316`*^9}, {3.6032535116856456`*^9, 
   3.6032536768051147`*^9}, {3.6032537203075924`*^9, 
   3.6032538631327715`*^9}, {3.603253893347515*^9, 3.6032539212560997`*^9}, {
   3.603253957019148*^9, 3.6032539640205493`*^9}, {3.603254048824405*^9, 
   3.603254049812463*^9}, {3.6032540825973396`*^9, 3.6032541801589303`*^9}, {
   3.6032542495339*^9, 3.603254449149331*^9}, {3.603254574010481*^9, 
   3.6032546914142137`*^9}, {3.6032547367598147`*^9, 3.603254741613083*^9}, {
   3.603254856376651*^9, 3.6032549116348157`*^9}, {3.6032549468238306`*^9, 
   3.603255010237462*^9}, {3.603255087311874*^9, 3.6032552616288595`*^9}, {
   3.6032554106433926`*^9, 3.6032554165017405`*^9}, {3.603255463340411*^9, 
   3.6032554712538633`*^9}, {3.6032555055888295`*^9, 3.603255512901248*^9}, {
   3.6032559375845685`*^9, 3.6032559386066275`*^9}, {3.603255975896776*^9, 
   3.6032559764987965`*^9}, {3.6032560238935103`*^9, 3.603256028384774*^9}, {
   3.603256093071472*^9, 3.603256106045215*^9}, {3.603256218338646*^9, 
   3.603256287660616*^9}, {3.6032563220165834`*^9, 3.603256349674167*^9}, {
   3.603256448078806*^9, 3.6032565479715242`*^9}, {3.603256583766573*^9, 
   3.603256626610026*^9}, 3.603256682037201*^9, {3.6032568989846287`*^9, 
   3.6032569060370283`*^9}, {3.6032569908728857`*^9, 3.603257150121003*^9}, {
   3.6032571807877617`*^9, 3.60325718147482*^9}, {3.603257277423296*^9, 
   3.6032572913990965`*^9}, {3.6032573548837323`*^9, 
   3.6032574131450663`*^9}, {3.6032574999990425`*^9, 3.603257500795085*^9}, 
   3.603257609387311*^9, {3.6032576652945085`*^9, 3.6032577259679823`*^9}, {
   3.6032578000962253`*^9, 3.6032578206904078`*^9}, {3.603257852050203*^9, 
   3.603257858170554*^9}, {3.603258071757799*^9, 3.6032580968102193`*^9}, {
   3.603258157351688*^9, 3.6032582259036136`*^9}, {3.60325828771115*^9, 
   3.603258289722267*^9}, {3.6032583209700565`*^9, 3.6032583222521296`*^9}, {
   3.603258461536106*^9, 3.6032585323561587`*^9}, {3.6032585966808453`*^9, 
   3.60325859691687*^9}, {3.6032587630793743`*^9, 3.603258768451683*^9}, {
   3.6032846406756654`*^9, 3.603284685397222*^9}, {3.6032847293527393`*^9, 
   3.603284883592572*^9}, {3.6032849340884647`*^9, 3.6032849843163557`*^9}, {
   3.6032852674165525`*^9, 3.6032852687296305`*^9}, {3.603285841034401*^9, 
   3.6032858605605183`*^9}, {3.6032861150190916`*^9, 
   3.6032861194823465`*^9}, {3.6032873247603693`*^9, 
   3.6032873357559986`*^9}, {3.603287388440016*^9, 3.6032874103162656`*^9}, {
   3.6032875693603764`*^9, 3.6032876738203597`*^9}, {3.6032877262293596`*^9, 
   3.6032877309496303`*^9}, {3.6032878998673034`*^9, 
   3.6032879372374434`*^9}, {3.603287979183843*^9, 3.6032880413194036`*^9}, {
   3.603288542142084*^9, 3.6032885423080935`*^9}, {3.6032886050996895`*^9, 
   3.6032886185114756`*^9}, {3.603288670735448*^9, 3.603288720492298*^9}, {
   3.6032887634377565`*^9, 3.6032888261983643`*^9}, {3.6032888818225546`*^9, 
   3.603288914965434*^9}, 3.6032889496064186`*^9, {3.603289299666465*^9, 
   3.603289313396264*^9}, {3.603289497849814*^9, 3.6032896594460683`*^9}, {
   3.6032899980764565`*^9, 3.6032900032847548`*^9}, {3.603290297697619*^9, 
   3.6032903042870097`*^9}, {3.603290371819865*^9, 3.6032903739049826`*^9}, {
   3.6032904088649845`*^9, 3.6032904096650305`*^9}, {3.603290506322566*^9, 
   3.6032905067515907`*^9}, {3.6032906151338153`*^9, 
   3.6032906422593503`*^9}, {3.603290685921847*^9, 3.603290702549803*^9}, {
   3.603290802969554*^9, 3.6032908193494916`*^9}, {3.603291006146187*^9, 
   3.603291006584214*^9}, {3.6032912576735935`*^9, 3.6032912717023964`*^9}, {
   3.603291968372297*^9, 3.6032920285237403`*^9}, {3.603292116445772*^9, 
   3.603292202311689*^9}, {3.603292248306323*^9, 3.6032922528245955`*^9}, {
   3.6032923021274056`*^9, 3.6032923595886965`*^9}, 3.603292438155197*^9, {
   3.6032927104928055`*^9, 3.603292789137295*^9}, {3.6032928523099127`*^9, 
   3.603292896129423*^9}, {3.6032929370427647`*^9, 3.6032931291307683`*^9}, {
   3.6032942520500846`*^9, 3.603294286420039*^9}, {3.6032946668958273`*^9, 
   3.6032946699140005`*^9}, {3.603294761375238*^9, 3.6032947749160323`*^9}, {
   3.6032948108020678`*^9, 3.6032948569947157`*^9}, {3.6032952684642773`*^9, 
   3.603295268579298*^9}, {3.6032954313396044`*^9, 3.603295431833633*^9}, {
   3.603295567511403*^9, 3.6032956118319407`*^9}, {3.6032956515612173`*^9, 
   3.60329565322733*^9}, {3.6032957343709574`*^9, 3.603295750193864*^9}, 
   3.603296008958683*^9, {3.603296362999958*^9, 3.6032963894864883`*^9}, {
   3.603296738414456*^9, 3.603296738866482*^9}, {3.6032967832540293`*^9, 
   3.603296808660495*^9}, {3.603296902867874*^9, 3.6032969204548817`*^9}, {
   3.603297008364916*^9, 3.603297011456106*^9}, {3.603297369470595*^9, 
   3.6032973866935997`*^9}, {3.603297418610409*^9, 3.6032974341793003`*^9}, {
   3.6032974700023527`*^9, 3.603297540570393*^9}, {3.6032975881211176`*^9, 
   3.6032975946934967`*^9}, {3.6032985302240667`*^9, 
   3.6032985308131003`*^9}, {3.6032985696983275`*^9, 3.603298624861487*^9}, {
   3.6032986558232594`*^9, 3.6032986584484096`*^9}, {3.603298692216344*^9, 
   3.60329869362342*^9}, {3.603298749265629*^9, 3.603298750268668*^9}, {
   3.603298853652589*^9, 3.603298902482386*^9}, {3.603301357722988*^9, 
   3.6033013883927574`*^9}, {3.603302380462552*^9, 3.6033023810095882`*^9}, {
   3.6033027906450467`*^9, 3.6033027963733916`*^9}, {3.6033036885004635`*^9, 
   3.6033037291127853`*^9}, {3.603303786267062*^9, 3.603303792990466*^9}, {
   3.603303964662278*^9, 3.603303973814803*^9}, {3.603304748163147*^9, 
   3.6033047678362923`*^9}, {3.6033048101987*^9, 3.60330488116777*^9}, {
   3.60330494571546*^9, 3.6033049988005133`*^9}, {3.6033050700585804`*^9, 
   3.6033050898367324`*^9}, {3.6033051749455876`*^9, 3.603305176006648*^9}, {
   3.6033053199388905`*^9, 3.603305320111904*^9}, {3.603305367063589*^9, 
   3.6033053682416525`*^9}, {3.603305436520567*^9, 3.603305563685853*^9}, {
   3.6033056687158637`*^9, 3.6033057012717285`*^9}, {3.603305799075328*^9, 
   3.6033059700671177`*^9}, {3.603306093992218*^9, 3.60330618588148*^9}, {
   3.6033062261877885`*^9, 3.603306317478017*^9}, {3.603306575325782*^9, 
   3.6033065818481555`*^9}, {3.6033074196511335`*^9, 
   3.6033074258784904`*^9}, {3.6033074765343914`*^9, 3.603307478034477*^9}, {
   3.6033076977720613`*^9, 3.603307722296465*^9}, {3.6033077546963205`*^9, 
   3.603307758020512*^9}, 3.6033077909413967`*^9, {3.6033078367800226`*^9, 
   3.603307905480956*^9}, {3.6033079390488777`*^9, 3.6033080138931637`*^9}, {
   3.6033080440448914`*^9, 3.6033080868503604`*^9}, 3.603308377418982*^9, {
   3.6033085085554914`*^9, 3.6033085160009193`*^9}, {3.603308600155737*^9, 
   3.6033086046279926`*^9}, 3.6033086458463535`*^9, 3.603308687436735*^9, {
   3.6033088336161313`*^9, 3.603308842328619*^9}, {3.6033097947821493`*^9, 
   3.6033098497022953`*^9}, 3.6033099395144377`*^9, {3.603310008917412*^9, 
   3.603310010387515*^9}, {3.603310081882591*^9, 3.6033100868458757`*^9}, {
   3.603310205408668*^9, 3.6033102149662113`*^9}, {3.6033103853269653`*^9, 
   3.603310386032008*^9}, {3.6033104200479555`*^9, 3.6033104232321386`*^9}, {
   3.6033104833895874`*^9, 3.603310505232835*^9}, {3.60331055386862*^9, 
   3.603310582248245*^9}, {3.6033106197713904`*^9, 3.6033107380181665`*^9}, 
   3.6033107997687006`*^9, {3.6033108882117853`*^9, 3.6033108963042297`*^9}, {
   3.603310928924097*^9, 3.603310930890229*^9}, {3.603310965921216*^9, 
   3.6033109972410097`*^9}, {3.6033114297627788`*^9, 
   3.6033114411114473`*^9}, {3.6033115169937744`*^9, 3.603311546219448*^9}, {
   3.603311633315436*^9, 3.6033117542693653`*^9}, {3.6033118871129704`*^9, 
   3.603311924500112*^9}, {3.603311976363081*^9, 3.6033119931780434`*^9}, {
   3.6033120251878767`*^9, 3.603312054168536*^9}, {3.6033120912806616`*^9, 
   3.6033120947818623`*^9}, {3.6033124645110393`*^9, 3.603312503861289*^9}, {
   3.6033125955745406`*^9, 3.6033126328076916`*^9}, {3.6033127131932735`*^9, 
   3.603312713840314*^9}, {3.6033164122675548`*^9, 3.603316476400231*^9}, {
   3.6033165725467334`*^9, 3.603316624776725*^9}, {3.603316761685566*^9, 
   3.6033167618265705`*^9}, {3.6033168069691577`*^9, 3.6033168076981993`*^9}, 
   3.603316839609027*^9, {3.6033168722198944`*^9, 3.6033168848036194`*^9}, {
   3.60331693640357*^9, 3.6033169893296013`*^9}, {3.6033170336731405`*^9, 
   3.603317131134719*^9}, {3.603317216726621*^9, 3.603317294979105*^9}, {
   3.6033178406633544`*^9, 3.6033178453866234`*^9}, {3.603318152152191*^9, 
   3.603318178770712*^9}, {3.603318246037572*^9, 3.603318248846733*^9}, {
   3.6033183421740775`*^9, 3.6033183454112587`*^9}, {3.6033183842974896`*^9, 
   3.603318391585903*^9}, {3.6033185422915335`*^9, 3.603318675357154*^9}, {
   3.6033188304790373`*^9, 3.6033188370864344`*^9}, {3.603318949408848*^9, 
   3.6033189502938986`*^9}, 3.6033189850708904`*^9, 3.603319071397834*^9, {
   3.603319112749202*^9, 3.603319116247405*^9}, {3.6033191550946226`*^9, 
   3.603319159997907*^9}, {3.603319199092144*^9, 3.603319254259305*^9}, 
   3.6033193649726458`*^9, {3.6033194726208115`*^9, 3.6033194784071417`*^9}, {
   3.6033195508032875`*^9, 3.603319559508787*^9}, {3.603319942125701*^9, 
   3.6033200227383175`*^9}, {3.603320296074967*^9, 3.603320319741322*^9}, {
   3.603320414811767*^9, 3.6033204160888395`*^9}, {3.6033205293993287`*^9, 
   3.603320529731349*^9}, {3.6033207340260468`*^9, 3.6033207490989137`*^9}, {
   3.603320851225758*^9, 3.603321017137257*^9}, {3.603321100747048*^9, 
   3.6033211281196156`*^9}, {3.603321211839409*^9, 3.6033212484355054`*^9}, {
   3.603321354619586*^9, 3.6033213566227016`*^9}, {3.603322227606579*^9, 
   3.603322235408044*^9}, {3.6033222764313745`*^9, 3.6033223038369627`*^9}, {
   3.603322364237405*^9, 3.603322557542474*^9}, {3.603322788504716*^9, 
   3.6033228305961103`*^9}, {3.603322868050255*^9, 3.6033229053173904`*^9}, {
   3.6033230580691366`*^9, 3.6033231881915903`*^9}, {3.6033461160300274`*^9, 
   3.60334617123326*^9}, {3.6033777584318285`*^9, 3.6033778231545343`*^9}, {
   3.6033778771106267`*^9, 3.603377950254817*^9}, {3.6033780800562644`*^9, 
   3.60337809176992*^9}, {3.603490401867557*^9, 3.6034904309769897`*^9}, {
   3.6034904619458*^9, 3.6034904650239325`*^9}, {3.6034906637430696`*^9, 
   3.6034906687430787`*^9}, {3.603490731415082*^9, 3.603490750805759*^9}, {
   3.603490994712467*^9, 3.6034909999312468`*^9}, {3.603491063931353*^9, 
   3.6034910944470367`*^9}, {3.603491132712737*^9, 3.6034911447440143`*^9}, {
   3.6034911933378563`*^9, 3.6034911946659875`*^9}, {3.603491309088085*^9, 
   3.603491309650584*^9}, 3.60350665225144*^9, {3.603506727501587*^9, 
   3.6035067420328655`*^9}, {3.603506787767331*^9, 3.603506791923588*^9}, {
   3.603567322012684*^9, 3.6035673484658613`*^9}, {3.6035674294035206`*^9, 
   3.6035674299191446`*^9}, {3.603567666653983*^9, 3.6035676817946405`*^9}, {
   3.6035797542839475`*^9, 3.6035798214247*^9}, {3.603581621240738*^9, 
   3.603581662022049*^9}, {3.6035818160067253`*^9, 3.603581818350479*^9}, {
   3.603581862741192*^9, 3.6035818978818865`*^9}, {3.603581947303857*^9, 
   3.6035820028039646`*^9}, {3.6035821437886257`*^9, 3.603582261679471*^9}, {
   3.603582311492073*^9, 3.6035824621954927`*^9}, {3.6035826070395226`*^9, 
   3.603582617320792*^9}, 3.6035826486489983`*^9, {3.603582698774077*^9, 
   3.6035827067115917`*^9}, {3.60358882875681*^9, 3.6035888290878286`*^9}, {
   3.603602648986827*^9, 3.6036026526730366`*^9}, {3.6036086241460047`*^9, 
   3.6036086678215065`*^9}, {3.603649460520569*^9, 3.603649518508894*^9}, {
   3.6041964678164263`*^9, 3.6041964690075006`*^9}, {3.6041965175212746`*^9, 
   3.604196518536333*^9}, {3.6041965746735477`*^9, 3.6041966013780775`*^9}, {
   3.604765832080041*^9, 3.604765857809517*^9}, {3.604765896962761*^9, 
   3.604765924525335*^9}, {3.6152091584160957`*^9, 3.615209158525474*^9}, {
   3.6153202758675003`*^9, 3.61532031985194*^9}, {3.615320353586384*^9, 
   3.6153204819928875`*^9}, {3.6153205420711327`*^9, 
   3.6153205622274213`*^9}, {3.615320729993369*^9, 3.6153207365246334`*^9}, {
   3.615320779805983*^9, 3.6153208983687015`*^9}, 3.61532106904091*^9, {
   3.6153212830725794`*^9, 3.6153212925101123`*^9}, {3.615324220359584*^9, 
   3.615324233562726*^9}, {3.6159914512518625`*^9, 3.6159914645946455`*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Spatial functions", "Section",
 CellChangeTimes->{{3.5914870039053636`*^9, 3.591487004222381*^9}, {
  3.5916678891560974`*^9, 3.5916678898031635`*^9}, {3.5922559886651573`*^9, 
  3.592256014246619*^9}, {3.615324296500348*^9, 3.6153243339535465`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"qmap", "::", "nb"}], " ", "=", " ", 
   "\"\<`1` is not a valid body number; bodies 1...`2` are valid.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"qmap", "::", "dof"}], " ", "=", " ", 
   "\"\<Invalid index `1` for body `2`; the body only has `3` degrees of \
freedom.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"qmap", "[", 
     RowBox[{"i_", ",", " ", "j_"}], "]"}], " ", ":=", " ", 
    RowBox[{"Which", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"!", 
       RowBox[{"(", 
        RowBox[{"0", "<", "i", "\[LessEqual]", "nb"}], ")"}]}], ",", " ", 
      RowBox[{"Message", "[", 
       RowBox[{
        RowBox[{"qmap", "::", "nb"}], ",", " ", "i", ",", " ", "nb"}], "]"}], 
      ",", " ", "\[IndentingNewLine]", 
      RowBox[{"!", 
       RowBox[{"(", 
        RowBox[{"0", "<", 
         RowBox[{"Abs", "[", "j", "]"}], " ", "\[LessEqual]", " ", 
         RowBox[{
         "ni", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}], 
        ")"}]}], ",", " ", 
      RowBox[{"Message", "[", 
       RowBox[{
        RowBox[{"qmap", "::", "dof"}], ",", " ", "j", ",", " ", "i", ",", " ", 
        RowBox[{
        "ni", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}], "]"}],
       ",", "\[IndentingNewLine]", 
      RowBox[{"j", " ", ">", " ", "0"}], ",", " ", 
      RowBox[{
       RowBox[{"map", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
       "+", "j", " ", "-", " ", 
       RowBox[{"ni", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}],
       ",", "\[IndentingNewLine]", "True", " ", 
      RowBox[{"(*", 
       RowBox[{"j", " ", "<", " ", "0"}], "*)"}], ",", " ", 
      RowBox[{
       RowBox[{"map", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
       "+", "j", " ", "+", " ", "1"}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"pmap", "::", "np"}], " ", "=", " ", 
   "\"\<`1` is not a valid parameter number; parameters 1...`2` are \
valid.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"pmap", "[", "i_", "]"}], " ", ":=", " ", 
    RowBox[{"Which", "[", 
     RowBox[{
      RowBox[{"0", "<", "i", " ", "\[LessEqual]", " ", "np"}], ",", " ", 
      RowBox[{"nx", "+", "i"}], ",", " ", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"-", "np"}], " ", "\[LessEqual]", " ", "i", " ", "<", " ", 
       "0"}], ",", " ", 
      RowBox[{"nc", " ", "+", " ", "i", " ", "+", " ", "1"}], ",", 
      "\[IndentingNewLine]", "True", ",", " ", 
      RowBox[{"Message", "[", 
       RowBox[{
        RowBox[{"pmap", "::", "np"}], ",", " ", "i", ",", " ", "np"}], 
       "]"}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"MakeFunction", ",", " ", "HoldAll"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MakeFunction", "[", "fbody_", "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "q", ",", " ", "qd", ",", " ", "p", ",", " ", "pd", ",", " ", "s", ",",
         " ", "ds", ",", " ", "sdot", ",", " ", "dsdot", ",", " ", "x", ",", 
        " ", "dx", ",", " ", "qind", ",", " ", "pind", ",", " ", "f"}], "}"}],
       ",", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"turn", " ", "off", " ", "known", " ", "messages"}], " ", 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Off", "[", 
        RowBox[{
         RowBox[{"Part", "::", "partw"}], ",", " ", 
         RowBox[{"Part", "::", "partd"}]}], "]"}], ";", "\[IndentingNewLine]",
        "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
        "map", " ", "parent0", " ", "to", " ", "parent", " ", "joint", " ", 
         "#", "s"}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"s", ",", " ", 
          RowBox[{"{", 
           RowBox[{"qind", ",", " ", "pind"}], "}"}]}], "}"}], " ", "=", " ", 
        RowBox[{"Check", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Reap", "[", "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{"Trott", "-", 
             RowBox[{"Strzebonski", " ", "method", " ", "for", " ", "In"}], 
             "-", 
             RowBox[{"Place", " ", "Evaluation"}]}], " ", "*)"}], 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"fbody", " ", "/.", " ", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"HoldPattern", "[", 
                 RowBox[{"\[DoubleStruckQ]", "[", 
                  RowBox[{"i_Integer", ",", " ", "j_Integer"}], "]"}], "]"}], 
                "\[RuleDelayed]", " ", 
                RowBox[{"With", "[", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"k", " ", "=", " ", 
                    RowBox[{"qmap", "[", 
                    RowBox[{"i", ",", "j"}], "]"}]}], "}"}], ",", " ", 
                  RowBox[{
                   RowBox[{"x", "\[LeftDoubleBracket]", 
                    RowBox[{"Sow", "[", 
                    RowBox[{"k", ",", " ", "\[DoubleStruckQ]"}], "]"}], 
                    "\[RightDoubleBracket]"}], " ", "/;", " ", "True"}]}], 
                 "]"}]}], ",", "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{"HoldPattern", "[", 
                 RowBox[{"\[DoubleStruckP]", "[", "i_Integer", "]"}], "]"}], 
                "\[RuleDelayed]", " ", 
                RowBox[{"With", "[", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"k", " ", "=", " ", 
                    RowBox[{"pmap", "[", "i", "]"}]}], "}"}], ",", " ", 
                  RowBox[{
                   RowBox[{"x", "\[LeftDoubleBracket]", 
                    RowBox[{"Sow", "[", 
                    RowBox[{"k", ",", " ", "\[DoubleStruckP]"}], "]"}], 
                    "\[RightDoubleBracket]"}], " ", "/;", " ", "True"}]}], 
                 "]"}]}]}], "}"}]}], ",", "\[IndentingNewLine]", 
            RowBox[{"{", 
             RowBox[{"\[DoubleStruckQ]", ",", " ", "\[DoubleStruckP]"}], 
             "}"}]}], "]"}], ",", " ", "\[IndentingNewLine]", 
          RowBox[{"Throw", "[", "$Failed", "]"}]}], "\[IndentingNewLine]", 
         "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"Length", "[", "qind", "]"}], " ", "+", " ", 
           RowBox[{"Length", "[", "pind", "]"}]}], " ", "\[Equal]", " ", 
          "0"}], ",", " ", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{"argument", " ", "is", " ", "a", " ", "constant"}], " ", 
          "*)"}], "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"qind", " ", "=", " ", 
           RowBox[{"Dimensions", "[", "s", "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"sdot", " ", "=", " ", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"0", ",", " ", "qind"}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"nd", " ", ">", " ", "0"}], ",", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"qind", " ", "=", " ", 
              RowBox[{"Append", "[", 
               RowBox[{"qind", ",", " ", "nd"}], "]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"ds", " ", "=", " ", 
              RowBox[{"ConstantArray", "[", 
               RowBox[{"0", ",", " ", "qind"}], "]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"dsdot", " ", "=", " ", 
              RowBox[{"ConstantArray", "[", 
               RowBox[{"0", ",", " ", "qind"}], "]"}]}], ";"}]}], 
           "\[IndentingNewLine]", "]"}], ";"}], ",", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{"else", " ", "compute", " ", "derivatives"}], " ", "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"{", 
            RowBox[{"q", ",", " ", "qd"}], "}"}], " ", "=", " ", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Length", "[", "qind", "]"}], " ", ">", " ", "0"}], ",",
              "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"qind", " ", "=", " ", 
               RowBox[{"Sort", "[", 
                RowBox[{"DeleteDuplicates", "[", 
                 RowBox[{
                 "qind", "\[LeftDoubleBracket]", "1", 
                  "\[RightDoubleBracket]"}], "]"}], "]"}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{
                    "x", "\[LeftDoubleBracket]", "#", 
                    "\[RightDoubleBracket]"}], ",", " ", 
                    RowBox[{"x", "\[LeftDoubleBracket]", 
                    RowBox[{"nq", "+", "#"}], "\[RightDoubleBracket]"}]}], 
                   "}"}], "&"}], " ", "/@", " ", "qind"}], ")"}], 
               "\[Transpose]"}]}], ",", "\[IndentingNewLine]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"{", "}"}], ",", " ", 
               RowBox[{"{", "}"}]}], "}"}]}], "\[IndentingNewLine]", "]"}]}], 
          ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"p", ",", " ", "pd"}], "}"}], " ", "=", " ", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Length", "[", "pind", "]"}], " ", ">", " ", "0"}], ",",
              "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"pind", " ", "=", " ", 
               RowBox[{"Sort", "[", 
                RowBox[{"DeleteDuplicates", "[", 
                 RowBox[{
                 "pind", "\[LeftDoubleBracket]", "1", 
                  "\[RightDoubleBracket]"}], "]"}], "]"}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{
                    "x", "\[LeftDoubleBracket]", "#", 
                    "\[RightDoubleBracket]"}], ",", " ", "0"}], "}"}], "&"}], 
                 " ", "/@", " ", "pind"}], ")"}], "\[Transpose]"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"{", "}"}], ",", " ", 
               RowBox[{"{", "}"}]}], "}"}]}], "\[IndentingNewLine]", "]"}]}], 
          ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"ds", " ", "=", " ", 
           RowBox[{"D", "[", 
            RowBox[{"s", ",", " ", 
             RowBox[{"{", 
              RowBox[{"Join", "[", 
               RowBox[{"q", ",", " ", "p"}], "]"}], "}"}]}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"sdot", " ", "=", " ", 
           RowBox[{"ds", ".", 
            RowBox[{"Join", "[", 
             RowBox[{"qd", ",", " ", "pd"}], "]"}]}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"dsdot", " ", "=", " ", 
           RowBox[{"D", "[", 
            RowBox[{"sdot", ",", " ", 
             RowBox[{"{", 
              RowBox[{"Join", "[", 
               RowBox[{"q", ",", " ", "qd", ",", " ", "p"}], "]"}], "}"}]}], 
            "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"nd", " ", ">", " ", "0"}], ",", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"f", " ", "=", " ", 
              RowBox[{"Length", "[", "qind", "]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"q", " ", "=", " ", 
              RowBox[{"Array", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"dx", "\[LeftDoubleBracket]", 
                  RowBox[{
                   RowBox[{
                   "qind", "\[LeftDoubleBracket]", "#1", 
                    "\[RightDoubleBracket]"}], ",", "#2"}], 
                  "\[RightDoubleBracket]"}], "&"}], ",", " ", 
                RowBox[{"{", 
                 RowBox[{"f", ",", " ", "nd"}], "}"}]}], "]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"qd", " ", "=", " ", 
              RowBox[{"Array", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"dx", "\[LeftDoubleBracket]", 
                  RowBox[{
                   RowBox[{"nq", "+", 
                    RowBox[{
                    "qind", "\[LeftDoubleBracket]", "#1", 
                    "\[RightDoubleBracket]"}]}], ",", "#2"}], 
                  "\[RightDoubleBracket]"}], "&"}], ",", " ", 
                RowBox[{"{", 
                 RowBox[{"f", ",", " ", "nd"}], "}"}]}], "]"}]}], ";", 
             "\[IndentingNewLine]", "\[IndentingNewLine]", 
             RowBox[{"f", " ", "=", " ", 
              RowBox[{"Length", "[", "pind", "]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"p", " ", "=", " ", 
              RowBox[{"Array", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"dx", "\[LeftDoubleBracket]", 
                  RowBox[{
                   RowBox[{
                   "pind", "\[LeftDoubleBracket]", "#1", 
                    "\[RightDoubleBracket]"}], ",", "#2"}], 
                  "\[RightDoubleBracket]"}], "&"}], ",", " ", 
                RowBox[{"{", 
                 RowBox[{"f", ",", " ", "nd"}], "}"}]}], "]"}]}], ";", 
             "\[IndentingNewLine]", "\[IndentingNewLine]", 
             RowBox[{"ds", " ", "=", " ", 
              RowBox[{"ds", ".", 
               RowBox[{"Join", "[", 
                RowBox[{"q", ",", " ", "p"}], "]"}]}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"dsdot", " ", "=", " ", 
              RowBox[{"dsdot", ".", 
               RowBox[{"Join", "[", 
                RowBox[{"q", ",", " ", "qd", ",", " ", "p"}], "]"}]}]}], 
             ";"}]}], "\[IndentingNewLine]", "]"}], ";"}]}], 
        "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"f", " ", "=", " ", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"nd", " ", ">", " ", "0"}], ",", " ", 
          RowBox[{"{", 
           RowBox[{"s", ",", " ", "sdot", ",", " ", "ds", ",", " ", "dsdot"}],
            "}"}], ",", " ", 
          RowBox[{"{", 
           RowBox[{"s", ",", " ", "sdot"}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"On", "[", 
        RowBox[{
         RowBox[{"Part", "::", "partw"}], ",", " ", 
         RowBox[{"Part", "::", "partd"}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{"Function", " ", "/@", " ", "f"}], ")"}], " ", "/.", " ", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"x", "\[Rule]", " ", "#1"}], ",", " ", 
          RowBox[{"dx", "\[Rule]", " ", "#2"}]}], "}"}]}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"MakeFunction", "[", "fbody_", "]"}], " ", ":=", " ", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "q", ",", " ", "qd", ",", " ", "s", ",", " ", "ds", ",", " ", "sdot", 
         ",", " ", "dsdot", ",", " ", "x", ",", " ", "dx", ",", " ", "ind", 
         ",", " ", "f"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"turn", " ", "off", " ", "known", " ", "messages"}], " ", 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Off", "[", 
         RowBox[{
          RowBox[{"Part", "::", "partw"}], ",", " ", 
          RowBox[{"Part", "::", "partd"}]}], "]"}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "map", " ", "parent0", " ", "to", " ", "parent", " ", "joint", " ", 
          "#", "s"}], " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"s", ",", " ", "ind"}], "}"}], " ", "=", " ", 
         RowBox[{"Check", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Reap", "[", "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{"Trott", "-", 
              RowBox[{"Strzebonski", " ", "method", " ", "for", " ", "In"}], 
              "-", 
              RowBox[{"Place", " ", "Evaluation"}]}], " ", "*)"}], 
            "\[IndentingNewLine]", 
            RowBox[{"fbody", " ", "/.", " ", 
             RowBox[{
              RowBox[{"HoldPattern", "[", 
               RowBox[{"\[DoubleStruckQ]", "[", 
                RowBox[{"i_Integer", ",", " ", "j_Integer"}], "]"}], "]"}], 
              "\[RuleDelayed]", " ", 
              RowBox[{"With", "[", 
               RowBox[{
                RowBox[{"{", 
                 RowBox[{"k", " ", "=", " ", 
                  RowBox[{"qmap", "[", 
                   RowBox[{"i", ",", "j"}], "]"}]}], "}"}], ",", " ", 
                RowBox[{
                 RowBox[{"x", "\[LeftDoubleBracket]", 
                  RowBox[{"Sow", "[", "k", "]"}], "\[RightDoubleBracket]"}], 
                 " ", "/;", " ", "True"}]}], "]"}]}]}], "\[IndentingNewLine]",
             "]"}], ",", " ", "\[IndentingNewLine]", 
           RowBox[{"Throw", "[", "$Failed", "]"}]}], "\[IndentingNewLine]", 
          "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Length", "[", "ind", "]"}], " ", "\[Equal]", " ", "0"}], 
          ",", " ", "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{"argument", " ", "is", " ", "a", " ", "constant"}], " ", 
           "*)"}], "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"ind", " ", "=", " ", 
            RowBox[{"Dimensions", "[", "s", "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"sdot", " ", "=", " ", 
            RowBox[{"ConstantArray", "[", 
             RowBox[{"0", ",", " ", "ind"}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"nd", " ", ">", " ", "0"}], ",", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"ind", " ", "=", " ", 
               RowBox[{"Append", "[", 
                RowBox[{"ind", ",", " ", "nd"}], "]"}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"ds", " ", "=", " ", 
               RowBox[{"ConstantArray", "[", 
                RowBox[{"0", ",", " ", "ind"}], "]"}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"dsdot", " ", "=", " ", 
               RowBox[{"ConstantArray", "[", 
                RowBox[{"0", ",", " ", "ind"}], "]"}]}], ";"}]}], 
            "\[IndentingNewLine]", "]"}], ";"}], ",", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{"else", " ", "compute", " ", "derivatives"}], " ", "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"ind", " ", "=", " ", 
            RowBox[{"Sort", "[", 
             RowBox[{"DeleteDuplicates", "[", 
              RowBox[{
              "ind", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
              "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"q", ",", " ", "qd"}], "}"}], " ", "=", " ", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{
               RowBox[{
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{
                  "x", "\[LeftDoubleBracket]", "#", "\[RightDoubleBracket]"}],
                   ",", " ", 
                  RowBox[{"x", "\[LeftDoubleBracket]", 
                   RowBox[{"nq", "+", "#"}], "\[RightDoubleBracket]"}]}], 
                 "}"}], "&"}], " ", "/@", " ", "ind"}], ")"}], 
             "\[Transpose]"}]}], ";", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{"ds", " ", "=", " ", 
            RowBox[{"D", "[", 
             RowBox[{"s", ",", " ", 
              RowBox[{"{", "q", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"sdot", " ", "=", " ", 
            RowBox[{"ds", ".", "qd"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"dsdot", " ", "=", " ", 
            RowBox[{"D", "[", 
             RowBox[{"sdot", ",", " ", 
              RowBox[{"{", 
               RowBox[{"Join", "[", 
                RowBox[{"q", ",", " ", "qd"}], "]"}], "}"}]}], "]"}]}], ";", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"nd", " ", ">", " ", "0"}], ",", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"f", " ", "=", " ", 
               RowBox[{"Length", "[", "ind", "]"}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"q", " ", "=", " ", 
               RowBox[{"Array", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"dx", "\[LeftDoubleBracket]", 
                   RowBox[{
                    RowBox[{
                    "ind", "\[LeftDoubleBracket]", "#1", 
                    "\[RightDoubleBracket]"}], ",", "#2"}], 
                   "\[RightDoubleBracket]"}], "&"}], ",", " ", 
                 RowBox[{"{", 
                  RowBox[{"f", ",", " ", "nd"}], "}"}]}], "]"}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"qd", " ", "=", " ", 
               RowBox[{"Array", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"dx", "\[LeftDoubleBracket]", 
                   RowBox[{
                    RowBox[{"nq", "+", 
                    RowBox[{
                    "ind", "\[LeftDoubleBracket]", "#1", 
                    "\[RightDoubleBracket]"}]}], ",", "#2"}], 
                   "\[RightDoubleBracket]"}], "&"}], ",", " ", 
                 RowBox[{"{", 
                  RowBox[{"f", ",", " ", "nd"}], "}"}]}], "]"}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"ds", " ", "=", " ", 
               RowBox[{"ds", ".", "q"}]}], ";", "\[IndentingNewLine]", 
              RowBox[{"dsdot", " ", "=", " ", 
               RowBox[{"dsdot", ".", 
                RowBox[{"Join", "[", 
                 RowBox[{"q", ",", " ", "qd"}], "]"}]}]}], ";"}]}], 
            "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", 
         "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"f", " ", "=", " ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"nd", " ", ">", " ", "0"}], ",", " ", 
           RowBox[{"{", 
            RowBox[{
            "s", ",", " ", "sdot", ",", " ", "ds", ",", " ", "dsdot"}], "}"}],
            ",", " ", 
           RowBox[{"{", 
            RowBox[{"s", ",", " ", "sdot"}], "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"On", "[", 
         RowBox[{
          RowBox[{"Part", "::", "partw"}], ",", " ", 
          RowBox[{"Part", "::", "partd"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{"Function", " ", "/@", " ", "f"}], ")"}], " ", "/.", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"x", "\[Rule]", " ", "#1"}], ",", " ", 
           RowBox[{"dx", "\[Rule]", " ", "#2"}]}], "}"}]}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"MakeFunction", "[", "fbody_", "]"}], " ", ":=", " ", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "q", ",", " ", "qd", ",", " ", "p", ",", " ", "pd", ",", " ", "s", 
         ",", " ", "ds", ",", " ", "sdot", ",", " ", "dsdot", ",", " ", "x", 
         ",", " ", "dx", ",", " ", "\[Lambda]", ",", " ", "d\[Lambda]", ",", 
         " ", "qind", ",", " ", "pind", ",", " ", "f"}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"turn", " ", "off", " ", "known", " ", "messages"}], " ", 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Off", "[", 
         RowBox[{
          RowBox[{"Part", "::", "partw"}], ",", " ", 
          RowBox[{"Part", "::", "partd"}]}], "]"}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "map", " ", "parent0", " ", "to", " ", "parent", " ", "joint", " ", 
          "#", "s"}], " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"s", ",", " ", 
           RowBox[{"{", 
            RowBox[{"qind", ",", " ", "pind"}], "}"}]}], "}"}], " ", "=", " ", 
         RowBox[{"Check", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Reap", "[", "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{"Trott", "-", 
              RowBox[{"Strzebonski", " ", "method", " ", "for", " ", "In"}], 
              "-", 
              RowBox[{"Place", " ", "Evaluation"}]}], " ", "*)"}], 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"fbody", " ", "/.", " ", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{
                 RowBox[{"HoldPattern", "[", 
                  RowBox[{"\[DoubleStruckQ]", "[", 
                   RowBox[{"i_Integer", ",", " ", "j_Integer"}], "]"}], "]"}],
                  "\[RuleDelayed]", " ", 
                 RowBox[{"With", "[", 
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{"k", " ", "=", " ", 
                    RowBox[{"qmap", "[", 
                    RowBox[{"i", ",", "j"}], "]"}]}], "}"}], ",", " ", 
                   RowBox[{
                    RowBox[{"x", "\[LeftDoubleBracket]", 
                    RowBox[{"Sow", "[", 
                    RowBox[{"k", ",", " ", "\[DoubleStruckQ]"}], "]"}], 
                    "\[RightDoubleBracket]"}], " ", "/;", " ", "True"}]}], 
                  "]"}]}], ",", "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{"HoldPattern", "[", 
                  RowBox[{"\[DoubleStruckP]", "[", "i_Integer", "]"}], "]"}], 
                 "\[RuleDelayed]", " ", 
                 RowBox[{"\[Lambda]", "\[LeftDoubleBracket]", 
                  RowBox[{"Sow", "[", 
                   RowBox[{"i", ",", " ", "\[DoubleStruckP]"}], "]"}], 
                  "\[RightDoubleBracket]"}]}]}], "}"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckQ]", ",", " ", "\[DoubleStruckP]"}], 
              "}"}]}], "]"}], ",", " ", "\[IndentingNewLine]", 
           RowBox[{"Throw", "[", "$Failed", "]"}]}], "\[IndentingNewLine]", 
          "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"Length", "[", "qind", "]"}], " ", "+", " ", 
            RowBox[{"Length", "[", "pind", "]"}]}], " ", "\[Equal]", " ", 
           "0"}], ",", " ", "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{"argument", " ", "is", " ", "a", " ", "constant"}], " ", 
           "*)"}], "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"qind", " ", "=", " ", 
            RowBox[{"Dimensions", "[", "s", "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"sdot", " ", "=", " ", 
            RowBox[{"ConstantArray", "[", 
             RowBox[{"0", ",", " ", "qind"}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"nd", " ", ">", " ", "0"}], ",", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"qind", " ", "=", " ", 
               RowBox[{"Append", "[", 
                RowBox[{"qind", ",", " ", "nd"}], "]"}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"ds", " ", "=", " ", 
               RowBox[{"ConstantArray", "[", 
                RowBox[{"0", ",", " ", "qind"}], "]"}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"dsdot", " ", "=", " ", 
               RowBox[{"ConstantArray", "[", 
                RowBox[{"0", ",", " ", "qind"}], "]"}]}], ";"}]}], 
            "\[IndentingNewLine]", "]"}], ";"}], ",", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{"else", " ", "compute", " ", "derivatives"}], " ", "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"{", 
             RowBox[{"q", ",", " ", "qd"}], "}"}], " ", "=", " ", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Length", "[", "qind", "]"}], " ", ">", " ", "0"}], 
              ",", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"qind", " ", "=", " ", 
                RowBox[{"Sort", "[", 
                 RowBox[{"DeleteDuplicates", "[", 
                  RowBox[{
                  "qind", "\[LeftDoubleBracket]", "1", 
                   "\[RightDoubleBracket]"}], "]"}], "]"}]}], ";", 
               "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{
                    RowBox[{
                    "x", "\[LeftDoubleBracket]", "#", 
                    "\[RightDoubleBracket]"}], ",", " ", 
                    RowBox[{"x", "\[LeftDoubleBracket]", 
                    RowBox[{"nq", "+", "#"}], "\[RightDoubleBracket]"}]}], 
                    "}"}], "&"}], " ", "/@", " ", "qind"}], ")"}], 
                "\[Transpose]"}]}], ",", "\[IndentingNewLine]", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"{", "}"}], ",", " ", 
                RowBox[{"{", "}"}]}], "}"}]}], "\[IndentingNewLine]", "]"}]}],
            ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"p", ",", " ", "pd"}], "}"}], " ", "=", " ", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Length", "[", "pind", "]"}], " ", ">", " ", "0"}], 
              ",", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"pind", " ", "=", " ", 
                RowBox[{"Sort", "[", 
                 RowBox[{"DeleteDuplicates", "[", 
                  RowBox[{
                  "pind", "\[LeftDoubleBracket]", "1", 
                   "\[RightDoubleBracket]"}], "]"}], "]"}]}], ";", 
               "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{
                    RowBox[{
                    "\[Lambda]", "\[LeftDoubleBracket]", "#", 
                    "\[RightDoubleBracket]"}], ",", " ", "0"}], "}"}], "&"}], 
                  " ", "/@", " ", "pind"}], ")"}], "\[Transpose]"}]}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"{", "}"}], ",", " ", 
                RowBox[{"{", "}"}]}], "}"}]}], "\[IndentingNewLine]", "]"}]}],
            ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"ds", " ", "=", " ", 
            RowBox[{"D", "[", 
             RowBox[{"s", ",", " ", 
              RowBox[{"{", 
               RowBox[{"Join", "[", 
                RowBox[{"q", ",", " ", "p"}], "]"}], "}"}]}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"sdot", " ", "=", " ", 
            RowBox[{"ds", ".", 
             RowBox[{"Join", "[", 
              RowBox[{"qd", ",", " ", "pd"}], "]"}]}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"dsdot", " ", "=", " ", 
            RowBox[{"D", "[", 
             RowBox[{"sdot", ",", " ", 
              RowBox[{"{", 
               RowBox[{"Join", "[", 
                RowBox[{"q", ",", " ", "p", ",", " ", "qd"}], "]"}], "}"}]}], 
             "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"nd", " ", ">", " ", "0"}], ",", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"f", " ", "=", " ", 
               RowBox[{"Length", "[", "qind", "]"}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"q", " ", "=", " ", 
               RowBox[{"Array", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"dx", "\[LeftDoubleBracket]", 
                   RowBox[{
                    RowBox[{
                    "qind", "\[LeftDoubleBracket]", "#1", 
                    "\[RightDoubleBracket]"}], ",", "#2"}], 
                   "\[RightDoubleBracket]"}], "&"}], ",", " ", 
                 RowBox[{"{", 
                  RowBox[{"f", ",", " ", "nd"}], "}"}]}], "]"}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"qd", " ", "=", " ", 
               RowBox[{"Array", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"dx", "\[LeftDoubleBracket]", 
                   RowBox[{
                    RowBox[{"nq", "+", 
                    RowBox[{
                    "qind", "\[LeftDoubleBracket]", "#1", 
                    "\[RightDoubleBracket]"}]}], ",", "#2"}], 
                   "\[RightDoubleBracket]"}], "&"}], ",", " ", 
                 RowBox[{"{", 
                  RowBox[{"f", ",", " ", "nd"}], "}"}]}], "]"}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"f", " ", "=", " ", 
               RowBox[{"Length", "[", "pind", "]"}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"p", " ", "=", " ", 
               RowBox[{"Array", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"d\[Lambda]", "\[LeftDoubleBracket]", 
                   RowBox[{
                    RowBox[{
                    "pind", "\[LeftDoubleBracket]", "#1", 
                    "\[RightDoubleBracket]"}], ",", "#2"}], 
                   "\[RightDoubleBracket]"}], "&"}], ",", " ", 
                 RowBox[{"{", 
                  RowBox[{"f", ",", " ", "nd"}], "}"}]}], "]"}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"ds", " ", "=", " ", 
               RowBox[{"ds", ".", 
                RowBox[{"Join", "[", 
                 RowBox[{"q", ",", " ", "p"}], "]"}]}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"dsdot", " ", "=", " ", 
               RowBox[{"dsdot", ".", 
                RowBox[{"Join", "[", 
                 RowBox[{"q", ",", " ", "p", ",", "qd"}], "]"}]}]}], ";"}]}], 
            "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", 
         "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"f", " ", "=", " ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"nd", " ", ">", " ", "0"}], ",", " ", 
           RowBox[{"{", 
            RowBox[{
            "s", ",", " ", "sdot", ",", " ", "ds", ",", " ", "dsdot"}], "}"}],
            ",", " ", 
           RowBox[{"{", 
            RowBox[{"s", ",", " ", "sdot"}], "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"On", "[", 
         RowBox[{
          RowBox[{"Part", "::", "partw"}], ",", " ", 
          RowBox[{"Part", "::", "partd"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{"Function", " ", "/@", " ", "f"}], ")"}], " ", "/.", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"x", "\[Rule]", " ", "#1"}], ",", " ", 
           RowBox[{"\[Lambda]", "\[Rule]", " ", "#2"}], ",", " ", 
           RowBox[{"dx", "\[Rule]", " ", "#3"}], ",", " ", 
           RowBox[{"d\[Lambda]", "\[Rule]", " ", "#4"}]}], "}"}]}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", "*)"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ClearFunctions", "[", "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Do", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"s", "[", "i", "]"}], " ", "=."}], ";", " ", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"sdot", "[", "i", "]"}], " ", "=."}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Xip", "[", "i", "]"}], " ", "=."}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"Xdotip", " ", "=."}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"\[DoubleStruckCapitalI]", "[", "i", "]"}], " ", "=."}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"nd", " ", ">", " ", "0"}], ",", " ", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"ds", "[", "i", "]"}], " ", "=."}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"dsdot", "[", "i", "]"}], " ", "=."}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"dXip", "[", "i", "]"}], " ", "=."}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"dXdotip", " ", "=."}], ";", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"d\[DoubleStruckCapitalI]", "[", "i", "]"}], " ", 
              "=."}], ";"}]}], "\[IndentingNewLine]", "]"}]}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", "nq"}], "}"}]}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"Do", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"r", "[", "i", "]"}], "=."}], ";", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"nd", " ", ">", " ", "0"}], ",", " ", 
            RowBox[{
             RowBox[{
              RowBox[{"dr", "[", "i", "]"}], "=."}], ";"}]}], "]"}]}], ",", 
         " ", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", "mb"}], "}"}]}], "]"}]}]}], 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"EvaluateFunctions", "[", "x_", "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"RNEA", "/", "CRB"}], "/", "Josim"}], " ", 
        "initializations"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"XL", " ", "=", " ", 
        RowBox[{"Xip", "[", "x", "]"}]}], ";", " ", 
       RowBox[{"(*", " ", 
        RowBox[{"parent", " ", "to", " ", "child", " ", "transforms"}], " ", 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{"\[DoubleStruckCapitalI]J", " ", "=", " ", 
        RowBox[{"\[DoubleStruckCapitalI]", "[", "x", "]"}]}], ";", " ", 
       RowBox[{"(*", " ", 
        RowBox[{"spatial", " ", "inertia"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"IC", " ", "=", " ", "\[DoubleStruckCapitalI]J"}], ";", " ", 
       RowBox[{"(*", " ", 
        RowBox[{"articulated", " ", "body", " ", "inertia"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"sJ", " ", "=", " ", 
        RowBox[{"s", "[", "x", "]"}]}], ";", " ", 
       RowBox[{"(*", " ", 
        RowBox[{"link", " ", "motion", " ", "freedoms"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"sJdot", " ", "=", " ", 
        RowBox[{"sdot", "[", "x", "]"}]}], ";", " ", 
       RowBox[{"(*", " ", 
        RowBox[{"time", " ", "derivative", " ", "of", " ", "sJ"}], " ", 
        "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"Josim", " ", "initializations"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"mb", " ", ">", " ", "0"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"rJ", " ", "=", " ", 
           RowBox[{"r", "[", "x", "]"}]}], ";", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", 
          RowBox[{"rJdot", " ", "=", " ", 
           RowBox[{"rdot", "[", "x", "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"XLdot", " ", "=", " ", 
           RowBox[{"Xdotip", "[", "x", "]"}]}], ";"}]}], 
        "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}],
    ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"EvaluateDerivatives", "[", 
    RowBox[{"x_", ",", " ", "dx_"}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
        RowBox[{"RNEA", "/", "CRB"}], "/", "Josim"}], " ", 
       "initializations"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"dXL", " ", "=", " ", 
       RowBox[{"dXip", "[", 
        RowBox[{"x", ",", " ", "dx"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"d\[DoubleStruckCapitalI]J", " ", "=", " ", 
       RowBox[{"d\[DoubleStruckCapitalI]", "[", 
        RowBox[{"x", ",", " ", "dx"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"dIC", " ", "=", " ", "d\[DoubleStruckCapitalI]J"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"dsJ", " ", "=", " ", 
       RowBox[{"ds", "[", 
        RowBox[{"x", ",", " ", "dx"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"dsJdot", " ", "=", " ", 
       RowBox[{"dsdot", "[", 
        RowBox[{"x", ",", " ", "dx"}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"Josim", " ", "initializations"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"mb", " ", ">", " ", "0"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"drJ", " ", "=", " ", 
          RowBox[{"dr", "[", 
           RowBox[{"x", ",", " ", "dx"}], "]"}]}], ";", "\[IndentingNewLine]",
          "\[IndentingNewLine]", 
         RowBox[{"drJdot", " ", "=", " ", 
          RowBox[{"drdot", "[", 
           RowBox[{"x", ",", " ", "dx"}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"dXLdot", " ", "=", " ", 
          RowBox[{"dXdotip", "[", 
           RowBox[{"x", ",", " ", "dx"}], "]"}]}], ";"}]}], 
       "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{
  3.591667817527995*^9, 3.591668923825349*^9, {3.5916697599352307`*^9, 
   3.591669819815657*^9}, {3.5916698753458366`*^9, 3.5916698888766146`*^9}, {
   3.5916699961457586`*^9, 3.591669997476833*^9}, {3.59167068192603*^9, 
   3.59167070374928*^9}, {3.5917208858180676`*^9, 3.591720889380574*^9}, {
   3.5917221970292563`*^9, 3.591722203732394*^9}, {3.591722238732463*^9, 
   3.591722239091839*^9}, {3.591930526907305*^9, 3.5919305664205675`*^9}, {
   3.5919306118141713`*^9, 3.591930612108184*^9}, 3.591930660729968*^9, {
   3.591930696356006*^9, 3.5919307386704297`*^9}, {3.5919308258974266`*^9, 
   3.5919308840727587`*^9}, {3.591931024599806*^9, 3.591931025034828*^9}, {
   3.591931958433284*^9, 3.5919319593043294`*^9}, {3.5919331117973347`*^9, 
   3.5919331580109777`*^9}, {3.591933250024245*^9, 3.591933252427383*^9}, {
   3.591985667141246*^9, 3.5919857313879256`*^9}, {3.591987361798293*^9, 
   3.591987364276435*^9}, {3.5919978599754896`*^9, 3.59199787152915*^9}, 
   3.5919979113604307`*^9, {3.5919979589681625`*^9, 3.5919979727709627`*^9}, 
   3.5919982080554256`*^9, {3.5920191973504057`*^9, 3.592019234797552*^9}, {
   3.5921518015301204`*^9, 3.592151821661277*^9}, {3.5921518519500084`*^9, 
   3.5921518784545245`*^9}, {3.5921519174737606`*^9, 3.592151918642827*^9}, {
   3.5921519914750166`*^9, 3.5921519924810553`*^9}, 3.5921521161271386`*^9, {
   3.5921521472189164`*^9, 3.592152245920565*^9}, {3.5921524640720634`*^9, 
   3.5921524695633802`*^9}, {3.5921527028097334`*^9, 
   3.5921527107801905`*^9}, {3.59215278839163*^9, 3.592152817779317*^9}, 
   3.5921530282183657`*^9, {3.59215320443246*^9, 3.5921532065185785`*^9}, {
   3.5922519586863747`*^9, 3.592251999186454*^9}, {3.592254165862566*^9, 
   3.5922542064876456`*^9}, {3.5922558428788123`*^9, 
   3.5922558607708282`*^9}, {3.5922558957868533`*^9, 3.592255901201167*^9}, 
   3.592255970324107*^9, {3.5922580456873465`*^9, 3.592258045853349*^9}, {
   3.5922581158633614`*^9, 3.592258139375705*^9}, {3.592258226580702*^9, 
   3.592258231348975*^9}, {3.592258396619439*^9, 3.5922584020647693`*^9}, {
   3.592258438962861*^9, 3.592258459774053*^9}, {3.5922591760830736`*^9, 
   3.5922591855486183`*^9}, {3.592259257920762*^9, 3.5922592787549534`*^9}, {
   3.5922594413162627`*^9, 3.592259469596903*^9}, {3.592259570929685*^9, 
   3.5922595851425023`*^9}, {3.592259622531643*^9, 3.5922596920396233`*^9}, {
   3.5922597847129307`*^9, 3.59225978836014*^9}, {3.592265284603904*^9, 
   3.592265302772931*^9}, {3.5922660757641973`*^9, 3.592266168732519*^9}, {
   3.592266745226554*^9, 3.5922667453035393`*^9}, 3.5922667840087557`*^9, {
   3.592266872124799*^9, 3.592266894180065*^9}, {3.5922669756537285`*^9, 
   3.5922669960148973`*^9}, {3.5922671554480267`*^9, 
   3.5922672007746234`*^9}, {3.592267352764331*^9, 3.592267352851329*^9}, {
   3.5922673878293343`*^9, 3.5922674271685877`*^9}, {3.5922677518271804`*^9, 
   3.592267753864293*^9}, {3.592269365102566*^9, 3.5922693810894814`*^9}, {
   3.5922694704245977`*^9, 3.59226951552118*^9}, 3.592269559872718*^9, {
   3.592269596464834*^9, 3.592269605997359*^9}, {3.592269651011939*^9, 
   3.5922696511789675`*^9}, {3.592269686507972*^9, 3.59226972943143*^9}, {
   3.5922698283110924`*^9, 3.5922699566064405`*^9}, {3.5922700800495105`*^9, 
   3.592270104246894*^9}, {3.5922701343156166`*^9, 3.5922701411890078`*^9}, {
   3.5922701729868326`*^9, 3.592270182028349*^9}, {3.59227026813428*^9, 
   3.592270307654543*^9}, {3.592270789010106*^9, 3.592270804936021*^9}, {
   3.592271003227376*^9, 3.5922710164511337`*^9}, {3.5922710767405863`*^9, 
   3.592271096212701*^9}, {3.5922712492224765`*^9, 3.59227124969849*^9}, 
   3.5922713284640007`*^9, {3.592271377491807*^9, 3.5922713780178576`*^9}, {
   3.5922714086255894`*^9, 3.592271408733595*^9}, {3.5922714892252083`*^9, 
   3.592271557448115*^9}, {3.5922717878813114`*^9, 3.592271820858195*^9}, 
   3.5922718793635445`*^9, {3.592271916862694*^9, 3.592271917492734*^9}, {
   3.592271975838073*^9, 3.5922719809793663`*^9}, {3.5922721103467903`*^9, 
   3.592272167605055*^9}, {3.592272355126795*^9, 3.5922723559508424`*^9}, {
   3.592272387750682*^9, 3.592272430457106*^9}, {3.5922724624049335`*^9, 
   3.592272486586323*^9}, {3.592272554254202*^9, 3.5922725606365767`*^9}, {
   3.5922726000188184`*^9, 3.5922726042520723`*^9}, {3.592272771832677*^9, 
   3.5922727837953434`*^9}, {3.5922728195993934`*^9, 
   3.5922728631518846`*^9}, {3.5922729410483484`*^9, 
   3.5922729655267687`*^9}, {3.5922731177624674`*^9, 
   3.5922731543115797`*^9}, {3.592273310760521*^9, 3.5922734737338514`*^9}, {
   3.5922735108949947`*^9, 3.592273518410412*^9}, {3.5922735543504705`*^9, 
   3.59227358123601*^9}, {3.592273646181729*^9, 3.592273726257312*^9}, {
   3.5922737869537907`*^9, 3.5922738520135164`*^9}, {3.5922740041642246`*^9, 
   3.592274023666346*^9}, {3.592274258321784*^9, 3.5922742741106863`*^9}, {
   3.592274419230996*^9, 3.5922744193890047`*^9}, {3.59227448977404*^9, 
   3.5922745196417465`*^9}, {3.5922745553427935`*^9, 3.592274595237076*^9}, {
   3.592274638285543*^9, 3.5922746696913414`*^9}, {3.5922747972366467`*^9, 
   3.5922748309945784`*^9}, {3.592274966500351*^9, 3.592274991427766*^9}, {
   3.592275022895569*^9, 3.592275031693086*^9}, {3.5922750665360675`*^9, 
   3.5922752337196403`*^9}, {3.5922753371725636`*^9, 
   3.5922753612429485`*^9}, {3.592275404604432*^9, 3.592275406126515*^9}, {
   3.5922755649776125`*^9, 3.5922756207168036`*^9}, {3.5922758717241945`*^9, 
   3.5922758743503284`*^9}, {3.5922805198023577`*^9, 3.592280560296678*^9}, {
   3.592280648507742*^9, 3.592280653503023*^9}, {3.59228859193862*^9, 
   3.592288631802901*^9}, {3.5922886637607336`*^9, 3.592288669778076*^9}, {
   3.5922887474895287`*^9, 3.5922887482945967`*^9}, {3.592288778321295*^9, 
   3.5922887893069234`*^9}, {3.5922930252875032`*^9, 
   3.5922930261875534`*^9}, {3.59232216412803*^9, 3.5923221645760417`*^9}, {
   3.5923222141038747`*^9, 3.5923222146439095`*^9}, {3.592322303587002*^9, 
   3.5923223085062847`*^9}, {3.592322455802719*^9, 3.592322482674258*^9}, 
   3.592322568846193*^9, {3.592323716015887*^9, 3.5923238349947195`*^9}, {
   3.5923238811463437`*^9, 3.592323903579629*^9}, {3.592323947101121*^9, 
   3.592323958546775*^9}, 3.592325020905615*^9, 3.5923250924057074`*^9, {
   3.592325178768654*^9, 3.5923251847249947`*^9}, {3.592325509846614*^9, 
   3.592325579905626*^9}, {3.592325610773393*^9, 3.592325610986409*^9}, {
   3.5923256480075245`*^9, 3.592325653257824*^9}, {3.592326357953201*^9, 
   3.5923263611073627`*^9}, {3.5923264423020124`*^9, 
   3.5923264641812835`*^9}, {3.592326512038006*^9, 3.5923266042622867`*^9}, {
   3.5923266497838936`*^9, 3.59232674643143*^9}, {3.592326830500261*^9, 
   3.5923268797860622`*^9}, {3.5923269342291837`*^9, 
   3.5923269986578894`*^9}, {3.5923270362190285`*^9, 3.592327117486677*^9}, {
   3.5923272314232144`*^9, 3.5923272715754995`*^9}, {3.5923273065705056`*^9, 
   3.592327350989049*^9}, {3.5923274125735755`*^9, 3.592327418064891*^9}, {
   3.5923275140303864`*^9, 3.5923276062176657`*^9}, {3.5923276532933617`*^9, 
   3.592327654185412*^9}, {3.5923276926456146`*^9, 3.592327692772622*^9}, {
   3.5923277288566885`*^9, 3.592327904489751*^9}, {3.592327939983777*^9, 
   3.5923279946489096`*^9}, {3.5923280273017793`*^9, 
   3.5923280708432727`*^9}, {3.592328256381916*^9, 3.592328311494054*^9}, {
   3.592328377548837*^9, 3.5923283784428883`*^9}, {3.5923290216127205`*^9, 
   3.592329030903251*^9}, 3.5923293277412486`*^9, {3.5923294589187665`*^9, 
   3.5923294903285656`*^9}, {3.592329543190589*^9, 3.59232954460567*^9}, {
   3.5923295995248127`*^9, 3.5923297137353554`*^9}, {3.5923297507114735`*^9, 
   3.5923297799551473`*^9}, {3.5923298456749153`*^9, 
   3.5923298638739705`*^9}, {3.592329916913991*^9, 3.5923299180660534`*^9}, {
   3.5923300051120396`*^9, 3.592330006966149*^9}, {3.592330040054043*^9, 
   3.5923300669505844`*^9}, {3.592330118277522*^9, 3.592330208584695*^9}, {
   3.5923302807648277`*^9, 3.5923303462545786`*^9}, {3.5923307023329697`*^9, 
   3.59233075823417*^9}, 3.59233085839291*^9, {3.5923309133830557`*^9, 
   3.592330926128785*^9}, {3.5923309567205377`*^9, 3.59233098767231*^9}, {
   3.5923310282886353`*^9, 3.592331084900878*^9}, {3.5923312539095697`*^9, 
   3.5923312777179203`*^9}, {3.5923313996679215`*^9, 3.592331563625311*^9}, {
   3.5923316207045584`*^9, 3.5923316484191484`*^9}, {3.592331710373694*^9, 
   3.59233173455208*^9}, {3.592331766743924*^9, 3.592331818322875*^9}, {
   3.592331902011675*^9, 3.5923319996242604`*^9}, {3.5923320770106974`*^9, 
   3.5923321816526823`*^9}, {3.592332323052782*^9, 3.5923323245848713`*^9}, {
   3.5923323692014256`*^9, 3.5923324045414486`*^9}, {3.592332447873933*^9, 
   3.592332509325468*^9}, {3.592332544584469*^9, 3.592332612939383*^9}, {
   3.5923327382425585`*^9, 3.592332893818468*^9}, {3.592332937962996*^9, 
   3.5923329423152466`*^9}, {3.5923330114832063`*^9, 
   3.5923330471242476`*^9}, {3.592333090562735*^9, 3.5923331256457443`*^9}, {
   3.592333182797021*^9, 3.5923332001360097`*^9}, {3.5923333254841843`*^9, 
   3.5923333524377313`*^9}, {3.5923334143242755`*^9, 3.59233362061009*^9}, {
   3.592333653265959*^9, 3.592333655125065*^9}, {3.592333718847728*^9, 
   3.5923337979862437`*^9}, {3.592333836173434*^9, 3.5923338582126956`*^9}, {
   3.592334017578822*^9, 3.592334021541049*^9}, {3.5923340968783627`*^9, 
   3.592334161335054*^9}, {3.592334191952804*^9, 3.592334217431267*^9}, {
   3.5923345274470387`*^9, 3.592334642373602*^9}, {3.5923347077953486`*^9, 
   3.59233471623883*^9}, {3.592334765200636*^9, 3.592334767330758*^9}, {
   3.592335071649193*^9, 3.5923350768634834`*^9}, {3.5923356715045385`*^9, 
   3.592335680606055*^9}, {3.5923538222759776`*^9, 3.592353831584521*^9}, {
   3.592370916535984*^9, 3.5923709463356905`*^9}, {3.5923711734726973`*^9, 
   3.5923711932798505`*^9}, {3.5923716758344617`*^9, 3.592371686130056*^9}, {
   3.592371744953433*^9, 3.59237175434396*^9}, {3.592371797994459*^9, 
   3.5923718202977347`*^9}, {3.5923747656754103`*^9, 
   3.5923747663284464`*^9}, {3.592383856791027*^9, 3.5923838888468666`*^9}, {
   3.5925242672389746`*^9, 3.592524267779004*^9}, {3.5926274023654532`*^9, 
   3.592627408631096*^9}, {3.5926275824752035`*^9, 3.592627592350204*^9}, {
   3.592629248489919*^9, 3.592629249235964*^9}, {3.592666598963564*^9, 
   3.5926666238073626`*^9}, {3.5927480544837275`*^9, 3.592748086640041*^9}, {
   3.592748144796405*^9, 3.5927481617651877`*^9}, {3.5927573412623234`*^9, 
   3.5927574347756777`*^9}, {3.59275746746855*^9, 3.5927575284640436`*^9}, {
   3.592757602718296*^9, 3.592757738909095*^9}, {3.5927578052508936`*^9, 
   3.592757817615602*^9}, {3.5927579162412496`*^9, 3.5927579330742135`*^9}, {
   3.5927579847871747`*^9, 3.5927581240521483`*^9}, {3.5927583344062004`*^9, 
   3.5927583505581193`*^9}, 3.5927585361497507`*^9, {3.5927585961802025`*^9, 
   3.5927586271859827`*^9}, {3.592760178720814*^9, 3.5927601805439177`*^9}, {
   3.5927609618316603`*^9, 3.5927609624546967`*^9}, {3.592761705624259*^9, 
   3.5927617295366244`*^9}, {3.592761761840474*^9, 3.5927618444832067`*^9}, {
   3.5927618954711266`*^9, 3.5927618971682234`*^9}, 3.5927722880152674`*^9, 
   3.5927724400529785`*^9, 3.5927737486189156`*^9, {3.59278532976274*^9, 
   3.5927853310748105`*^9}, 3.592865011885339*^9, {3.592998251903042*^9, 
   3.5929982578093033`*^9}, {3.5930049819943275`*^9, 3.593005031978801*^9}, {
   3.593005091775792*^9, 3.593005112619583*^9}, {3.5933134779669466`*^9, 
   3.59331348117008*^9}, {3.5933135216232977`*^9, 3.5933135244045515`*^9}, {
   3.593973417214839*^9, 3.5939735067199636`*^9}, {3.593973769481007*^9, 
   3.5939737843378735`*^9}, {3.593973926281987*^9, 3.5939739276240625`*^9}, {
   3.593973963001085*^9, 3.593973963648127*^9}, {3.5962988837573338`*^9, 
   3.596298891054226*^9}, 3.602506267571031*^9, {3.6025063148457375`*^9, 
   3.602506402993786*^9}, {3.602506500207349*^9, 3.6025065026015034`*^9}, {
   3.602506611266713*^9, 3.602506621027272*^9}, {3.602509813708104*^9, 
   3.6025099441475735`*^9}, {3.6025099971836133`*^9, 
   3.6025101057698507`*^9}, {3.6025101538775997`*^9, 3.602510229888958*^9}, {
   3.602510285548126*^9, 3.6025103031511345`*^9}, 3.6025103712620354`*^9, {
   3.6025106022062607`*^9, 3.602510602658305*^9}, {3.602510656901393*^9, 
   3.60251070207498*^9}, {3.602510802510731*^9, 3.6025108054909024`*^9}, {
   3.6025121567533035`*^9, 3.602512157485327*^9}, {3.60251219992276*^9, 
   3.602512200076767*^9}, {3.602512281343419*^9, 3.6025123251379414`*^9}, 
   3.6025125282475586`*^9, {3.6025966892036605`*^9, 3.602596699266176*^9}, {
   3.6025967547975307`*^9, 3.6025968008601246`*^9}, {3.602596848282092*^9, 
   3.6025971048919706`*^9}, {3.6025971520639367`*^9, 3.602597153173314*^9}, {
   3.6025971908765125`*^9, 3.6025972346109724`*^9}, {3.6025972927985888`*^9, 
   3.602597342548684*^9}, {3.6025974649082985`*^9, 3.6025976055804496`*^9}, {
   3.6025976636274366`*^9, 3.602597667002463*^9}, 3.6025977256588087`*^9, {
   3.6025978610965734`*^9, 3.6025978702215953`*^9}, {3.6025979252217007`*^9, 
   3.602597925846697*^9}, {3.602617382638736*^9, 3.602617385560906*^9}, {
   3.602617653775265*^9, 3.6026176554283595`*^9}, {3.6029523465110755`*^9, 
   3.6029524321529803`*^9}, {3.602952477023546*^9, 3.6029525481266174`*^9}, {
   3.602952585175739*^9, 3.6029527691302776`*^9}, {3.6029529444623194`*^9, 
   3.6029529847096233`*^9}, {3.6029530168964667`*^9, 
   3.6029530434289865`*^9}, {3.6029531722483597`*^9, 
   3.6029532409792995`*^9}, {3.6029533074591055`*^9, 3.602953361388194*^9}, {
   3.6029534057507305`*^9, 3.602953429736112*^9}, {3.6029535698391314`*^9, 
   3.602953571048201*^9}, {3.602953642985321*^9, 3.6029537167455444`*^9}, {
   3.6029541173585005`*^9, 3.602954121300716*^9}, {3.602954377371375*^9, 
   3.602954378678451*^9}, 3.602954652728149*^9, {3.6029546972957115`*^9, 
   3.602954698771778*^9}, {3.6029547301385784`*^9, 3.602954744615408*^9}, {
   3.602954899802294*^9, 3.60295491549119*^9}, {3.602955301105277*^9, 
   3.602955319944354*^9}, {3.6029555879787035`*^9, 3.602955588589757*^9}, {
   3.602955897617435*^9, 3.602955907039975*^9}, {3.60295600858179*^9, 
   3.602956018622365*^9}, {3.6029561243724213`*^9, 3.6029561266775503`*^9}, 
   3.6029563218817315`*^9, {3.6029563673443346`*^9, 3.6029564084766865`*^9}, {
   3.6029564517091703`*^9, 3.6029564699192095`*^9}, {3.6029565033221188`*^9, 
   3.6029565072423477`*^9}, {3.6029567736456065`*^9, 
   3.6029567782808685`*^9}, {3.602956831387929*^9, 3.6029568782775946`*^9}, {
   3.602956916415781*^9, 3.6029569226721363`*^9}, {3.6029569843666706`*^9, 
   3.602957001643659*^9}, {3.6029573658195143`*^9, 3.6029573717038517`*^9}, {
   3.602957476031826*^9, 3.60295747646585*^9}, 3.6029575386804132`*^9, {
   3.6029587364290037`*^9, 3.602958742506352*^9}, {3.602958783710713*^9, 
   3.6029587991195946`*^9}, {3.6029588820713444`*^9, 
   3.6029589062437325`*^9}, {3.6029589412967367`*^9, 
   3.6029590180841336`*^9}, {3.6029590560793095`*^9, 3.602959106976224*^9}, {
   3.602959217108531*^9, 3.6029592766829467`*^9}, {3.6029595178287525`*^9, 
   3.6029595632373533`*^9}, {3.602959761513707*^9, 3.602959803309101*^9}, {
   3.6029598473936253`*^9, 3.6029598686178412`*^9}, {3.6029599010917015`*^9, 
   3.602959950482529*^9}, {3.6029600302720985`*^9, 3.6029600303581038`*^9}, {
   3.602960850203639*^9, 3.6029608518447523`*^9}, {3.602960903631263*^9, 
   3.6029609256385264`*^9}, {3.602960968222962*^9, 3.6029609699570785`*^9}, {
   3.6029612888623233`*^9, 3.60296131552185*^9}, {3.6029618183656454`*^9, 
   3.6029618947290196`*^9}, {3.6029619730715046`*^9, 3.602962028017649*^9}, {
   3.6029625562919044`*^9, 3.6029626014205017`*^9}, {3.602962631990238*^9, 
   3.602962639976696*^9}, {3.60296272822775*^9, 3.602962799688843*^9}, {
   3.6029628535869255`*^9, 3.6029628841596932`*^9}, {3.6029629919988556`*^9, 
   3.6029630347893057`*^9}, {3.602963137118165*^9, 3.6029631564672747`*^9}, {
   3.60296321960389*^9, 3.602963219675894*^9}, {3.60296328509064*^9, 
   3.6029633169344635`*^9}, {3.6029635775603895`*^9, 3.602963582387665*^9}, {
   3.6029636540077667`*^9, 3.6029637102060027`*^9}, {3.602963759040806*^9, 
   3.6029637656941624`*^9}, {3.602963901903962*^9, 3.602963903123048*^9}, 
   3.6029639535339193`*^9, {3.6029640178896046`*^9, 3.602964060555048*^9}, {
   3.602964153937393*^9, 3.602964177311735*^9}, {3.602964217314025*^9, 
   3.6029642449776134`*^9}, {3.602964332434617*^9, 3.6029644393267393`*^9}, {
   3.6029645381954*^9, 3.602964541063565*^9}, {3.6029648000013933`*^9, 
   3.602964980560733*^9}, {3.602972116556387*^9, 3.602972128788083*^9}, {
   3.602972967100095*^9, 3.602972968268162*^9}, {3.6029737834128428`*^9, 
   3.6029738663145905`*^9}, {3.6029739256689887`*^9, 
   3.6029739324243765`*^9}, {3.6029739672423697`*^9, 3.602974020391432*^9}, 
   3.6029741064033346`*^9, 3.602974606913001*^9, {3.603245692484913*^9, 
   3.6032458066264677`*^9}, {3.6032460361925964`*^9, 3.60324608747753*^9}, {
   3.60324628115562*^9, 3.603246284855855*^9}, {3.603246343610201*^9, 
   3.603246372112834*^9}, {3.6032464222237053`*^9, 3.603246505115445*^9}, {
   3.6032467420050154`*^9, 3.6032467446061645`*^9}, {3.603248047280764*^9, 
   3.603248081244709*^9}, {3.6032481541118817`*^9, 3.6032481563040066`*^9}, {
   3.6032483709412994`*^9, 3.6032484012280307`*^9}, {3.6032484745502367`*^9, 
   3.6032484773493896`*^9}, {3.6032485276062703`*^9, 
   3.6032485326845617`*^9}, {3.603248754459262*^9, 3.603248755188302*^9}, {
   3.6032488600583086`*^9, 3.603248864841584*^9}, {3.6032493268680415`*^9, 
   3.6032493271940794`*^9}, {3.603249396643039*^9, 3.6032494081336956`*^9}, {
   3.6032496022218285`*^9, 3.603249664997405*^9}, {3.6032497423078365`*^9, 
   3.6032498828528943`*^9}, {3.6032499363879466`*^9, 3.603249940222164*^9}, {
   3.603250015505478*^9, 3.6032500208347826`*^9}, {3.6032500543217*^9, 
   3.6032500591239753`*^9}, 3.603250134109269*^9, {3.6032505617237544`*^9, 
   3.6032505760435734`*^9}, 3.6032518442672043`*^9, {3.6032525682936673`*^9, 
   3.6032525690497117`*^9}, {3.6032526569597445`*^9, 3.603252670753533*^9}, {
   3.6032527661949997`*^9, 3.6032527856381316`*^9}, {3.6032535116856456`*^9, 
   3.6032536768051147`*^9}, {3.6032537203075924`*^9, 
   3.6032538631327715`*^9}, {3.603253893347515*^9, 3.6032539212560997`*^9}, {
   3.603253957019148*^9, 3.6032539640205493`*^9}, {3.603254048824405*^9, 
   3.603254049812463*^9}, {3.6032540825973396`*^9, 3.6032541801589303`*^9}, {
   3.6032542495339*^9, 3.603254449149331*^9}, {3.603254574010481*^9, 
   3.6032546914142137`*^9}, {3.6032547367598147`*^9, 3.603254741613083*^9}, {
   3.603254856376651*^9, 3.6032549116348157`*^9}, {3.6032549468238306`*^9, 
   3.603255010237462*^9}, {3.603255087311874*^9, 3.6032552616288595`*^9}, {
   3.6032554106433926`*^9, 3.6032554165017405`*^9}, {3.603255463340411*^9, 
   3.6032554712538633`*^9}, {3.6032555055888295`*^9, 3.603255512901248*^9}, {
   3.6032559375845685`*^9, 3.6032559386066275`*^9}, {3.603255975896776*^9, 
   3.6032559764987965`*^9}, {3.6032560238935103`*^9, 3.603256028384774*^9}, {
   3.603256093071472*^9, 3.603256106045215*^9}, {3.603256218338646*^9, 
   3.603256287660616*^9}, {3.6032563220165834`*^9, 3.603256349674167*^9}, {
   3.603256448078806*^9, 3.6032565479715242`*^9}, {3.603256583766573*^9, 
   3.603256626610026*^9}, 3.603256682037201*^9, {3.6032568989846287`*^9, 
   3.6032569060370283`*^9}, {3.6032569908728857`*^9, 3.603257150121003*^9}, {
   3.6032571807877617`*^9, 3.60325718147482*^9}, {3.603257277423296*^9, 
   3.6032572913990965`*^9}, {3.6032573548837323`*^9, 
   3.6032574131450663`*^9}, {3.6032574999990425`*^9, 3.603257500795085*^9}, 
   3.603257609387311*^9, {3.6032576652945085`*^9, 3.6032577259679823`*^9}, {
   3.6032578000962253`*^9, 3.6032578206904078`*^9}, {3.603257852050203*^9, 
   3.603257858170554*^9}, {3.603258071757799*^9, 3.6032580968102193`*^9}, {
   3.603258157351688*^9, 3.6032582259036136`*^9}, {3.60325828771115*^9, 
   3.603258289722267*^9}, {3.6032583209700565`*^9, 3.6032583222521296`*^9}, {
   3.603258461536106*^9, 3.6032585323561587`*^9}, {3.6032585966808453`*^9, 
   3.60325859691687*^9}, {3.6032587630793743`*^9, 3.603258768451683*^9}, {
   3.6032846406756654`*^9, 3.603284685397222*^9}, {3.6032847293527393`*^9, 
   3.603284883592572*^9}, {3.6032849340884647`*^9, 3.6032849843163557`*^9}, {
   3.6032852674165525`*^9, 3.6032852687296305`*^9}, {3.603285841034401*^9, 
   3.6032858605605183`*^9}, {3.6032861150190916`*^9, 
   3.6032861194823465`*^9}, {3.6032873247603693`*^9, 
   3.6032873357559986`*^9}, {3.603287388440016*^9, 3.6032874103162656`*^9}, {
   3.6032875693603764`*^9, 3.6032876738203597`*^9}, {3.6032877262293596`*^9, 
   3.6032877309496303`*^9}, {3.6032878998673034`*^9, 
   3.6032879372374434`*^9}, {3.603287979183843*^9, 3.6032880413194036`*^9}, {
   3.603288542142084*^9, 3.6032885423080935`*^9}, {3.6032886050996895`*^9, 
   3.6032886185114756`*^9}, {3.603288670735448*^9, 3.603288720492298*^9}, {
   3.6032887634377565`*^9, 3.6032888261983643`*^9}, {3.6032888818225546`*^9, 
   3.603288914965434*^9}, 3.6032889496064186`*^9, {3.603289299666465*^9, 
   3.603289313396264*^9}, {3.603289497849814*^9, 3.6032896594460683`*^9}, {
   3.6032899980764565`*^9, 3.6032900032847548`*^9}, {3.603290297697619*^9, 
   3.6032903042870097`*^9}, {3.603290371819865*^9, 3.6032903739049826`*^9}, {
   3.6032904088649845`*^9, 3.6032904096650305`*^9}, {3.603290506322566*^9, 
   3.6032905067515907`*^9}, {3.6032906151338153`*^9, 
   3.6032906422593503`*^9}, {3.603290685921847*^9, 3.603290702549803*^9}, {
   3.603290802969554*^9, 3.6032908193494916`*^9}, {3.603291006146187*^9, 
   3.603291006584214*^9}, {3.6032912576735935`*^9, 3.6032912717023964`*^9}, {
   3.603291968372297*^9, 3.6032920285237403`*^9}, {3.603292116445772*^9, 
   3.603292202311689*^9}, {3.603292248306323*^9, 3.6032922528245955`*^9}, {
   3.6032923021274056`*^9, 3.6032923595886965`*^9}, 3.603292438155197*^9, {
   3.6032927104928055`*^9, 3.603292789137295*^9}, {3.6032928523099127`*^9, 
   3.603292896129423*^9}, {3.6032929370427647`*^9, 3.6032931291307683`*^9}, {
   3.6032942520500846`*^9, 3.603294286420039*^9}, {3.6032946668958273`*^9, 
   3.6032946699140005`*^9}, {3.603294761375238*^9, 3.6032947749160323`*^9}, {
   3.6032948108020678`*^9, 3.6032948569947157`*^9}, {3.6032952684642773`*^9, 
   3.603295268579298*^9}, {3.6032954313396044`*^9, 3.603295431833633*^9}, {
   3.603295567511403*^9, 3.6032956118319407`*^9}, {3.6032956515612173`*^9, 
   3.60329565322733*^9}, {3.6032957343709574`*^9, 3.603295750193864*^9}, 
   3.603296008958683*^9, {3.603296362999958*^9, 3.6032963894864883`*^9}, {
   3.603296738414456*^9, 3.603296738866482*^9}, {3.6032967832540293`*^9, 
   3.603296808660495*^9}, {3.603296902867874*^9, 3.6032969204548817`*^9}, {
   3.603297008364916*^9, 3.603297011456106*^9}, {3.603297369470595*^9, 
   3.6032973866935997`*^9}, {3.603297418610409*^9, 3.6032974341793003`*^9}, {
   3.6032974700023527`*^9, 3.603297540570393*^9}, {3.6032975881211176`*^9, 
   3.6032975946934967`*^9}, {3.6032985302240667`*^9, 
   3.6032985308131003`*^9}, {3.6032985696983275`*^9, 3.603298624861487*^9}, {
   3.6032986558232594`*^9, 3.6032986584484096`*^9}, {3.603298692216344*^9, 
   3.60329869362342*^9}, {3.603298749265629*^9, 3.603298750268668*^9}, {
   3.603298853652589*^9, 3.603298902482386*^9}, {3.603301357722988*^9, 
   3.6033013883927574`*^9}, {3.603302380462552*^9, 3.6033023810095882`*^9}, {
   3.6033027906450467`*^9, 3.6033027963733916`*^9}, {3.6033036885004635`*^9, 
   3.6033037291127853`*^9}, {3.603303786267062*^9, 3.603303792990466*^9}, {
   3.603303964662278*^9, 3.603303973814803*^9}, {3.603304748163147*^9, 
   3.6033047678362923`*^9}, {3.6033048101987*^9, 3.60330488116777*^9}, {
   3.60330494571546*^9, 3.6033049988005133`*^9}, {3.6033050700585804`*^9, 
   3.6033050898367324`*^9}, {3.6033051749455876`*^9, 3.603305176006648*^9}, {
   3.6033053199388905`*^9, 3.603305320111904*^9}, {3.603305367063589*^9, 
   3.6033053682416525`*^9}, {3.603305436520567*^9, 3.603305563685853*^9}, {
   3.6033056687158637`*^9, 3.6033057012717285`*^9}, {3.603305799075328*^9, 
   3.6033059700671177`*^9}, {3.603306093992218*^9, 3.60330618588148*^9}, {
   3.6033062261877885`*^9, 3.603306317478017*^9}, {3.603306575325782*^9, 
   3.6033065818481555`*^9}, {3.6033074196511335`*^9, 
   3.6033074258784904`*^9}, {3.6033074765343914`*^9, 3.603307478034477*^9}, {
   3.6033076977720613`*^9, 3.603307722296465*^9}, {3.6033077546963205`*^9, 
   3.603307758020512*^9}, 3.6033077909413967`*^9, {3.6033078367800226`*^9, 
   3.603307905480956*^9}, {3.6033079390488777`*^9, 3.6033080138931637`*^9}, {
   3.6033080440448914`*^9, 3.6033080868503604`*^9}, 3.603308377418982*^9, {
   3.6033085085554914`*^9, 3.6033085160009193`*^9}, {3.603308600155737*^9, 
   3.6033086046279926`*^9}, 3.6033086458463535`*^9, 3.603308687436735*^9, {
   3.6033088336161313`*^9, 3.603308842328619*^9}, {3.6033097947821493`*^9, 
   3.6033098497022953`*^9}, 3.6033099395144377`*^9, {3.603310008917412*^9, 
   3.603310010387515*^9}, {3.603310081882591*^9, 3.6033100868458757`*^9}, {
   3.603310205408668*^9, 3.6033102149662113`*^9}, {3.6033103853269653`*^9, 
   3.603310386032008*^9}, {3.6033104200479555`*^9, 3.6033104232321386`*^9}, {
   3.6033104833895874`*^9, 3.603310505232835*^9}, {3.60331055386862*^9, 
   3.603310582248245*^9}, {3.6033106197713904`*^9, 3.6033107380181665`*^9}, 
   3.6033107997687006`*^9, {3.6033108882117853`*^9, 3.6033108963042297`*^9}, {
   3.603310928924097*^9, 3.603310930890229*^9}, {3.603310965921216*^9, 
   3.6033109972410097`*^9}, {3.6033114297627788`*^9, 
   3.6033114411114473`*^9}, {3.6033115169937744`*^9, 3.603311546219448*^9}, {
   3.603311633315436*^9, 3.6033117542693653`*^9}, {3.6033118871129704`*^9, 
   3.603311924500112*^9}, {3.603311976363081*^9, 3.6033119931780434`*^9}, {
   3.6033120251878767`*^9, 3.603312054168536*^9}, {3.6033120912806616`*^9, 
   3.6033120947818623`*^9}, {3.6033124645110393`*^9, 3.603312503861289*^9}, {
   3.6033125955745406`*^9, 3.6033126328076916`*^9}, {3.6033127131932735`*^9, 
   3.603312713840314*^9}, {3.6033164122675548`*^9, 3.603316476400231*^9}, {
   3.6033165725467334`*^9, 3.603316624776725*^9}, {3.603316761685566*^9, 
   3.6033167618265705`*^9}, {3.6033168069691577`*^9, 3.6033168076981993`*^9}, 
   3.603316839609027*^9, {3.6033168722198944`*^9, 3.6033168848036194`*^9}, {
   3.60331693640357*^9, 3.6033169893296013`*^9}, {3.6033170336731405`*^9, 
   3.603317131134719*^9}, {3.603317216726621*^9, 3.603317294979105*^9}, {
   3.6033178406633544`*^9, 3.6033178453866234`*^9}, {3.603318152152191*^9, 
   3.603318178770712*^9}, {3.603318246037572*^9, 3.603318248846733*^9}, {
   3.6033183421740775`*^9, 3.6033183454112587`*^9}, {3.6033183842974896`*^9, 
   3.603318391585903*^9}, {3.6033185422915335`*^9, 3.603318675357154*^9}, {
   3.6033188304790373`*^9, 3.6033188370864344`*^9}, {3.603318949408848*^9, 
   3.6033189502938986`*^9}, 3.6033189850708904`*^9, 3.603319071397834*^9, {
   3.603319112749202*^9, 3.603319116247405*^9}, {3.6033191550946226`*^9, 
   3.603319159997907*^9}, {3.603319199092144*^9, 3.603319254259305*^9}, 
   3.6033193649726458`*^9, {3.6033194726208115`*^9, 3.6033194784071417`*^9}, {
   3.6033195508032875`*^9, 3.603319559508787*^9}, {3.603319942125701*^9, 
   3.6033200227383175`*^9}, {3.603320296074967*^9, 3.603320319741322*^9}, {
   3.603320414811767*^9, 3.6033204160888395`*^9}, {3.6033205293993287`*^9, 
   3.603320529731349*^9}, {3.6033207340260468`*^9, 3.6033207490989137`*^9}, {
   3.603320851225758*^9, 3.603321017137257*^9}, {3.603321100747048*^9, 
   3.6033211281196156`*^9}, {3.603321211839409*^9, 3.6033212484355054`*^9}, {
   3.603321354619586*^9, 3.6033213566227016`*^9}, {3.603322227606579*^9, 
   3.603322235408044*^9}, {3.6033222764313745`*^9, 3.6033223038369627`*^9}, {
   3.603322364237405*^9, 3.603322557542474*^9}, {3.603322788504716*^9, 
   3.6033228305961103`*^9}, {3.603322868050255*^9, 3.6033229053173904`*^9}, {
   3.6033230580691366`*^9, 3.6033231881915903`*^9}, {3.6033461160300274`*^9, 
   3.60334617123326*^9}, {3.6033777584318285`*^9, 3.6033778231545343`*^9}, {
   3.6033778771106267`*^9, 3.603377950254817*^9}, {3.6033780800562644`*^9, 
   3.60337809176992*^9}, {3.603490401867557*^9, 3.6034904309769897`*^9}, {
   3.6034904619458*^9, 3.6034904650239325`*^9}, {3.6034906637430696`*^9, 
   3.6034906687430787`*^9}, {3.603490731415082*^9, 3.603490750805759*^9}, {
   3.603490994712467*^9, 3.6034909999312468`*^9}, {3.603491063931353*^9, 
   3.6034910944470367`*^9}, {3.603491132712737*^9, 3.6034911447440143`*^9}, {
   3.6034911933378563`*^9, 3.6034911946659875`*^9}, {3.603491309088085*^9, 
   3.603491309650584*^9}, 3.60350665225144*^9, {3.603506727501587*^9, 
   3.6035067420328655`*^9}, {3.603506787767331*^9, 3.603506791923588*^9}, {
   3.603567322012684*^9, 3.6035673484658613`*^9}, {3.6035674294035206`*^9, 
   3.6035674299191446`*^9}, {3.603567666653983*^9, 3.6035676817946405`*^9}, {
   3.6035797542839475`*^9, 3.6035798214247*^9}, {3.603581621240738*^9, 
   3.603581662022049*^9}, {3.6035818160067253`*^9, 3.603581818350479*^9}, {
   3.603581862741192*^9, 3.6035818978818865`*^9}, {3.603581947303857*^9, 
   3.6035820028039646`*^9}, {3.6035821437886257`*^9, 3.603582261679471*^9}, {
   3.603582311492073*^9, 3.6035824621954927`*^9}, {3.6035826070395226`*^9, 
   3.603582617320792*^9}, 3.6035826486489983`*^9, {3.603582698774077*^9, 
   3.6035827067115917`*^9}, {3.60358882875681*^9, 3.6035888290878286`*^9}, {
   3.603602648986827*^9, 3.6036026526730366`*^9}, {3.6036086241460047`*^9, 
   3.6036086678215065`*^9}, {3.603649460520569*^9, 3.603649518508894*^9}, {
   3.6041964678164263`*^9, 3.6041964690075006`*^9}, {3.6041965175212746`*^9, 
   3.604196518536333*^9}, {3.6041965746735477`*^9, 3.6041966013780775`*^9}, {
   3.604765832080041*^9, 3.604765857809517*^9}, {3.604765896962761*^9, 
   3.604765924525335*^9}, {3.6152091584160957`*^9, 3.615209158525474*^9}, {
   3.6153202758675003`*^9, 3.61532031985194*^9}, {3.615320353586384*^9, 
   3.6153204819928875`*^9}, {3.6153205420711327`*^9, 
   3.6153205622274213`*^9}, {3.615320729993369*^9, 3.6153207365246334`*^9}, {
   3.615320779805983*^9, 3.6153208983687015`*^9}, 3.61532106904091*^9, {
   3.6153212830725794`*^9, 3.6153212925101123`*^9}, {3.615324220359584*^9, 
   3.615324226390836*^9}, {3.61532436015672*^9, 3.6153244223755894`*^9}, {
   3.615325064033101*^9, 3.615325065314352*^9}, 3.6153250962363*^9, 
   3.6153251294863505`*^9, {3.61532517923645*^9, 3.6153251871739635`*^9}, {
   3.615325646534237*^9, 3.615325647768614*^9}, {3.61532589636285*^9, 
   3.615325983878646*^9}, {3.6153261009257517`*^9, 3.615326208285336*^9}, {
   3.6153262609260645`*^9, 3.6153262745979853`*^9}, {3.615335596985379*^9, 
   3.6153356017041345`*^9}, 3.6153357711419706`*^9, {3.6153358232514453`*^9, 
   3.615335860517146*^9}, {3.6153383043156395`*^9, 3.615338312925033*^9}, {
   3.615338451347184*^9, 3.61533845439406*^9}, {3.6153387528477726`*^9, 
   3.615338792988473*^9}, {3.6153979602918663`*^9, 3.6153979757606454`*^9}, {
   3.615398041854525*^9, 3.6153980452139053`*^9}, {3.615398325917579*^9, 
   3.6153983349175987`*^9}, {3.615398682423188*^9, 3.6153986874164925`*^9}, {
   3.6207494991324806`*^9, 3.6207495001168585`*^9}, 3.62074954214821*^9, {
   3.6207538609661646`*^9, 3.620753931294428*^9}, 3.620753988372662*^9, {
   3.6219538879565887`*^9, 3.6219539010034914`*^9}, {3.6219539495973387`*^9, 
   3.6219539521129675`*^9}, {3.6219540877226086`*^9, 3.621954090003862*^9}, {
   3.6219541391133347`*^9, 3.6219541909884343`*^9}, {3.621954263347952*^9, 
   3.621954312910548*^9}, 3.6219543536918774`*^9, {3.621954397895089*^9, 
   3.6219544030669737`*^9}, {3.621954503567171*^9, 3.621954504348422*^9}, {
   3.621954576223563*^9, 3.6219546021611137`*^9}, {3.6219547000363045`*^9, 
   3.6219547417707615`*^9}, {3.6219570161502094`*^9, 3.621957085900346*^9}, {
   3.6223300202460327`*^9, 3.622330055151032*^9}, {3.6223305579718285`*^9, 
   3.6223306624678154`*^9}, {3.6223307040471973`*^9, 3.622330721663204*^9}, {
   3.622330756060192*^9, 3.6223307622445283`*^9}, {3.6223308394999533`*^9, 
   3.622330922336692*^9}, {3.6223310390523806`*^9, 3.62233104277159*^9}, 
   3.6223311280424724`*^9, {3.6282084439642305`*^9, 3.6282084723447266`*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Tensor derivatives", "Section",
 CellChangeTimes->{{3.5933110701810026`*^9, 3.593311074368497*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"tensprod", "[", 
     RowBox[{"a_", ",", " ", "b_"}], "]"}], " ", ":=", " ", 
    RowBox[{"Outer", "[", 
     RowBox[{"Times", ",", " ", "a", ",", " ", "b"}], "]"}]}], ";"}], " ", 
  RowBox[{"(*", " ", 
   RowBox[{"compilable", ",", " ", 
    RowBox[{
     RowBox[{"unlike", " ", "the", " ", "built"}], "-", 
     RowBox[{"in", " ", "fcn", " ", "TensorProduct"}]}]}], " ", "*)"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
   "commonly", " ", "used", " ", "matrix", " ", "derivatives", " ", "of", " ",
     "D", 
    RowBox[{"(", 
     RowBox[{"A", ".", "X", ".", "B"}], ")"}], " ", "and", " ", "D", 
    RowBox[{"(", 
     RowBox[{"Y", "[", "X", "]"}], ")"}]}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
   "note", " ", "that", " ", "by", " ", "default", " ", "transpose", " ", 
    "on", " ", "a", " ", "tensor", " ", "swaps", " ", "only", " ", "the", " ",
     "first", " ", "two", " ", "indices"}], " ", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"dXB", "[", 
    RowBox[{"dX_", ",", " ", "B_"}], "]"}], " ", ":=", " ", 
   RowBox[{
    RowBox[{"(", 
     RowBox[{
      RowBox[{"B", "\[Transpose]"}], ".", 
      RowBox[{"dX", "\[Transpose]"}]}], ")"}], "\[Transpose]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"AdX", "[", 
    RowBox[{"A_", ",", " ", "dX_"}], "]"}], " ", ":=", " ", 
   RowBox[{"A", ".", "dX"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"AdXB", "[", 
     RowBox[{"A_", ",", " ", "dX_", ",", " ", "B_"}], "]"}], " ", ":=", " ", 
    RowBox[{"AdX", "[", 
     RowBox[{"A", ",", " ", 
      RowBox[{"dXB", "[", 
       RowBox[{"dX", ",", " ", "B"}], "]"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
   "lists", " ", "need", " ", "to", " ", "be", " ", "handled", " ", 
    "differently"}], " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"dXb", "[", 
    RowBox[{"dX_", ",", " ", "b_"}], "]"}], " ", ":=", " ", 
   RowBox[{"(", 
    RowBox[{"b", ".", 
     RowBox[{"dX", "\[Transpose]"}]}], ")"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"AdXb", "[", 
     RowBox[{"A_", ",", " ", "dX_", ",", " ", "b_"}], "]"}], " ", ":=", " ", 
    RowBox[{"AdX", "[", 
     RowBox[{"A", ",", " ", 
      RowBox[{"dXb", "[", 
       RowBox[{"dX", ",", " ", "b"}], "]"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"assumes", " ", "dY", " ", "is", " ", "T", 
    RowBox[{"(", 
     RowBox[{"2", ",", "2"}], ")"}], " ", "and", " ", "dX", " ", "T", 
    RowBox[{"(", 
     RowBox[{"2", ",", "1"}], ")"}]}], " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"dYdX", "[", 
    RowBox[{"dY_", ",", " ", "dX_"}], "]"}], " ", ":=", " ", 
   RowBox[{"TensorContract", "[", 
    RowBox[{
     RowBox[{"dY", ".", 
      RowBox[{"dX", "\[Transpose]"}]}], ",", " ", 
     RowBox[{"{", 
      RowBox[{"3", ",", " ", "4"}], "}"}]}], "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.593310679887574*^9, 3.5933107070126123`*^9}, {
  3.59331075457522*^9, 3.5933107772158737`*^9}, {3.593311079306023*^9, 
  3.5933110801341343`*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Animation", "Section",
 CellChangeTimes->{{3.5914870039053636`*^9, 3.591487004222381*^9}, {
  3.5916678891560974`*^9, 3.5916678898031635`*^9}, {3.5922559886651573`*^9, 
  3.592256014246619*^9}, {3.5962915648964467`*^9, 3.596291566021453*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"GetPointsAndLines", "[", 
     RowBox[{"q_", ",", " ", "poi_"}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"p", ",", " ", "pts", ",", " ", "rots", ",", " ", "lines"}], 
       "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"pts", ",", " ", "rots"}], "}"}], " ", "=", " ", 
        RowBox[{"GetPoints", "[", "q", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"lines", " ", "=", " ", 
        RowBox[{
         RowBox[{
          RowBox[{
          "pts", "\[LeftDoubleBracket]", "#", "\[RightDoubleBracket]"}], 
          "&"}], " ", "/@", " ", 
         RowBox[{"Select", "[", 
          RowBox[{"poi", ",", " ", 
           RowBox[{
            RowBox[{"IntegerQ", "[", 
             RowBox[{
             "#", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], 
             "]"}], "&"}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"p", " ", "=", " ", 
        RowBox[{"Select", "[", 
         RowBox[{"poi", ",", " ", 
          RowBox[{
           RowBox[{"VectorQ", "[", 
            RowBox[{
            "#", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], 
            "]"}], "&"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"pts", " ", "=", " ", 
        RowBox[{"Join", "[", 
         RowBox[{"pts", ",", " ", 
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"rots", "\[LeftDoubleBracket]", 
                 RowBox[{
                 "#", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
                 "\[RightDoubleBracket]"}], "\[Transpose]"}], ".", 
               RowBox[{
               "#", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}]}], 
              " ", "+", " ", 
              RowBox[{"pts", "\[LeftDoubleBracket]", 
               RowBox[{
               "#", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
               "\[RightDoubleBracket]"}]}], ")"}], "&"}], " ", "/@", " ", 
           "p"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"p", " ", "=", " ", 
        RowBox[{"Join", "[", 
         RowBox[{"parent0", ",", " ", 
          RowBox[{"p", "\[LeftDoubleBracket]", 
           RowBox[{"All", ",", " ", "1"}], "\[RightDoubleBracket]"}]}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"lines", " ", "=", " ", 
        RowBox[{"Join", "[", 
         RowBox[{"lines", ",", " ", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{
               "p", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
               " ", "\[NotEqual]", " ", "0"}], ",", " ", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"pts", "\[LeftDoubleBracket]", 
                 RowBox[{
                 "p", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
                 "\[RightDoubleBracket]"}], ",", " ", 
                RowBox[{
                "pts", "\[LeftDoubleBracket]", "i", 
                 "\[RightDoubleBracket]"}]}], "}"}]}], "]"}], ",", " ", 
            RowBox[{"{", 
             RowBox[{"i", ",", " ", 
              RowBox[{"Length", "@", "p"}]}], "}"}]}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"lines", " ", "=", " ", 
        RowBox[{"Select", "[", 
         RowBox[{"lines", ",", " ", 
          RowBox[{
           RowBox[{"!", 
            RowBox[{"(", 
             RowBox[{"#", "===", " ", "Null"}], ")"}]}], "&"}]}], "]"}]}], 
       ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"pts", ",", " ", "lines"}], "}"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "DrawFigure2D", "]"}], " ", "=", " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"VertexColors", "\[Rule]", " ", "Black"}], ",", " ", 
      RowBox[{"PlotRange", "\[Rule]", " ", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"-", "1"}], ",", " ", "1"}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"-", "1"}], ",", "1"}], "}"}]}], "}"}]}], ",", " ", 
      RowBox[{"Axes", "\[Rule]", " ", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"3", ",", "2"}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"1", ",", "2"}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"3", ",", "1"}], "}"}]}], "}"}]}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"DrawFigure2D", "[", 
     RowBox[{"q_", ",", " ", "poi_", ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "pts", ",", " ", "lines", ",", " ", "g1", ",", " ", "g2", ",", "g3", 
        ",", " ", "vc", ",", " ", "pr", ",", " ", "ax"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"pts", ",", " ", "lines"}], "}"}], " ", "=", " ", 
        RowBox[{"GetPointsAndLines", "[", 
         RowBox[{"q", ",", " ", "poi"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"vc", " ", "=", " ", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", "VertexColors"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"pr", " ", "=", " ", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", "PlotRange"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"ax", " ", "=", " ", 
        RowBox[{"OptionValue", "[", "Axes", "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"Graphics", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"Line", "@", 
              RowBox[{"lines", "\[LeftDoubleBracket]", 
               RowBox[{"All", ",", " ", "All", ",", " ", "a"}], 
               "\[RightDoubleBracket]"}]}], ",", " ", 
             RowBox[{"PointSize", "[", "Medium", "]"}], ",", " ", 
             RowBox[{"Point", "[", 
              RowBox[{
               RowBox[{"pts", "\[LeftDoubleBracket]", 
                RowBox[{"All", ",", " ", "a"}], "\[RightDoubleBracket]"}], 
               ",", " ", "vc"}], "]"}]}], "}"}], ",", " ", "pr"}], "]"}], ",",
          " ", 
         RowBox[{"{", 
          RowBox[{"a", ",", " ", "ax"}], "}"}]}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "DrawFigure3D", "]"}], " ", "=", " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"VertexColors", "\[Rule]", " ", "Black"}], ",", " ", 
      RowBox[{"PlotRange", "\[Rule]", " ", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"-", "1"}], ",", " ", "1"}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"-", "1"}], ",", "1"}], "}"}]}], "}"}]}], ",", " ", 
      RowBox[{"Axes", "\[Rule]", " ", 
       RowBox[{"{", 
        RowBox[{"3", ",", "1", ",", "2"}], "}"}]}], ",", " ", 
      RowBox[{"PointSize", "\[Rule]", " ", "0.025"}], ",", " ", 
      RowBox[{"Delete", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"DrawFigure3D", "[", 
    RowBox[{"q_", ",", " ", "poi_", ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "pts", ",", " ", "lines", ",", " ", "vc", ",", " ", "pr", ",", " ", 
       "ax", ",", " ", "ps", ",", " ", "del"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"{", 
        RowBox[{"pts", ",", " ", "lines"}], "}"}], " ", "=", " ", 
       RowBox[{"GetPointsAndLines", "[", 
        RowBox[{"q", ",", " ", "poi"}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"vc", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "VertexColors", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{"VectorQ", "[", "vc", "]"}]}], ",", " ", 
        RowBox[{"vc", " ", "=", " ", 
         RowBox[{"ConstantArray", "[", 
          RowBox[{"vc", ",", " ", 
           RowBox[{"Length", "@", "pts"}]}], "]"}]}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"pr", " ", "=", " ", 
       RowBox[{"FilterRules", "[", 
        RowBox[{
         RowBox[{"{", "opts", "}"}], ",", "PlotRange"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"ax", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "Axes", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"ps", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "PointSize", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"del", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "Delete", "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"Graphics3D", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"Tube", "/@", 
           RowBox[{"lines", "\[LeftDoubleBracket]", 
            RowBox[{"All", ",", " ", "All", ",", " ", "ax"}], 
            "\[RightDoubleBracket]"}]}], ",", " ", 
          RowBox[{
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
              "vc", "\[LeftDoubleBracket]", "#", "\[RightDoubleBracket]"}], 
              ",", 
              RowBox[{"Sphere", "[", 
               RowBox[{
                RowBox[{"pts", "\[LeftDoubleBracket]", 
                 RowBox[{"#", ",", " ", "ax"}], "\[RightDoubleBracket]"}], 
                ",", " ", "ps"}], "]"}]}], "}"}], "&"}], " ", "/@", " ", 
           RowBox[{"Delete", "[", 
            RowBox[{
             RowBox[{"Range", "[", 
              RowBox[{"Length", "@", "pts"}], "]"}], ",", " ", "del"}], 
            "]"}]}]}], "}"}], ",", " ", "pr"}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.5962916807404227`*^9, 3.5962916818654265`*^9}, {
   3.5962917375842896`*^9, 3.5962918128813086`*^9}, {3.596295724423031*^9, 
   3.596295766516862*^9}, {3.5962958019700766`*^9, 3.5962958130482035`*^9}, {
   3.5962959266109467`*^9, 3.5962960939862523`*^9}, {3.596296145470729*^9, 
   3.596296228033392*^9}, {3.5962965011745462`*^9, 3.596296513627701*^9}, {
   3.596296598252864*^9, 3.596296606034129*^9}, {3.596297960880542*^9, 
   3.596297991427469*^9}, {3.596298040818184*^9, 3.5962980507869554`*^9}, {
   3.596298092208911*^9, 3.5962981215370965`*^9}, {3.596298154380923*^9, 
   3.596298241209201*^9}, {3.596298290428048*^9, 3.5962983837563553`*^9}, {
   3.596298437709608*^9, 3.596298451568988*^9}, 3.596298543256668*^9, {
   3.596298911398012*^9, 3.5962989188355403`*^9}, 3.5962989799606466`*^9, {
   3.5962995864561777`*^9, 3.59629967261259*^9}, {3.596299705581409*^9, 
   3.596299709315792*^9}, {3.596299848159814*^9, 3.596299930753737*^9}, {
   3.5963000186132727`*^9, 3.596300028941414*^9}, {3.596300073394643*^9, 
   3.5963001327385063`*^9}, {3.5963001911448603`*^9, 
   3.5963001938480067`*^9}, {3.5963004449266167`*^9, 
   3.5963004514266186`*^9}, {3.596300577286256*^9, 3.596300589286262*^9}, {
   3.596300644536368*^9, 3.596300657895774*^9}, {3.5963007849741564`*^9, 
   3.5963008053179398`*^9}, 3.596300866896185*^9, {3.5963009290681763`*^9, 
   3.596300955865119*^9}, {3.5963010248027415`*^9, 3.5963010307090015`*^9}, {
   3.5963010718028307`*^9, 3.596301076177842*^9}, {3.5963011608811483`*^9, 
   3.5963011626467795`*^9}, {3.5963012158031263`*^9, 
   3.5963012345375233`*^9}, {3.5963017959761443`*^9, 
   3.5963017982417574`*^9}, {3.596393528851539*^9, 3.596393531843712*^9}, {
   3.5963936533186636`*^9, 3.5963936540987115`*^9}, {3.5963939086362877`*^9, 
   3.5963939451223774`*^9}, {3.5963944199685698`*^9, 3.596394421008649*^9}, {
   3.5963944733046246`*^9, 3.5963946486466675`*^9}, {3.5963948735435452`*^9, 
   3.596394880845963*^9}, {3.59639497014408*^9, 3.5963950704478226`*^9}, {
   3.596395107179925*^9, 3.596395210457838*^9}, {3.5963955485272007`*^9, 
   3.5963955588727913`*^9}, {3.596395987850362*^9, 3.5963959952887983`*^9}, {
   3.602208153525608*^9, 3.602208158650631*^9}, 3.6032978051945467`*^9, {
   3.6036719739146385`*^9, 3.603671984936268*^9}, {3.6108808184281807`*^9, 
   3.610880852999172*^9}, {3.6108809188039274`*^9, 3.610880981678527*^9}, {
   3.614836571294561*^9, 3.6148365789351745`*^9}, {3.614836611919627*^9, 
   3.614836658982209*^9}, {3.614839821407442*^9, 3.614839871673174*^9}, {
   3.614839961630927*^9, 3.614840168771937*^9}, {3.616359461184723*^9, 
   3.616359461669097*^9}, {3.620995202790877*^9, 3.6209952108065176`*^9}, {
   3.620995270431636*^9, 3.6209952945410557`*^9}, {3.6219562041954956`*^9, 
   3.6219562146017666`*^9}, {3.621956354023915*^9, 3.621956371852075*^9}, {
   3.6271426996196556`*^9, 3.6271427446637144`*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["End Package", "Section"],

Cell[BoxData[{
 RowBox[{"End", "[", "]"}], "\[IndentingNewLine]", 
 RowBox[{"EndPackage", "[", "]"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.591486801989799*^9, 3.5914868026208353`*^9}}]
}, Open  ]]
},
AutoGeneratedPackage->Automatic,
WindowSize->{663, 669},
WindowMargins->{{Automatic, 0}, {Automatic, 0}},
FrontEndVersion->"10.0 for Microsoft Windows (64-bit) (December 4, 2014)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[557, 20, 2819, 56, 313, "Code",
 InitializationCell->True],
Cell[CellGroupData[{
Cell[3401, 80, 144, 2, 70, "Section"],
Cell[3548, 84, 471, 8, 49, "Text"]
}, Open  ]],
Cell[CellGroupData[{
Cell[4056, 97, 100, 1, 70, "Section"],
Cell[4159, 100, 1699, 24, 52, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[5895, 129, 206, 3, 70, "Section"],
Cell[6104, 134, 7755, 152, 332, "Input",
 InitializationCell->True],
Cell[13862, 288, 6938, 129, 212, "Input",
 InitializationCell->True],
Cell[20803, 419, 1263, 27, 52, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[22103, 451, 301, 4, 70, "Section"],
Cell[22407, 457, 11644, 231, 1132, "Input",
 InitializationCell->True],
Cell[34054, 690, 3973, 98, 292, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[38064, 793, 324, 4, 70, "Section"],
Cell[38391, 799, 2318, 65, 192, "Input",
 InitializationCell->True],
Cell[40712, 866, 8752, 158, 352, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[49501, 1029, 360, 5, 70, "Section"],
Cell[49864, 1036, 3331, 71, 332, "Input",
 InitializationCell->True],
Cell[53198, 1109, 1673, 43, 112, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[54908, 1157, 196, 3, 70, "Section"],
Cell[55107, 1162, 32026, 560, 1492, "Input",
 InitializationCell->True],
Cell[87136, 1724, 56743, 1006, 2532, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[143916, 2735, 256, 3, 70, "Section"],
Cell[144175, 2740, 75812, 1442, 5012, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[220024, 4187, 105, 1, 70, "Section"],
Cell[220132, 4190, 3373, 94, 332, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[223542, 4289, 248, 3, 70, "Section"],
Cell[223793, 4294, 13776, 320, 1012, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[237606, 4619, 30, 0, 70, "Section"],
Cell[237639, 4621, 207, 4, 52, "Input",
 InitializationCell->True]
}, Open  ]]
}
]
*)

(* End of internal cache information *)
